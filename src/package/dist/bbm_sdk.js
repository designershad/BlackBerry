/*!
 * Copyright (c) 2018 BlackBerry.  All Rights Reserved.
 * 
 * You must obtain a license from and pay any applicable license fees to
 * BlackBerry before you may reproduce, modify or distribute this software, or
 * any work that includes all or part of this software.
 * 
 * The BBM Enterprise SDK includes third party code.  For third party licenses
 * see: THIRDPARTY_LICENSES.txt.
 * 
 */
/*! v1.2.0-rc16 */
module.exports=function(e){var t={};function r(s){if(t[s])return t[s].exports;var a=t[s]={i:s,l:!1,exports:{}};return e[s].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:s})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=54)}([function(e,t,r){"use strict";function s(e){this.name="BBMEnterprise.Error.Error",this.message=e||"An error has occurred",this.stack=(new Error).stack}function a(e){this.name="BBMEnterprise.Error.NotFoundError",this.message=e||"The requested data was not found",this.stack=(new Error).stack}function n(e){this.name="BBMEnterprise.Error.DuplicateError",this.message=e||"Duplicate error",this.stack=(new Error).stack}function o(e){this.name="BBMEnterprise.Error.PermanentFailure",this.message="PermanentFailure. The request must not be retried"+(e?": "+e:""),this.stack=(new Error).stack}function i(e){this.name="BBMEnterprise.Error.TemporaryFailure",this.message="TemporaryFailure. The request may be retried later"+(e?": "+e:""),this.stack=(new Error).stack}function d(e){this.name="BBMEnterprise.Error.Forbidden",this.message="Forbidden. The request must not be retried"+(e?": "+e:""),this.stack=(new Error).stack}function c(e){this.name="BBMEnterprise.Error.NotFound",this.message="NotFound. The request must not be retried"+(e?": "+e:""),this.stack=(new Error).stack}function l(e){this.name="BBMEnterprise.Error.BrowserNotSupportedError",this.message=e||"The browser is not supported",this.stack=(new Error).stack}function u(e){this.name="BBMEnterprise.AssertionError",this.message="AssertionError: "+e,this.stack=(new Error).stack}function p(e){this.name="BBMEnterprise.Error.InvalidEncodingError",this.message=e,this.stack=(new Error).stack}function f(e){this.name="BBMEnterprise.Error.ProtectionError",this.message="ProtectionError: "+e,this.stack=(new Error).stack}Object.defineProperty(t,"__esModule",{value:!0}),r.d(t,"Error",function(){return s}),t.NotFoundError=a,t.DuplicateError=n,t.PermanentFailure=o,t.TemporaryFailure=i,t.Forbidden=d,t.NotFound=c,t.BrowserNotSupportedError=l,t.AssertionError=u,t.InvalidEncodingError=p,t.ProtectionError=f,s.prototype=Object.create(Error.prototype),s.prototype.constructor=s,a.prototype=Object.create(s.prototype),a.prototype.constructor=a,n.prototype=Object.create(s.prototype),n.prototype.constructor=n,o.prototype=Object.create(s.prototype),o.prototype.constructor=o,i.prototype=Object.create(s.prototype),i.prototype.constructor=i,d.prototype=Object.create(o.prototype),d.prototype.constructor=d,c.prototype=Object.create(o.prototype),c.prototype.constructor=c,l.prototype=Object.create(s.prototype),l.prototype.constructor=l,u.prototype=Object.create(s.prototype),u.prototype.constructor=u,p.prototype=Object.create(Error.prototype),p.prototype.constructor=p,f.prototype=Object.create(s.prototype),f.prototype.constructor=f},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=o;var s=r(3),a=(r(0),r(8)),n=r.n(a);function o(e,...t){Object(s.default)(Number.isInteger(e)&&e>=0,"Log level={0} must be an integer >= 0",e),e>o.logThreshold||("web"===n.a&&(t=Array.from(t,function(e){return void 0===e||"number"==typeof e?e:e.toString()})),t[0]=(new Date).toISOString()+" ["+e+"]: "+t[0],e<=o.CRITICAL?console.trace(...t):e!==o.ERROR?e!==o.WARNING?e!==o.NOTICE?console.log(...t):console.info(...t):console.warn(...t):console.error(...t))}Object.defineProperty(o,"TRACE",{value:0}),Object.defineProperty(o,"CRITICAL",{value:1}),Object.defineProperty(o,"ERROR",{value:2}),Object.defineProperty(o,"WARNING",{value:3}),Object.defineProperty(o,"NOTICE",{value:4}),Object.defineProperty(o,"INFO",{value:5}),Object.defineProperty(o,"DEBUG1",{value:6}),Object.defineProperty(o,"DEBUG2",{value:7}),o.logThreshold=o.INFO,o.logErrorForDebugging=function(e){void 0},o.debug=function(...e){void 0}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.base64urlEncode=function(e){return o(n.a.base64String(e))},t.base64urlDecode=function(e){return n.a.unbase64String(i(e))},t.array2b=function(e){return o(n.a.base64Uint8Array(e))},t.b2array=function(e){return n.a.unbase64Array(i(e))},t.array2hex=function(e){if(!(e instanceof Uint8Array))throw new s.Error("array2hex argument must be a Uint8Array");let t="";for(const r of e)r<16&&(t+="0"),t+=r.toString(16);return t},t.hex2array=function(e){if("string"!=typeof e||!d.test(e))throw new s.Error("hex2array invalid argument");const t=new Uint8Array(e.length/2);for(let r=0;r<t.length;++r)t[r]=parseInt(e.substr(2*r,2),16);return t},t.truncate=function(e,t){if("string"!=typeof e)return e;if(e.length<=t)return e;for(var r=0,s=0;s<t&&r<e.length;++s){var a=e.charCodeAt(r);55296<=a&&a<=57343&&++r,++r}return e.substr(0,Math.min(r,e.length))},t.appendToArray=function(e,t){if(t.length<=32768)return void Array.prototype.push.apply(e,t);for(var r=0,s=t.length;r<s;r+=32768)Array.prototype.push.apply(e,t.slice(r,Math.min(r+32768,s)))},t.spliceArray=function(e,t,r,s,a,n){for(var o=0,i=a;i<n;i+=10240){var d=t+o,c=Math.min(i+10240,n),l=[d,r];Array.prototype.push.apply(l,s.slice(i,c)),e.splice.apply(e,l),o+=c-i}return o};var s=r(0),a=r(20),n=r.n(a);function o(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function i(e){return e.replace(/-/g,"+").replace(/_/g,"/")}const d=/^(?:[0-9a-f][0-9a-f])*$/i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,...r){};r(0)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.generateSigningKeyPair=function(){return c.generateEcKey(!0,["sign","verify"],!0).then(I)},t.generateEncryptionKeyPair=function(){return c.generateEcKey(!0,["deriveBits"],!1).then(I)},t.generateBytes=function(e){const t=c.getRandomValues(new Uint8Array(e));return n.default.debug(n.default.DEBUG2,"%s: generatedBytes: %s",l,a.array2hex(t)),t},t.generateSharedSecret=function(e,t){return c.deriveBits(e,t,528)},t.generateChatKey=function(){return c.generateAesKey("AES-CTR",!0,["encrypt","decrypt"]).then(c.exportAesKey).then(e=>(n.default.debug(n.default.DEBUG2,"%s: generateChatKey: %s",l,a.array2hex(e)),e))},t.userPrefix=function(e,t,r,s){let o=new Uint8Array(21+r.length+4+1);o.set([1,1,0,1]);let i=0;return o.set(E(e),i+=4),o.set(E(t),i+=8),o[i+=8]=0,o.set(r,i+=1),new DataView(o.buffer).setInt32(i+=r.length,s),o[i+=4]=3,n.default.debug(n.default.DEBUG2,"%s: userPrefix(%s, %s, %s, %s): %s",l,e,t,a.array2hex(r),s,a.array2hex(o)),o},t.chatPrefix=function(e,t,r,s){let o=new Uint8Array(21+t.length+r.length+4+1);o.set([1,1,0,1]);let i=0;return o.set(E(e),i+=4),o[i+=16]=t.length,o.set(t,i+=1),o.set(r,i+=t.length),new DataView(o.buffer).setInt32(i+=r.length,s),o[i+=4]=3,n.default.debug(n.default.DEBUG2,"%s: chatPrefix(%s, %s, %s, %s): %s",l,e,a.array2hex(t),a.array2hex(r),s,a.array2hex(o)),o},t.metadataPrefix=f,t.importPrivateSigningKey=function(e,t){return g(e,t,"ECDSA",["sign"])},t.importPrivateEncryptionKey=function(e,t){return g(e,t,"ECDH",["deriveBits"])},t.importPublicSigningKey=function(e){return h(e,"ECDSA",["verify"])},t.importPublicEncryptionKey=function(e){return h(e,"ECDH",[])},t.sign=function(e,t,r){return c.sign(r,v(e,t))},t.verify=function(e,t,r,s){return c.verify(s,e,v(t,r))},t.encrypt=y,t.encryptFile=function(e){return c.generateAesKey("AES-CTR",!0,["encrypt","decrypt"]).then(t=>c.encrypt(new Uint8Array(16),t,e).then(e=>c.digest(c.DigestAlgorithm.SHA512,e).then(r=>c.exportAesKey(t).then(t=>({key:t,hash:new Uint8Array(r),data:new Uint8Array(e)})))))},t.decryptFile=function(e,t,r){return c.digest(c.DigestAlgorithm.SHA512,e).then(e=>{const t=new Uint8Array(e);if(r.length!==t.length)throw new s.Error("Cannot decrypt file, hash mismatch: Expected "+a.array2hex(r)+" but found "+a.array2hex(t));for(let e=0,n=r.length;e<n;e++)if(r[e]!==t[e])throw new s.Error("Cannot decrypt file, hash mismatch: Expected "+a.array2hex(r)+" but found "+a.array2hex(t))}).then(function(){return c.importAesKey(t,"AES-CTR",!1,["encrypt","decrypt"]).then(t=>c.decrypt(new Uint8Array(16),t,e))})},t.decrypt=m,t.decryptMetadata=b,t.decodeAndDecryptMetadata=function(e,t){return b(a.b2array(e),t).then(function(e){return o.decode(e)})},t.generateAuthCode=function(e){const t=c.getRandomValues(new Uint8Array(32));return Promise.all([c.digest(c.DigestAlgorithm.SHA512,t),y(t,f(),new Uint8Array([]),u,e)]).then(e=>({encryptedCode:e[1],hash:new Uint8Array(e[0])}))},t.verifyAuthCode=function(e,t,r){return b(e,r).then(e=>c.digest(c.DigestAlgorithm.SHA512,e.buffer)).then(e=>{const r=new Uint8Array(e);if(r.byteLength!==t.byteLength)return!1;for(let e=0;e<r.byteLength;++e)if(r[e]!==t[e])return!1;return!0})},t.getIdpUserIdHash=function(e){return c.digest(c.DigestAlgorithm.SHA256,o.encode(e)).then(function(e){return a.array2b(new Uint8Array(e))})},t.generateManagementKey=function(){return c.generateAesKey("AES-GCM",!0,["encrypt","decrypt"])},t.encryptMgmtKey=function(e,t,r,s,a,n,o){return F(r,s,a,n,o).then(r=>c.exportAesKey(e).then(e=>x(new Uint8Array(e),t,r)))},t.decryptMgmtKey=function(e,t,r,s,a,n,o){return F(r,s,a,n,o).then(r=>S(e,t,r)).then(e=>c.importAesKey(e,"AES-GCM",!0,["encrypt","decrypt"]))},t.authEncrypt=x,t.authDecrypt=S,t.deriveKeyArgon2=F;var s=r(0),a=r(2),n=r(1),o=r(9),i=r(33),d=r(56),c=(r.n(d),r(22));r.n(c);const l="Protect";t.encryptDiversifier=[77,101,115,115,97,103,101,32,69,110,99,114,121,112,116,105,111,110];const u=[77,101,116,97,100,97,116,97,32,69,110,99,114,121,112,116,105,111,110];t.metadataDiversifier=u;const p="BBME SDK KMS DRK";function f(){let e=new Uint8Array(18);return e.set([1,1,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,2]),n.default.debug(n.default.DEBUG2,"%s: metadataPrefix(): %s",l,a.array2hex(e)),e}function g(e,t,r,s){return c.importPrivateEcKey(e,t,!1,s,r)}function h(e,t,r){return c.importPublicEcKey(e,!1,r,t)}function y(e,t,r,s,a){return w(t,a,s).then(t=>c.encrypt(O(r),t,e))}function m(e,t,r,s,a){return w(t,a,s).then(t=>c.decrypt(O(r),t,e))}function b(e,t){return m(e,f(),new Uint8Array([]),u,t)}function I(e){return Promise.all([c.exportEcPublicKey(e.publicKey),c.exportEcPrivateKey(e.privateKey)]).then(e=>({publicKey:e[0],privateKey:e[1]}))}function v(e,t){const r=new Uint8Array(e.length+4+t.length);return r.set(e),new DataView(r.buffer).setInt32(e.length,t.length),r.set(t,e.length+4),r}t.managementDiversifier=p;let M=0;function w(e,t,r){const s=++M,o=new Uint8Array(e.length+t.length+4+r.length);return o.set(e),o.set(t,e.length),o.set([0,0,0,1],e.length+t.length),o.set(r,e.length+t.length+4),n.default.debug(n.default.DEBUG2,"%s: deriveKey() %d data: %s",l,s,a.array2hex(o)),c.digest(c.DigestAlgorithm.SHA512,o).then(e=>(n.default.debug(n.default.DEBUG2,"%s: deriveKey() %d hash: %s",l,s,a.array2hex(new Uint8Array(e))),c.importAesKey(e.slice(0,32),"AES-CTR",!1,["encrypt","decrypt"])))}function O(e){let t=new Uint8Array(16);return t.set(e.slice(0,16)),t}function R(e,t){let r=[];const s=Math.max(e.length,t.length);let a=0,n=0;for(;n<s||a;){let s=0;n<e.length&&0!=e.length&&(s=e[n]);let o=0;n<t.length&&0!=t.length&&(o=t[n]);const i=a+s+o;r.push(i%16),a=Math.floor(i/16),n++}return r}function P(e,t){let r=[];for(let s=0;s<t;s++)r=R(r,e);return r}function E(e){if(e.length<=11){const t=parseInt(e);if(t<=i.a.max&&t>=i.a.min){let e=new Uint8Array(8);return new DataView(e.buffer).setInt32(4,t),t<0&&e.set([255,255,255,255]),e}}let t=[],r=[1],s=!1;for(let a=e.length-1;a>=0;a--){const n=parseInt(e.charAt(a));if(isNaN(n)){"-"==e[a]&&0==a&&(s=!0);break}n&&(t=R(t,P(r,n))),r=P(r,10)}for(let e=16-t.length;e>0;e--)t.push(0);if(s){for(let e=0;e<t.length;e++)t[e]=15-t[e];t=R(t,[1])}let a=new Uint8Array(8);for(let e=t.length-1,r=0;e>=0;e-=2,r++)a[r]=t[e]<<4|t[e-1];return a}function x(e,t,r){return c.authEncrypt(e,t,r)}function S(e,t,r){return c.authDecrypt(e,t,r)}function F(e,t,r,s,a){return d.argon2kdf(e,o.encode(t),o.encode(p+r+s),a).then(e=>c.importAesKey(e,"AES-GCM",!0,["encrypt","decrypt"]))}},function(e,t,r){"use strict";var s=r(43),a=r(2);class n extends s.a{constructor(e){super(e)}static fromString(e){return new n(Object(a.hex2array)(e))}compare(e){for(var t=Math.min(this.binary.length,e.binary.length),r=0;r<t;++r){if(this.binary[r]<e.binary[r])return-1;if(this.binary[r]>e.binary[r])return 1}return this.binary.length>t?1:e.binary.length>t?-1:0}isEmpty(){return 0===this.binary.length}isLessThan(e){return this.compare(e)<0}isGreaterThan(e){return e.isLessThan(this)}isLessThanOrEqual(e){return!this.isGreaterThan(e)}isGreaterThanOrEqual(e){return!this.isLessThan(e)}isEqual(e){return 0===this.compare(e)}}t.a=n},function(e,t,r){"use strict";t.b=c,t.a=l,t.d=f,t.c=function(e){let t;try{let r;switch((t=new function(e){Object(s.default)(e instanceof Uint8Array,"array must be a byte array");let t=this,r=0,n=e.length;function o(e){return 32==e||e>=9&&e<=13}this.get=function(){return e[r]},this.require=function(s){if(e[r]!=s)throw new l("expected '"+String.fromCharCode(s)+"'",t);return this},this.consume=function(){if(r==n)throw new l("premature end of input",t);return++r,t},this.throwIfNotEnd=function(){if(r!=n)throw new l("trailing non-whitespace",t)},this.skipWhitespace=function(){for(;r!=n&&o(e[r]);)++r;return this},this.extractString=function(){return a.decode(t.extractBinary())},this.extractBinary=function(){++r;let t=e.subarray(r);function s(e){let t=e.indexOf(92);if(t>=0){let r=e.subarray(0,t).indexOf(34);return r>=0?r:t}return e.indexOf(34)}let n=s(t);if(-1==n)throw new l("unterminated quoted string",this);if(34==t[n])return r+=n+1,t.subarray(0,n);let o=t.subarray(),i=n;for(t=t.subarray(n),r+=n;;){let e=t[1],d=2;switch(e){case 34:case 92:default:o[i++]=e;break;case 110:o[i++]=10;break;case 114:o[i++]=13;break;case 116:o[i++]=9;break;case 98:o[i++]=8;break;case 102:o[i++]=12;break;case 117:{if(d=6,92==t[6]&&117==t[7]){let e=32|t[3];100!=(32|t[2])||56!=e&&57!=e&&97!=e&&98!=e||(d=12)}let e=a.encode(JSON.parse('"'+a.decode(t.subarray(0,d))+'"'));o.set(e,i),i+=e.length;break}}if(t=t.subarray(d),r+=d,-1==(n=s(t)))throw new l("unterminated quoted string",this);if(34==t[n])return o.set(t.subarray(0,n),i),r+=n+1,o.subarray(0,i+n);0!=n&&(o.set(t.subarray(0,n),i),i+=n,t=t.subarray(n),r+=n)}},this.extractSimple=function(){let t=r;!function(){let t;for(;r!=n&&!o(t=e[r])&&34!=t&&123!=t&&125!=t&&91!=t&&93!=t&&44!=t&&58!=t;)++r}();let s=a.decode(e.subarray(t,r));try{return d.parse(s)}catch(e){throw new SyntaxError(e.message+" at pos="+e.at+" in text="+e.text)}},this.toString=function(){return"pos="+r}}(e)).skipWhitespace(),t.get()){case 91:r=p(t);break;case 123:r=u(t);break;case 34:r=t.extractBinary();break;default:r=t.extractSimple()}return t.skipWhitespace().throwIfNotEnd(),r}catch(e){if(e instanceof l)throw e;throw new l("parse error: "+e,t)}},t.e=function(e){function t(e){return'"'+e+'"'}return function e(r){if("object"!=typeof r||r instanceof i.a||null===r)return d.stringify(r);if(r instanceof Uint8Array){if(void 0!==r.find(e=>e<=31&&9!=e&&10!=e&&19!=e||127==e||e>=245||192==e||193==e))return"x"+t(n.array2hex(r));try{return t(a.decode(r))}catch(e){return"x"+t(n.array2hex(r))}}if(Array.isArray(r)){let t="[",s=!0;for(const a of r)s||(t+=","),t+=e(a),s=!1;return t+"]"}let s="{";let o=!0;for(const a in r)o||(s+=","),s+=t(a)+":"+e(r[a]),o=!1;return s+"}"}(e)};var s=r(3),a=r(9),n=r(2),o=r(14),i=r.n(o),d=r(15);r.n(d);function c(e){if(void 0===e)throw new TypeError("Missing mandatory data param");const t=f(e);Object.defineProperty(this,"data",{enumerable:!0,get:function(){return t}}),Object.defineProperty(this,"length",{enumerable:!0,get:function(){return this.data.length}})}function l(e,t){this.message="JSON8: "+e+" near "+t,this.stack=(new Error).stack}function u(e){e.require(123).consume().skipWhitespace();let t={};if(125==e.get())return e.consume(),t;for(;;){let r=e.require(34).extractString();switch(e.skipWhitespace().require(58).consume().skipWhitespace(),e.get()){case 123:t[r]=u(e);break;case 91:t[r]=p(e);break;case 34:t[r]=e.extractBinary();break;default:t[r]=e.extractSimple()}switch(e.skipWhitespace(),e.get()){case 44:e.consume();break;case 125:return e.consume(),t;default:throw new l("object expected ',' or '}'",e)}e.skipWhitespace()}}function p(e){e.require(91).consume().skipWhitespace();let t=[];if(93==e.get())return e.consume(),t;for(;;){switch(e.get()){case 123:t.push(u(e));break;case 91:t.push(p(e));break;case 34:t.push(e.extractBinary());break;default:t.push(e.extractSimple())}switch(e.skipWhitespace(),e.get()){case 44:e.consume();break;case 93:return e.consume(),t;default:throw new l("object expected ',' or ']'",e)}e.skipWhitespace()}}function f(e){return new Uint8Array(function e(t){switch(typeof t){case"number":case"boolean":case"string":return a.encode(JSON.stringify(t));case"object":if(t instanceof c)return t.data;if(t instanceof Uint8Array){let e=[34],r=0;for(let s=0;s<t.length;s++)34!=t[s]&&92!=t[s]||(n.appendToArray(e,Uint8Array.prototype.subarray.call(t,r,s)),e.push(92),e.push(t[s]),r=s+1);return n.appendToArray(e,Uint8Array.prototype.subarray.call(t,r)),e.push(34),e}if(Array.isArray(t)){let r=[91],s=!0;for(let a in t)s?s=!1:r.push(44),n.appendToArray(r,e(t[a]));return r.push(93),r}if(null===t)return[110,117,108,108];if(t instanceof i.a)return a.encode(d.stringify(t));{let r=[123],s=!0;for(let a in t)s?s=!1:r.push(44),n.appendToArray(r,e(a)),r.push(58),n.appendToArray(r,e(t[a]));return r.push(125),r}default:throw TypeError("Unexpected type: cannot encode "+typeof t+" as json")}}(e))}l.prototype=Object.create(Error.prototype)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegistrationChanged=n,t.ChatAdded=function(e){this.chat=e},t.ChatUpdated=function(e){this.chat=e},t.ChatRemoved=function(e){this.chat=e},t.ChatMessageListUpdated=function(e,t){this.chat=e,this.messages=t},t.ChatMessageAdded=function(e,t){this.chat=e,this.message=t},t.ChatMessageUpdated=function(e,t){this.chat=e,this.message=t},t.ChatTyping=function(e,t,r,s,a){this.chatId=e,this.participant=t,this.isTyping=r,this.tag=s,this.messageId="string"==typeof s?a:void 0},t.AppMessageReceived=function(e){Object(s.default)(e instanceof a.a),this.appMessage=e},t.SetupState=function(e){this.value=e},t.SetupError=o,t.UserKeysChanged=function(e){this.regId=e};var s=r(3),a=r(35);function n(e){void 0===e&&(e={reason:n.Failure.GeneralFailure}),this.state="Success",this.regId=e.regId,this.registrationToken=e.registrationToken,this.pin=e.pin,void 0===e.reason&&e.regId&&e.pin||(this.state="Failure",this.failureReason=n.Failure.hasOwnProperty(e.reason)?e.reason:n.Failure.GeneralFailure),Object.freeze(this)}function o(e){Object(s.default)(o.Value.hasOwnProperty(e)),this.value=e}n.Failure={GeneralFailure:"GeneralFailure",DeviceSwitchRequired:"DeviceSwitchRequired",RegistrationRevoked:"RegistrationRevoked",Forbidden:"Forbidden",FailedToImportProfileKeys:"FailedToImportProfileKeys",DomainConfigurationMismatch:"DomainConfigurationMismatch"},Object.freeze(n.Failure),n.prototype.toString=function(){return"RegistrationChanged: "+this.state+"; regId="+this.regId+" pin="+this.pin+("Failure"===this.state?"; reason="+this.failureReason:"")},o.Value={PermanentServerError:"PermanentServerError",Forbidden:"Forbidden",EndpointDeregistered:"EndpointDeregistered",DomainConfigurationMismatch:"DomainConfigurationMismatch"},Object.freeze(o.Value)},function(e,t,r){"use strict";e.exports="node"},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.encode=function(e){return a.encode(e)},t.decode=function(e){return n.decode(e)};var s=r(21),a=(r.n(s),new s.TextEncoder("utf-8")),n=new s.TextDecoder("utf-8",{fatal:!0})},function(e,t,r){"use strict";var s=r(0),a=r(6),n=r(1),o=r(2),i=r(14),d=r.n(i),c=r(15);r.n(c);const l="MailboxData";class u{constructor(e){class t extends s.PermanentFailure{constructor(t){super(`Invalid property=${t} in mailbox data: ${JSON.stringify(e)}`)}}let r;if("object"!=typeof e&&(r="argument")||("string"!=typeof e.id||0===e.id.length)&&(r="id")||"number"!=typeof e.createdTime&&(r="createdTime")||("string"!=typeof e.type||0===e.type.length)&&(r="type")||"boolean"!=typeof e.protected&&(r="protected")||!u.UpdatePolicy.hasOwnProperty(e.updatePolicy)&&(r="updatePolicy")||!u.InvitePolicy.hasOwnProperty(e.invitePolicy)&&(r="invitePolicy")||!Array.isArray(e.members)&&(r="members"))throw new t(r);if(Object.defineProperty(this,"id",{value:e.id,enumerable:!0}),Object.defineProperty(this,"createdTime",{value:e.createdTime,enumerable:!0}),Object.defineProperty(this,"type",{value:e.type,enumerable:!0}),Object.defineProperty(this,"protected",{value:e.protected,enumerable:!0}),Object.defineProperty(this,"updatePolicy",{value:e.updatePolicy,enumerable:!0}),Object.defineProperty(this,"invitePolicy",{value:e.invitePolicy,enumerable:!0}),Object.defineProperty(this,"members",{value:e.members.reduce((e,t)=>{try{e.push(new u.Member(t))}catch(e){Object(n.default)(n.default.ERROR,"%s: Ignoring member in m=%s; error=%s",l,this.id,e)}return e},[]),enumerable:!0}),void 0!==e.description){if("string"!=typeof e.description)throw new t("description");Object.defineProperty(this,"description",{value:e.description,enumerable:!0})}if(void 0!==e.subject){if("string"!=typeof e.subject)throw new t("subject");try{Object.defineProperty(this,"subject",{value:new u.AppData(JSON.parse(e.subject)),enumerable:!0})}catch(t){Object(n.default)(n.default.ERROR,"%s: Ignoring subject in m=%s; error=%s: %s",l,this.id,t,e.subject)}}else if(void 0!==e.name){if("string"!=typeof e.name)throw new t("name");Object.defineProperty(this,"name",{value:e.name,enumerable:!0})}if(void 0!==e.data){if("string"!=typeof e.data)throw new t("data");try{Object.defineProperty(this,"data",{value:new u.AppData(JSON.parse(e.data)),enumerable:!0})}catch(t){Object(n.default)(n.default.ERROR,"%s: Ignoring data in m=%s; error=%s: %s",l,this.id,t,e.data)}}if(void 0!==e.protectedKey){if("string"!=typeof e.protectedKey)throw new t("protectedKey");try{const t=o.b2array(e.protectedKey);if(0===t.length||123!==t[0])throw new Error("Value must be an object");Object.defineProperty(this,"protectedKey",{value:a.c(t),enumerable:!0})}catch(t){Object(n.default)(n.default.ERROR,"%s: Ignoring protectedKey in m=%s; error=%s: %s",l,this.id,t,e.protectedKey)}}}}t.a=u,u.UpdatePolicy={AdminOnly:"AdminOnly",MembersOnly:"MembersOnly",Anyone:"Anyone"},Object.freeze(u.UpdatePolicy),u.InvitePolicy={AdminOnly:"AdminOnly",MembersOnly:"MembersOnly",Anyone:"Anyone"},Object.freeze(u.InvitePolicy),u.Description={OneToOne:"OneToOne",Conference:"Conference"},Object.freeze(u.Description),u.Member=class{constructor(e){let t;if("object"!=typeof e&&(t="argument")||"number"!=typeof e.regId&&!(e.regId instanceof d.a)&&(t="regId")||("string"!=typeof e.pin||0===e.pin.length)&&(t="pin")||"boolean"!=typeof e.admin&&(t="admin"))throw new Error(`Invalid ${t} in member data: ${c.stringify(e)}`);Object.defineProperty(this,"regId",{value:e.regId.toString(),enumerable:!0}),Object.defineProperty(this,"pin",{value:e.pin,enumerable:!0}),Object.defineProperty(this,"admin",{value:e.admin,enumerable:!0})}toString(){return JSON.stringify(this)}},u.AppData=class{constructor(e){let t;if("object"!=typeof e&&(t="argument")||("string"!=typeof e.regId||0===e.regId.length)&&(t="regId")||("string"!=typeof e.data||0===e.data.length)&&(t="data"))throw new Error(`Invalid ${t} in application data`);Object.defineProperty(this,"regId",{value:e.regId,enumerable:!0}),Object.defineProperty(this,"data",{value:e.data,enumerable:!0})}toString(){return JSON.stringify(this)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=O;var s=r(0),a=r(63),n=r(4),o=r(1),i=r(16),d=r.n(i),c=r(24),l=r.n(c),u=r(36),p=r.n(u),f=r(37),g=r.n(f),h=r(25),y=r.n(h),m=r(14),b=r.n(m),I=r(15);r.n(I);var v={GET:"GET",POST:"POST",PUT:"PUT",DELETE:"DELETE"};Object.freeze(v),O.Method=v;var M={Mailbox:"Mailbox",Profile:"Profile",Kms:"Kms"};function w(e,t,r){this.method=e,this.server=t,this.timeout=r,Object.freeze(this)}function O(e,t,r,n,o,i,d,c,l,u){if(this.options={profileAddress:e,mailboxAddress:t,kmsAddress:r,profilePort:n,mailboxPort:o,kmsPort:i,timeout:Number.isInteger(u)?u:3e4},Object.freeze(this.options),this.cnonceFunction=P,"string"!=typeof d||0===d.length)throw new s.Error("domain must be a non-empty string");this.domain=d,this.bbmToken=new a.a(()=>this.refreshBbmToken(c,l))}function R(e,t,r){return e.request(t,e.requestOptions(v.POST,M.Profile),r).then(e=>{const t=[],r=t=>{throw new s.PermanentFailure("Invalid response entity resolving identities; "+`${t}; entity=${JSON.stringify(e)}`)};e.hasOwnProperty("ids")||r("missing ids field"),e.ids instanceof Array||r("ids field not an array");for(const s of e.ids)s.hasOwnProperty("userId")||r("missing userId field"),s.hasOwnProperty("regId")||r("missing regId field"),t.push({appUserId:s.userId,regId:s.regId.toString()});return t})}function P(){for(var e="abcdef0123456789",t="",r=0;r<16;++r){var s=Math.round(Math.random()*e.length);t+=e.substr(s,1)}return t}Object.freeze(M),O.Server=M,w.prototype=Object.create(Object.prototype),w.prototype.constructor=w,O.prototype.requestOptions=function(e,t,r){return new w(void 0===e?v.GET:e,void 0===t?M.Mailbox:t,Number.isInteger(r)?r:this.options.timeout)},O.prototype.refreshBbmToken=function(e,t){return"string"!=typeof e||0===e.length?Promise.reject(new s.Error("userId must be provided as a non-empty string")):"function"!=typeof t?Promise.reject(new s.Error("getAuthToken must be provided as a function")):t().then(t=>{if("string"!=typeof t||0===t.length)throw new s.Error("token returned from getAuthToken must be a non-empty string");return r=t,Object(n.getIdpUserIdHash)(e)}).then(t=>new Promise((a,n)=>{var o={serverAddress:this.options.profileAddress,serverPort:this.options.profilePort,uri:"/domains/"+this.domain+"/token?userId="+t+"&requireMinToken=true",method:"POST",requestHeaders:{"Content-Type":"application/json; charset=utf-8"},timeout:this.options.timeout,body:JSON.stringify({authorizationCode:r,userId:e})},i="https://"+this.options.profileAddress+(o.profilePort?":"+o.profilePort:"")+o.uri;new d.a(o).then(e=>{if(204!==e.status){var t;try{t=I.parse(e.responseText)}catch(t){return void n(new s.PermanentFailure("Request 'POST "+i+"' failed: Response cannot be parsed as JSON: "+e.responseText))}if("string"==typeof t.bbmToken&&0!==t.bbmToken.length)if("string"==typeof t.secret&&0!==t.secret.length)if(!Number.isInteger(t.expirationTime)||t.expirationTime<=0)n(new s.PermanentFailure("Request 'POST "+i+"' failed: Missing expirationTime in response: "+JSON.stringify(t)));else{var d={token:t.bbmToken,tokenMin:t.bbmTokenMin,secret:t.secret,expiry:t.expirationTime,oauthToken:r};Object.freeze(d),a(d)}else n(new s.PermanentFailure("Request 'POST "+i+"' failed: Missing secret in response: "+JSON.stringify(t)));else n(new s.PermanentFailure("Request 'POST "+i+"' failed: Missing bbmToken in response: "+JSON.stringify(t)))}else n(new s.PermanentFailure("Request '"+o.method+" "+i+"' failed: "+e.status))}).catch(e=>{e.status?e.status>=500?n(new s.TemporaryFailure("Request 'POST "+i+"' failed: "+e.status)):n(new s.PermanentFailure("Request '"+o.method+" "+i+"' failed: "+e.status)):n(new s.TemporaryFailure("Request 'POST "+i+"' failed: Timeout"))})}));var r},O.prototype.register=function(e,t,r,s,a,o,i){return Object(n.getIdpUserIdHash)(e).then(e=>{var n="/domains/"+this.domain+"/user/registration?userId="+e+"&endpointId="+t+"&platform="+l.a+"&osVersion="+p.a.osVersion+"&clientVersion="+r+"&clientBundle="+s+"&capabilities="+a+"&mpop=ephemeral",d={description:o};return i&&(d.name=i),this.request(n,this.requestOptions(v.POST,M.Profile),d)})},O.prototype.uploadFile=function(e,t,r){return function(e,t){if(!e.olympiaServiceInfo){var r="/domains/"+e.domain+"/user/profiles/"+t+"/avatar/serviceproperties";e.olympiaServiceInfo=e.request(r,e.requestOptions(v.GET,M.Profile)).then(t=>{if(t.serviceEnabled){var r=!1,s=!1;t.operations.forEach(t=>{"add"===t.type&&(e.uploadUrl=t.url,e.uploadMethod=t.httpmethod,e.uploadHeaders=t.headers,e.uploadUrl&&e.uploadMethod&&(r=!0)),"delete"===t.type&&(e.deleteMethod=t.httpmethod,e.deleteHeaders=t.headers,e.deleteMethod&&(s=!0))}),e.serviceInfoEnabled=!(!r||!s)}else e.uploadUrl=void 0,e.uploadMethod=void 0,e.uploadHeaders=void 0,e.deleteMethod=void 0,e.deleteHeaders=void 0,e.serviceInfoEnabled=!1}).catch(t=>{throw e.olympiaServiceInfo=void 0,t})}}(this,e),this.olympiaServiceInfo.then(()=>{if(!this.serviceInfoEnabled)throw new s.Error("Cannot proceed because olympia service is disabled");this.uploadUrl=this.uploadUrl.replace(/([&?])transform=bbma_publish(?=$|&)/g,"$1filetype=13"),this.uploadHeaders||(this.uploadHeaders={}),this.uploadHeaders["X-Olympia-Svc"]="bbmchat",this.uploadHeaders.accept="application/json";var e=new g.a(this.uploadUrl);return d()({serverAddress:e.host,serverPort:e.port,uri:e.pathname+e.search,method:this.uploadMethod,requestHeaders:this.uploadHeaders,responseType:"json",body:t,progress:r}).catch(e=>{throw!e.status||e.status>=500?new s.TemporaryFailure("Failure response returned from server: "+JSON.stringify(e)):(this.olympiaServiceInfo=void 0,new s.PermanentFailure("Failure response returned from server: "+JSON.stringify(e)))}).then(e=>{if(e.response&&e.response.loginResults&&e.response.loginResults.downloadUrl)return e.response.loginResults.downloadUrl;throw new s.TemporaryFailure("Bad response returned from server: "+JSON.stringify(e))})})},O.prototype.getPins=function(e){var t="/domains/"+this.domain+"/user/profiles/pins",r="["+e.join(",")+"]";return this.request(t,this.requestOptions(v.POST,M.Profile),r)},O.prototype.request=function(e,t,r){return this.bbmToken.get().then(a=>new Promise((n,i)=>{var c,l;t instanceof w||(t=this.requestOptions()),t.server===M.Mailbox?(c=this.options.mailboxAddress,l=this.options.mailboxPort):t.server===M.Kms?(c=this.options.kmsAddress,l=this.options.kmsPort):(c=this.options.profileAddress,l=this.options.profilePort);var u=!0,p=null;const f=(t,r,g)=>{var h={"X-BBM-Token":a.token};if(r.method!==v.GET&&(h["Content-Type"]="application/json; charset=utf-8"),null!==p){var m=("00000000"+p.count.toString(16)).slice(-8),b=y()(":"+p.realm+":"+a.secret),M=y()(r.method+":"+t),w=y()(b+":"+p.nonce+":"+m+":"+p.cnonce+":"+p.qop+":"+M);h.Authorization=p.scheme+' username="", realm="'+p.realm+'", nonce="'+p.nonce+'", uri="'+t+'", response="'+w+(p.opaque?'", opaque="'+p.opaque:"")+'", qop="'+p.qop+'", nc="'+m+'", cnonce="'+p.cnonce+'"'}const O=r.method===v.GET||r.method===v.DELETE?void 0:"string"==typeof g?g:I.stringify(g);O&&Object(o.default)(o.default.DEBUG2,"%s: Request entity=%s","BusClient",O),new d.a({serverAddress:c,serverPort:l,uri:e,method:r.method,timeout:r.timeout,requestHeaders:h,body:O}).then(e=>{if(e.responseText){Object(o.default)(o.default.DEBUG2,"%s: Response entity=%s","BusClient",e.responseText);try{n(I.parse(e.responseText))}catch(a){i(new s.PermanentFailure("Request '"+r.method+" "+t+"' failed: Response cannot be parsed as JSON: "+e.responseText))}}else n()}).catch(e=>{if(e.responseText&&Object(o.default)(o.default.DEBUG2,"%s: Response entity=%s","BusClient",e.responseText),e.status)if(e.status>=500)i(new s.TemporaryFailure("Request '"+r.method+" "+t+"' failed: "+e.status));else{if(401===e.status){if(!u)return this.bbmToken.refresh(),void i(new s.TemporaryFailure("Request '"+r.method+" "+t+"' failed: "+e.status));u=!1;var a=e.headers["WWW-Authenticate"];if(!a)return void i(new s.PermanentFailure("Request '"+r.method+" "+t+"' failed: "+e.status+"; No WWW-Authenticate header in response"));var n={};if(n.scheme=a.split(/\s/,1)[0],!n.scheme.match(/Digest/))return void i(new s.PermanentFailure("Request '"+r.method+" "+t+"' failed: "+e.status+"; Failed to parse authentication scheme from WWW-Authenticate header: "+a));var d=a.slice(n.scheme.length).match(/\s*?[^\s]+?\s*?=\s*?"[^"]*?"\s*?,?/g);return d?(d.forEach(e=>{var t=e.match(/\s*?([^\s]+?)\s*?=\s*?"([^"]*?)"/);n[t[1]]=t[2]}),n.realm?n.nonce?"auth"!=n.qop?void i(new s.PermanentFailure("Request '"+r.method+" "+t+"' failed: "+e.status+"; Failed to parse authentication qop from WWW-Authenticate header: "+a)):(n.count=1,n.cnonce=this.cnonceFunction(),p=n,void f(t,r,g)):void i(new s.PermanentFailure("Request '"+r.method+" "+t+"' failed: "+e.status+"; Failed to parse authentication nonce from WWW-Authenticate header: "+a)):void i(new s.PermanentFailure("Request '"+r.method+" "+t+"' failed: "+e.status+"; Failed to parse authentication realm from WWW-Authenticate header: "+a))):void i(new s.PermanentFailure("Request '"+r.method+" "+t+"' failed: "+e.status+"; Failed to parse digest data from WWW-Authenticate header: "+a))}if(403!==e.status){if(404===e.status)try{var c=I.parse(e.responseText);if(c&&"NotFound"===c.error)return void i(new s.NotFound("Request '"+r.method+" "+t+"'"))}catch(e){}i(new s.PermanentFailure("Request '"+r.method+" "+t+"' failed: "+e.status))}else i(new s.Forbidden("Request '"+r.method+" "+t+"'"))}else i(new s.TemporaryFailure("Request '"+r.method+" "+t+"' failed: Timeout"))})};f("https://"+c+(l?":"+l:"")+e,t,r)}))},O.prototype.reset=function(){this.bbmToken.reset()},O.prototype.resolveAppUserIds=function(e){if(!(e instanceof Array))throw new TypeError("appUserIds must be an array");if(e.some(e=>"string"!=typeof e))throw new TypeError("appUserIds must be strings");return R(this,`/domains/${this.domain}/user/identity/regId`,e)},O.prototype.resolveRegIds=function(e){if(!(e instanceof Array))throw new TypeError("regIds must be an array");const t=/^[0-9]+$/,r=e.map(e=>{if("string"!=typeof e)throw new TypeError("regIds must be strings");if(null===e.match(t))throw new TypeError("regIds must contain only digits [0-9]");try{return new b.a(e)}catch(e){throw new TypeError(`regIds must be convertible to numbers: ${e}`)}});return R(this,`/domains/${this.domain}/user/identity/userId`,r)}},function(e,t,r){"use strict";t.a=i;var s=r(0),a=r(5),n=r(27),o=r(3);function i(e,t,r){if("string"!=typeof e||0===e.length)throw new s.Error("Data.Participant requires the regId parameter be a non-empty string: regId="+e);if(Object.defineProperty(this,"regId",{writable:!1,enumerable:!0,value:e}),!i.State.hasOwnProperty(t))throw new s.Error("Participant state must be defined in Participant.State");if(this.state=t,"boolean"!=typeof r)throw new s.Error("Data.Participant requires the isAdmin parameter be a boolean: isAdmin="+r);this.isAdmin=r,this.deliveredMsgId=new a.a,this.deliveredTimestamp=0,this.readMsgId=new a.a,this.readTimestamp=0,this.shredMsgId=new a.a;let o=d(this.state);this.externalView=o?new n.a(this.regId,o,this.isAdmin):null}function d(e){return e.startsWith("Pending")?n.a.State.Pending:"Active"===e?n.a.State.Active:void 0}i.State={PendingGrant:"PendingGrant",PendingInvite:"PendingInvite",PendingJoin:"PendingJoin",Active:"Active",Left:"Left"},Object.freeze(i.State),i.prototype.updateExternalView=function(){Object(o.default)(null===this.externalView||this.regId===this.externalView.regId,"RegId mismatch");let e=d(this.state);return!!(null===this.externalView&&void 0!==e||this.externalView&&(this.externalView.state!==e||this.externalView.isAdmin!==this.isAdmin))&&(this.externalView=e?new n.a(this.regId,e,this.isAdmin):null,!0)},i.prototype.toString=function(){let e="";return this.isAdmin&&(e=" admin"),`Data.Participant[r=${this.regId} s=${this.state}${e}]`}},function(e,t){e.exports=require("eventemitter3")},function(e,t){e.exports=require("bignumber.js")},function(e,t){e.exports=require("json-bigint")},function(e,t){e.exports=require("./environment_request.js")},function(e,t,r){"use strict";t.a=i;var s=r(0),a=r(1),n=r(26),o=r(40);function i(e,t,r,a,o,d,c,l,u){if("string"!=typeof e||0==e.length)throw new s.Error("Chat requires the chatId parameter be a non-empty string: chatId="+e);if(!(t instanceof Date))throw new s.Error("Chat requires the creationTime parameter to be a Date");if("boolean"!=typeof r)throw new s.Error("Chat requires the isOneToOne parameter be a boolean: isOneToOne="+r);switch(a){case i.State.Waiting:case i.State.Defunct:case i.State.Restoring:case i.State.Ready:break;default:throw new s.Error("Chat requires the state parameter to be one of the Chat.State values; state="+a)}if("string"!=typeof o)throw new s.Error("Chat requires the subject parameter be a string: subject="+o);if("object"!=typeof d||!Array.isArray(d))throw new s.Error("Chat requires the participants parameter be a Participant[]: participants="+d);if(void 0!==c&&!i.InvitePolicy.hasOwnProperty(c))throw new s.Error("invitePolicy must be a valid Chat.InvitePolicy or undefined. It is: "+c);if(!1===r&&void 0===c)throw new s.Error("invitePolicy must be a valid Chat.InvitePolicy when isOneToOne is false");if(r&&void 0!==c)throw new s.Error("invitePolicy must not be specified when isOneToOne is true. It is: "+c);if(void 0!==l&&!(l instanceof Date))throw new s.Error("Chat requires the lastActivity parameter to be a Date");if(void 0!==u&&(!(u instanceof Object)||Array.isArray(u)))throw new s.Error("Chat requires the data parameter to be an Object");this.chatId=e,this.creationTime=t,this.isOneToOne=r,this.state=Object(n.a)(a),this.subject=o,this.participants=d,Object.freeze(this.participants),this.invitePolicy=c,this.lastActivity=void 0!==l?l:new Date,this.data=void 0===u?{}:u,Object.freeze(this)}i.State={Waiting:"Waiting",Restoring:"Restoring",Defunct:"Defunct",Ready:"Ready"},Object.freeze(i.State),i.InvitePolicy={AdminsOnly:"AdminsOnly",ParticipantsOnly:"ParticipantsOnly"},Object.freeze(i.InvitePolicy),i.prototype.withNewType=function(e,t){return e||t||(t=i.InvitePolicy.ParticipantsOnly),new i(this.chatId,this.creationTime,e,this.state,this.subject,this.participants,t,this.lastActivity)},i.prototype.withNewParticipants=function(e){return new i(this.chatId,this.creationTime,this.isOneToOne,this.state,this.subject,e,this.invitePolicy,this.lastActivity)},i.prototype.withUpdate=function(e,t){const r=void 0===e.subject?this.subject:e.subject,s=void 0===e.invitePolicy||!0===this.isOneToOne?this.invitePolicy:e.invitePolicy,n=void 0!==t&&t.getTime()!==this.creationTime.getTime()?t:this.creationTime;let d=void 0===e.data?this.data:e.data,c=!0;try{c=Object(o.a)(this.data,d)}catch(e){Object(a.default)(a.default.WARNING,"Chat: Ignoring invalid data in update for chatId=%s: %s",this.chatId,e),d=this.data}if(r!==this.subject||s!==this.invitePolicy||n!==this.creationTime||!c)return new i(this.chatId,n,this.isOneToOne,this.state,r,this.participants,s,this.lastActivity,d)},i.prototype.withNewState=function(e){return this.state===i.State.Defunct?(console.log("Ignoring state change for chatId="+this.chatId+" from final state="+this.state+" to state="+e),this):new i(this.chatId,this.creationTime,this.isOneToOne,e,this.subject,this.participants,this.invitePolicy,this.lastActivity)},i.prototype.withNewActivity=function(e){return e<=this.lastActivity?(console.log("Ignoring lastActivity change for chatId="+this.chatId+" from "+this.lastActivity+" to "+e),this):new i(this.chatId,this.creationTime,this.isOneToOne,this.state,this.subject,this.participants,this.invitePolicy,e)},i.prototype.toString=function(){return"Chat{id="+this.chatId+" t="+(this.isOneToOne?"OneToOne":"Conference")+" s="+this.state+" p="+this.invitePolicy+"}"}},,,function(e,t){e.exports=require("./environment_base64.js")},function(e,t){e.exports=require("text-encoding")},function(e,t){e.exports=require("./environment_crypto.js")},function(e,t){e.exports=require("./environment_transport.js")},function(e,t){e.exports=require("./environment_platform.js")},function(e,t){e.exports=require("md5")},function(e,t,r){"use strict";t.a=function e(t){if("object"==typeof t&&null!==t&&!Object.isFrozen(t)&&!ArrayBuffer.isView(t)||"function"==typeof t){Object.freeze(t);for(const r in t)e(t[r])}return t}},function(e,t,r){"use strict";t.a=n;var s=r(0),a=r(26);function n(e,t,r){if("string"!=typeof e||0==e.length)throw new s.Error("Participant requires the regId parameter be a non-empty string: regId="+e);if(!n.State.hasOwnProperty(t))throw new s.Error("state must be a valid Participant.State. It is: "+t);if(void 0!==r&&"boolean"!=typeof r)throw new s.Error("Participant requires the isAdmin parameter be a boolean or undefined: isAdmin="+r);this.regId=e,this.state=t,this.isAdmin=!0===r,Object(a.a)(this)}n.State={Active:"Active",Pending:"Pending"},Object.freeze(n.State),n.prototype.toString=function(){return"Participant{r="+this.regId+" a="+this.isAdmin+(this.state===n.State.Active?"":" s="+this.state)+"}"}},function(e,t,r){"use strict";t.a=u;var s=r(44),a=r(45),n=r(12),o=r(43),i=r(5),d=r(3),c=r(1),l=r(0);function u(e,t,r){if("string"!=typeof t||0===t.length)throw new l.Error("Chat id must be a non-empty string");if("function"!=typeof e.allocate)throw new l.Error("messageStorageFactory.allocate must be a function");var n=t;if(Object.defineProperty(this,"id",{enumerable:!0,value:n,writable:!1}),this.participants=new Map,this.nextPullPoint=void 0,this.messages=new a.a(e.allocate(t)),!u.State.hasOwnProperty(r))throw new l.Error("Chat state must be defined in Chat.State");this.state=r,this.synced=!1,this.waitingForRetry=!1,this.refreshRequired=!1,this.fullDeliveredMsgId=new i.a,this.partialDeliveredMsgId=new i.a,this.fullReadMsgId=new i.a,this.partialReadMsgId=new i.a,this.inviteId=new o.a,this.restorePoint=new i.a,this.statusMessageId=new i.a,this.typingUsers=new Map,this.recalledMessages=new Map,this.shredMessages=new Map,this.deletedMessages=new Set;var d=new s.a;Object.defineProperty(this,"bookmarkData",{enumerable:!0,value:d,writable:!1});const c=new Map;this.processSingleReferences=(e=>p(this,c,e,void 0)),this.processPulledReferences=((e,t)=>p(this,c,e,t))}function p(e,t,r,s){const a=c.default.logThreshold>=c.default.DEBUG2?e.toString()+"::prv_processReferences()":void 0;if(r.chatId!==e.id)throw new l.Error(`${e.toString()}: Refusing to process references for messageId=`+`${r.messageId}; chatId=${r.chatId} mismatch`);let n=[];function o(e,t,r){if(void 0===e){return[{tag:t,messageIds:[r]}]}let s=0;for(;s<e.length;++s){const a=e[s];if(a.tag===t){if(-1!==a.messageIds.findIndex(e=>e.isEqual(r)))return!1;break}}let a=Array.from(e);if(s!==e.length){let e=a[s],t=e.messageIds;Object.isFrozen(e)&&(t=Array.from(e.messageIds),e=Object.assign({},e,{messageIds:t}),a[s]=e),t.push(r),t.sort()}else a.push({tag:t,messageIds:[r]});return a}if(Object(c.default)(c.default.DEBUG2,"%s: Processing references for messageId=%s; %s uncached",a,r.messageId,s instanceof Array?s.length.toString():"no"),r.ref){Object(c.default)(c.default.DEBUG2,"%s: Processing outbound references for messageId=%s",a,r.messageId);for(const i of r.ref){Object(c.default)(c.default.DEBUG2,"%s: Looking for referenced messageId=%s in our cache",a,i.messageId);let l=e.messages.getMessage(i.messageId),u=void 0;if(void 0===l&&s&&(Object(c.default)(c.default.DEBUG2,"%s: Looking for referenced messageId=%s in uncached messages",a,i.messageId),-1===(u=s.findIndex(e=>e.messageId.isEqual(i.messageId)))&&(u=void 0),void 0!==u&&(l=s[u]).chatId!==e.id))Object(c.default)(c.default.DEBUG2,"%s: Ignoring reference to messageId=%s that isn't in our chat",a,i.messageId);else if(void 0!==l){Object(c.default)(c.default.DEBUG2,"%s: Found referenced messageId=%s in %s",a,i.messageId,void 0===u?"uncached messages":"our cache"),Object(d.default)(l.chatId==e.id);const t=o(l.refBy,i.tag,r.messageId);if(!1===t){Object(c.default)(c.default.DEBUG2,"%s: Ignoring duplicate tag=%s messageId=%d in refBy for messageId=%s",a,i.tag,r.messageId,i.messageId);continue}const p=l.withNewRefBy(t);if(void 0===u){e.messages.replace(p),-1===n.findIndex(e=>e.isEqual(p.messageId))&&n.push(p.messageId)}else s[u]=p}else{Object(c.default)(c.default.DEBUG2,"%s: Referenced messageId=%s is unknown; staging its refBy",a,i.messageId);const e=o(t.get(i.messageId.toString()),i.tag,r.messageId);t.set(i.messageId.toString(),e)}}}const i=t.get(r.messageId.toString());if(void 0!==i){Object(c.default)(c.default.DEBUG2,"%s: Found stagedRefBy for messageId=%s",a,r.messageId);const o=r.withNewRefBy(i);if(t.delete(r.messageId.toString()),void 0===s)e.messages.replace(o),n.push(o.messageId);else{const e=s.findIndex(e=>e.messageId.isEqual(o.messageId));-1!==e&&(s[e]=o)}}return n}u.State={Joining:"Joining",WaitingForKey:"WaitingForKey",Restore:"Restore",Ready:"Ready",Leave:"Leave",Defunct:"Defunct"},Object.freeze(u.State),u.prototype.createParticipant=function(e,t,r){var s=this.participants.get(e);if(void 0!==s)throw new l.Error("Participant for regId="+e+" already exists in chat for id="+this.id);return s=new n.a(e,t,r),this.participants.set(e,s),s},u.prototype.findParticipant=function(e){var t=this.participants.get(e);if(!t)throw new l.NotFoundError("Could not find participant with regId="+e+" in chatId="+this.id);return t},u.prototype.getParticipant=function(e){return this.participants.get(e)},u.prototype.getParticipantExternalViews=function(){let e=[];for(let t of this.participants.values())t.externalView&&e.push(t.externalView);return e},u.prototype.toString=function(){return`Data.Chat[m=${this.id} s=${this.state}]`}},,,,function(e,t,r){"use strict";function s(){}Object.defineProperty(t,"__esModule",{value:!0}),t.default=s,s.FailureChoice={GenerateNewKeys:"GenerateNewKeys",GetProfileKeys:"GetProfileKeys",AbandonSetup:"AbandonSetup"},Object.freeze(s.FailureChoice)},function(e,t,r){"use strict";function s(){}t.a=s,Object.defineProperty(s,"min",{writable:!1,value:-2147483648}),Object.defineProperty(s,"max",{writable:!1,value:2147483647}),s.getNextCounter=function(e){return e>=s.max?s.min:0==++e?1:e}},function(e,t,r){"use strict";var s=r(4),a=r(0),n=r(2),o=r(1);const i="BaseKeyManager";function d(e,t){o.default.debug(o.default.DEBUG2,"%s: Key from %s: %s",i,e,n.array2hex(t))}function c(e,t){for(const r in t)d(e+" "+r,t[r])}function l(e,t){o.default.debug(o.default.DEBUG2,"%s: CryptoKey from %s: {t=%s e=%s a=%s u=%s}",i,e,t.type,t.extractable,JSON.stringify(t.algorithm),t.usages)}function u(e,t){for(const r in t)l(e+" "+r,t[r])}t.a=class{constructor(e,t){this.regId=e,this.getPublicKeysFunction=t,this.profileKeys={},this.chatKeys=new Map,this.publicKeys=new Map,this.publicKeyRequests=new Map}generateProfileKeys(){return Object(o.default)(o.default.INFO,"%s: Generating new profile keys",i),Promise.all([s.generateEncryptionKeyPair(),s.generateSigningKeyPair()]).then(e=>(c("generatedProfileKeys result",e[0]),c("generatedProfileKeys result",e[1]),{privateEncryptionKey:e[0].privateKey,privateSigningKey:e[1].privateKey,publicEncryptionKey:e[0].publicKey,publicSigningKey:e[1].publicKey}))}setProfileKeys(e){return Promise.all([s.importPrivateEncryptionKey(e.privateEncryptionKey,e.publicEncryptionKey),s.importPrivateSigningKey(e.privateSigningKey,e.publicSigningKey),s.importPublicEncryptionKey(e.publicEncryptionKey),s.importPublicSigningKey(e.publicSigningKey)]).then(e=>(this.profileKeys={private:{encrypt:e[0],sign:e[1]},public:{encrypt:e[2],sign:e[3]}},Promise.resolve()))}getPrivateEncryptionKey(){return new Promise(e=>{if(void 0===this.profileKeys.private||void 0===this.profileKeys.private.encrypt)throw new a.NotFoundError("No private encryption key");return l("getPrivateEncryptionKey dispensing",this.profileKeys.private.encrypt),e(this.profileKeys.private.encrypt)})}getPrivateSigningKey(){return new Promise(e=>{if(void 0===this.profileKeys.private||void 0===this.profileKeys.private.sign)throw new a.NotFoundError("No private signing key");return l("getPrivateSigningKey dispensing",this.profileKeys.private.sign),e(this.profileKeys.private.sign)})}getPublicKeys(e){if(e===this.regId)return new Promise(t=>(l("getPublicKeys["+e+"] dispensing cached",this.profileKeys.public),t(this.profileKeys.public)));const t=this.publicKeys.get(e);if(t)return u("getPublicKeys["+e+"] dispensing cached",t),Promise.resolve(t);const r=this.publicKeyRequests.get(e);if(r)return r;const n=this.getPublicKeysFunction(e).then(t=>{if(!t||!t.encryptionKey||!t.signingKey)throw new a.NotFoundError("No public keys for regId="+e);return c("getPublicKeysFunction["+e+"] result",t),Promise.all([s.importPublicEncryptionKey(t.encryptionKey),s.importPublicSigningKey(t.signingKey)])}).then(t=>{let r={encrypt:t[0],sign:t[1]};return u("getPublicKeysFunction["+e+"] dispensing",r),this.publicKeys.set(e,r),this.publicKeyRequests.delete(e),r}).catch(t=>{throw this.publicKeyRequests.delete(e),t});return this.publicKeyRequests.set(e,n),n}removePublicKeys(e){this.publicKeys.delete(e),o.default.debug(o.default.DEBUG2,"%s: Removed public keys for regId=%s",i,e)}getChatKey(e){return new Promise(t=>{const r=this.chatKeys.get(e);if(r)return d("getChatKey["+e+"] dispensing",r),t(r);throw new a.NotFoundError("No chat key for chatId="+e)})}setChatKey(e,t){this.chatKeys.set(e,t),d("setChatKey["+e+"]",t)}removeChatKey(e){this.chatKeys.delete(e),o.default.debug(o.default.DEBUG2,"%s: Removed chat key for chatId=%s",i,e)}}},function(e,t,r){"use strict";var s=r(3);t.a=class{constructor(e){Object(s.default)(void 0!==e),Object(s.default)("object"==typeof e.content),Object(s.default)("string"==typeof e.id),Object(s.default)("number"==typeof e.time),Object.defineProperty(this,"data",{value:e.content,enumerable:!0}),Object.defineProperty(this,"externalId",{value:e.id,enumerable:!0}),Object.defineProperty(this,"postTime",{value:new Date(e.time),enumerable:!0})}}},function(e,t){e.exports=require("./environment_version.js")},function(e,t){e.exports=require("./environment_url.js")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=a;const s=r(11).default.Method;function a(e,t,r){this.busClient=e,this.domain=t,this.regId=r}a.prototype.getAllEndpoints=function(){const e=`/domains/${this.domain}/user/endpoint/${this.regId}`;return this.busClient.request(e,this.busClient.requestOptions(s.GET))},a.prototype.deleteEndpoint=function(e){const t=`/domains/${this.domain}/user/endpoint/${this.regId}/${e}`;return this.busClient.request(t,this.busClient.requestOptions(s.DELETE))}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=q,t.setup=function(e,t){const r=t.configuration,d=t.messengerData,S=t.persistentData,j="Messenger";return Object(x.default)(x.default.INFO,"%s: Starting setup for e=%s",j,S.endpointId),d.lastUpload=Promise.resolve(),d.db=new p.a(r.messageStorageFactory?new r.messageStorageFactory:new O.a,d.registrationInfo.regId),d.managementClient=new I.a(d.busClient,r.domain,d.registrationInfo.regId),d.contentClient=new m.a(d.transport),d.syncManager=new M.a(d.contentClient,d.db,function(e){try{!function(e){const t=e.mailboxId,r=e.messageData.messageId,n=e.messageData.userId,o=e.messageData.timestamp,i=e.messageData.message.binary;d.lastOnlineMessage=d.lastOnlineMessage.then(()=>d.rim_im.receive(t,n,i)).then(e=>{if(!1===e.verified){const t=new g.ProtectionError("unverified chat message");throw t.retry=e.retry,t}return e}).catch(e=>{if(e instanceof g.ProtectionError&&"function"==typeof e.retry)return d.keyManager.removePublicKeys(n),e.retry().then(e=>(e.verified&&k("userKeysChanged",new h.UserKeysChanged(n)),e));throw e}).then(i=>{function p(e){const s=d.db.findChat(t),a=s.messages.insert(e);switch(a){case u.a.InsertionResult.Rejected:console.log("Rejected duplicate messageId="+r);break;case u.a.InsertionResult.Updated:console.log("Received updated messageId="+r),se(e,!1);break;case u.a.InsertionResult.Inserted:console.log("Received new messageId="+r),se(e,!0);break;default:Object(R.default)(!1,"Unexpected message insertion result: "+a)}X(t,r).catch(function(e){console.error("Failed to post delivery notification for messageId="+r+": error="+e)})}function g(){switch(i.name){case"content":case"subject":case"join":case"leave":case"shred":case"remove":case"admin":A(r,t,n,o,i).withFileSize().then(p);break;default:throw new TypeError('Received unsupported identity message "'+i.name+'"')}}if(Object(x.default)(x.default.INFO,'%s: Received "%s": %s in chatId=%s v=%s',j,i.name,e.messageData,t,i.verified||!1),t.startsWith("id.")){if("system"===n){switch(i.name){case"chatRemoved":J(i.body,n);break;case"appMessage":k("appMessageReceived",new h.AppMessageReceived(new s.a(i.body)));break;default:Object(x.default)(x.default.WARNING,'%s: Ignoring unknown identity message from system user "%s"',j,i.name)}return}switch(i.name){case"invite":V(i.body,n,r.binary).catch(function(e){console.error("Failed to accept invite chatId="+i.body.mailboxId+" from regId="+n+"; error="+e)});break;case"chatCreated":!function(e){if(e.endpointId===S.endpointId)return void console.log("Ignoring chatCreated message from our own endpointId="+e.endpointId+" for chatId="+e.mailboxId);if(S.filter&&!S.filter.has(e.mailboxId))return void console.log("Ignoring chat "+e.mailboxId+" created on other endpoint which is not in the filter list");if(!(e.symmetricKey instanceof Uint8Array)||0===e.symmetricKey.length)return void console.error("Failed to handle chatCreated message with bad symmetricKey="+e.symmetricKey);let t=d.chatCache.get(e.mailboxId);if(void 0!==t)return void console.log("Received chatCreated message for chatId="+e.mailboxId+" that is already known");console.log("Adding chatId="+e.mailboxId+" that was created by endpointId="+e.endpointId);const r=void 0!==e.peer&&void 0!==e.peer.regId;if(r){const t=e.peer.regId,r=d.chatCache.get(d.db.getPeerChatId(t));if(r&&(console.log("Leaving "+r+" to use chatId="+e.mailboxId+" created by endpointId="+e.endpointId+" with peer="+t),Y(r.chatId).catch(e=>{console.error("Failed to leave "+r+"; error="+e)})),void 0!==d.db.getPeerPromise(t))return Object(x.default)(x.default.NOTICE,"%s: Already creating 1:1 chat with regId=%s; leaving existing 1:1 chat mailboxId=%s created by endpointId=%s",j,t,e.mailboxId,e.endpointId),void Y(e.mailboxId).catch(t=>{Object(x.default)(x.default.ERROR,"%s Failed to leave mailboxId=%s: %s",j,e.mailboxId,t)})}d.keyManager.setChatKey(e.mailboxId,e.symmetricKey);const s=[];s.push({regId:d.registrationInfo.regId,state:f.a.State.Active,admin:!r}),r&&s.push({regId:e.peer.regId,state:f.a.State.PendingJoin,admin:!1});var n=d.db.createChat(e.mailboxId,l.a.State.Restore,s,r);t=new a.a(e.mailboxId,new Date(0),r,a.a.State.Waiting,P.truncate(e.subject,128),n.getParticipantExternalViews(),r?void 0:a.a.InvitePolicy.ParticipantsOnly),d.chatCache.set(t),t.isOneToOne&&d.db.addPeerChatId(e.peer.regId,t.chatId),k("chatAdded",new h.ChatAdded(t)),d.mailboxFetcher.fetchAndStore(t.chatId,!0)}(i.body);break;case"chatLeft":!function(e){if(e.endpointId===S.endpointId)return void console.log("Ignoring chatLeft message from our own endpointId="+e.endpointId+" for chatId="+e.mailboxId);const t=d.chatCache.get(e.mailboxId),r=d.db.getChat(e.mailboxId);if(void 0===t)return console.log("Received chatLeft message for unknown chatId="+e.mailboxId),void Z(e.mailboxId);d.mailboxFetcher.fetchAndStore(e.mailboxId,!0);let s=!0;e.remove||void 0===r||r.messages.isEmpty()||(s=!1),!0===s?(console.log("Received chatLeft message from endpointId="+e.endpointId+" for chatId="+e.mailboxId+"; removing chat"),Z(e.mailboxId)):(console.log("Received chatLeft message from endpointId="+e.endpointId+" for chatId="+e.mailboxId+" that has content; marking  as defunct"),Q(t,a.a.State.Defunct))}(i.body);break;case"chatRemoved":J(i.body,n);break;case"restoreMarker":console.log("Ignoring restore marker for endpointId="+i.body.endpointId);break;default:console.warn('Ignoring unknown identity message "'+i.name+'"')}return}let y=d.db.getChat(t);if(void 0===y)return Object(x.default)(x.default.NOTICE,'%s: Ignoring "%s" message for unknown chat mailboxId=%s',j,i.name,t),void d.mailboxFetcher.fetchAndStore(t,!0);let m=$(t);if("system"===n){if("metadataChanged"===i.name){const e=void 0===i.body.changes?"":i.body.changes;Object(x.default)(x.default.INFO,"%s: Handling metadataChanged[%s] from system for %s",j,e,m),d.mailboxFetcher.fetchAndStore(y.id,!0)}else Object(x.default)(x.default.NOTICE,'%s: Ignoring "%s" message from system',j,i.name);return}let b=y.getParticipant(n);if(void 0===b||b.state!==f.a.State.Active){if("typing"!==i.name){let e;m.isOneToOne&&(e=m.participants[0].regId===d.registrationInfo.regId?m.participants[1].regId:m.participants[0].regId),(m=c.b({messengerData:d,emitFunc:k},y,m,n,f.a.State.Active)).isOneToOne&&m.participants.length>2&&(m=m.withNewType(!1),d.chatCache.set(m),k("chatUpdated",new h.ChatUpdated(m)),Object(R.default)(e),d.db.removePeerChatId(e,m.chatId)),b=y.getParticipant(n)}"join"!==i.name&&d.mailboxFetcher.fetchAndStore(t,!0)}switch(i.name){case"content":{y.typingUsers.has(n)&&(clearTimeout(y.typingUsers.get(n)),y.typingUsers.delete(n),k("chatTyping",new h.ChatTyping(t,n,!1)));let e=y.recalledMessages.get(r.binary.toString()),s=y.shredMessages.get(n);e&&-1!==e.indexOf(n)||s&&s.isGreaterThanOrEqual(r)?(Object(x.default)(x.default.INFO,"Received messageId=%s was recalled",r),p(A(r,t,n,o,i).recalled())):y.deletedMessages.has(r.binary.toString())?(Object(x.default)(x.default.INFO,"Received messageId=%s was deleted",r),p(A(r,t,n,o,i).deleted())):g();break}case"subject":{const e=m.withUpdate({subject:P.truncate(i.body.subject,128)});void 0!==e&&(d.chatCache.set(e),k("chatUpdated",new h.ChatUpdated(e))),g();break}case"status":{const e=H(y,[{messageId:r,regId:n,status:i.body,timestamp:o}]);if(e.length>0){m=$(t);for(const t of e)k("chatMessageUpdated",new h.ChatMessageUpdated(m,t))}break}case"join":{let e=A(r,t,n,o,i);try{let s=y.messages.insertOne(e,i.body.inviteId);X(t,r).catch(function(e){console.error("Failed to post delivery notification for messageId="+r+": error="+e)}),s&&k("chatMessageUpdated",new h.ChatMessageUpdated($(t),s)),se(e,!0)}catch(e){console.log('Ignoring "join" message for chatId='+t+"; "+e)}break}case"leave":if(n==d.registrationInfo.regId){Object(x.default)(x.default.DEBUG1,"%s: Ignoring leave message from our own regId",j);break}m.isOneToOne?(console.log("Leaving "+m+" because peer has left"),Y(m.chatId).catch(function(e){console.error("Failed to leave "+m+"; error="+e)})):(m=c.b({messengerData:d,emitFunc:k},y,m,n,f.a.State.Left),g()),d.mailboxFetcher.fetching(t)&&d.mailboxFetcher.fetchAndStore(t,!0);break;case"typing":{if(n===d.registrationInfo.regId){Object(x.default)(x.default.DEBUG1,"%s: Ignoring typing notification from our own regId",j);break}if(!N(b)){Object(x.default)(x.default.INFO,"%s: Ignoring typing notification from inactive userId=%s",j,n);break}const e=3e4,r=i.body.tag,s=i.body.messageId?new v.a(i.body.messageId):void 0;let a=!1;if(y.typingUsers.has(n)){const o=y.typingUsers.get(n);r===o.tag?(a=s?void 0===o.messageId||!s.isEqual(o.messageId):void 0!==o.messageId)||console.log("Received typing notification for user="+`${n} who is already typing. Resetting timeout`):a=!0,a&&(o.tag=r,o.messageId=s,k("chatTyping",new h.ChatTyping(t,n,!0,r,s))),clearTimeout(o.timeout),o.timeout=setTimeout(()=>{y.typingUsers.delete(n),k("chatTyping",new h.ChatTyping(t,n,!1))},e)}else{const a={tag:r,messageId:s,timeout:setTimeout(()=>{y.typingUsers.delete(n),k("chatTyping",new h.ChatTyping(t,n,!1))},e)};y.typingUsers.set(n,a),k("chatTyping",new h.ChatTyping(t,n,!0,r,s))}break}case"recall":U(t,i.body.ids,n);break;case"shred":K(t,r,n),g();break;case"delete":_(t,i.body.ids,n);break;case"remove":if(i.body.regId==d.registrationInfo.regId){Object(x.default)(x.default.DEBUG1,"%s: Ignoring remove message for our own regId",j);break}(function(e,t){if(t===d.registrationInfo.regId)return Object(x.default)(x.default.ERROR,"%s: Not allowed to remove local user from chatId=%s",j,e.chatId),!1;if(e.isOneToOne)return Object(x.default)(x.default.ERROR,"%s: Not allowed to remove participants from 1:1 chatId=%s",j,e.chatId),!1;let r=d.db.findChat(e.chatId),s=r.getParticipant(t);return!s||s.state===f.a.State.Left||(c.b({messengerData:d,emitFunc:k},r,e,t,f.a.State.Left),!0)})(m,i.body.regId)&&(m=$(m.chatId),g());break;case"admin":{let e=d.db.findChat(m.chatId);if(n===i.body.regId)return void Object(x.default)(x.default.ERROR,"%s: Ignoring self-promotion attempt from %s",j,n);void 0===e.getParticipant(i.body.regId)&&d.mailboxFetcher.fetchAndStore(t,!0),m=c.b({messengerData:d,emitFunc:k},e,m,i.body.regId,f.a.State.Active,!0===i.body.promotion),g();break}case"metadataChanged":{const e=void 0===i.body.changes?"":i.body.changes;Object(x.default)(x.default.INFO,"%s: Handling metadataChanged[%s] from regId=%s for %s",j,e,n,m),d.mailboxFetcher.fetchAndStore(y.id,!0);break}default:g()}}).catch(e=>{Object(x.default)(x.default.ERROR,"%s: Failed to handle a received message for chatId=%s: %s",j,t,e)})}(e)}catch(e){console.error(e)}},function(e,t){if(!e.startsWith("id."))try{ee(e,t)}catch(t){}}),d.transportCallbacks.receive=function(e){d.contentClient.receiveOnlineMessage(e,function(e){console.log("Ignoring online message for m="+e.mailboxId+": "+e.messageData)})},d.transportCallbacks.connected=function(){d.syncManager.startReconnectSync(),S.retryServerRequests()},d.transportCallbacks.disconnected=function(){d.syncManager.transportDisconnected()},d.retryServerRequestFunctions.push(function(){d.syncManager.retrySingleRequest()}),d.mailboxFetcher=new o.a(d,S.requestManager,S.filter,S.kmsMode,k,Y,Z),S.requestManager.retryableRequest(function(){return d.throwIfSipRegistrationFailed(),d.syncManager.reconcileFromPost(d.db.identityMailboxId,d.rim_im.restoreMarker(S.endpointId))}).then(()=>{if(void 0===S.filter)return Object(x.default)(x.default.INFO,"%s: Restoring all mailboxes",j),S.requestManager.retryableRequest(()=>(d.throwIfSipRegistrationFailed(),d.managementClient.getAllMailboxes().catch(e=>(Object(x.default)(x.default.ERROR,"%s: Failed to retrieve mailboxes: ",j,e.message),Promise.reject(e)))));{Object(x.default)(x.default.INFO,"%s: Restoring %d filtered mailboxes",j,S.filter.size);let e=[],t=[];for(const r of S.filter){const s=d.mailboxFetcher.fetch(r).then(t=>{e.push(t)}).catch(e=>{Object(x.default)(x.default.WARNING,"%s: Failed to retrieve mailboxId=%s: %s; ignoring",j,r,e)});t.push(s)}return Promise.all(t).then(()=>e)}}).then(function(e){d.throwIfSipRegistrationFailed(),Object(x.default)(x.default.INFO,"%s: Restoring %d fetched mailboxes",j,e.length),d.chatCache=new n.a;var t=[];for(const r of e)t.push(d.mailboxFetcher.store(r).catch(function(){return null}));return Promise.all(t).then(()=>{Object(x.default)(x.default.INFO,"%s: Finished restoring %d fetched mailboxes resulting in %d chats",j,e.length,d.chatCache.size())})}).then(function(){return d.throwIfSipRegistrationFailed(),W()}).then(function(){function s(e,t,r){const s=d.db.findChat(e);if(t===d.registrationInfo.regId)return Promise.reject(new g.Error("Not allowed to change admin status for local user in chatId="+e));{const t=s.getParticipant(d.registrationInfo.regId);if(void 0===t||!t.isAdmin)return Promise.reject(new g.Error("Non-admin user not allowed to change admin status for other users in chatId="+e))}return $(e).isOneToOne?Promise.reject(new g.Error("Not allowed to change admin status for non conference in chatId="+e)):S.requestManager.retryableRequest(function(){return r?d.managementClient.addAdmin(e,t):d.managementClient.removeAdmin(e,t)}).then(function(){return G(e,d.rim_im.admin(t,r)).then(function(s){const a=d.db.findChat(e),n=$(e),o=new i.a(a.id,s,d.registrationInfo.regId,new Date,i.a.ReservedTag.Admin,!1,!1,{value:i.a.StateValue.Sent,isPartial:!1},!1,!1,void 0,{regId:t,promotion:r});re(e,o),c.b({messengerData:d,emitFunc:k},a,n,t,void 0,r)}).catch(function(e){return console.error("participantAdmin: promote="+r+" error="+e),Promise.reject(e)})}).catch(function(t){return console.error("Failed to change admin to "+r+" chatId="+e+" error="+t),ee(e,t)})}d.throwIfSipRegistrationFailed(),Object(x.default)(x.default.INFO,"%s: Setup complete for e=%s r=%s",j,S.endpointId,d.registrationInfo.regId),d.transportCallbacks.receive=function(e){d.contentClient.receiveOnlineMessage(e,function(e){d.syncManager.handleOnlineMessage(e)})},e.chatStart=function(e){var t;if("object"!=typeof e)throw new TypeError("options must be an object");if("string"!=typeof e.subject)throw new TypeError("options.subject must be a string");const r=void 0!==e.invitees?e.invitees:[];if(!Array.isArray(r)&&"string"!=typeof r)throw new TypeError("options.invitees must be an array of regIds or a string");if(e.isOneToOne&&1!=r.length&&"string"!=typeof r)throw new ReferenceError("options.invitees must contain exactly one regId when options.isOneToOne is true");const s=!!e.isOneToOne;if(void 0!==e.invitePolicy&&!a.a.InvitePolicy.hasOwnProperty(e.invitePolicy))throw new ReferenceError("options.invitePolicy must be a valid Chat.InvitePolicy or "+`undefined. It is: ${e.invitePolicy}`);let n;if(s){if((n="string"==typeof r?r:r[0])===d.registrationInfo.regId)throw new ReferenceError("options.invitees for OneToOne chat cannot contain own regId");const e=d.db.getPeerPromise(n);if(void 0!==e)return Object(x.default)(x.default.NOTICE,"%s: Already creating 1:1 chat for regId=%s; returning existing promise",j,n),e;const t=d.chatCache.get(d.db.getPeerChatId(n));if(t&&t.state!==a.a.State.Defunct)return Object(x.default)(x.default.NOTICE,"%s: Found existing OneToOne chatId=%s with peerRegId=%s; a new chat will not be started",j,t.chatId,n),Promise.resolve({chat:t,invites:"string"==typeof r?Promise.resolve(n):[Promise.resolve(n)]})}s?Object(x.default)(x.default.INFO,"%s: Creating new 1:1 chat with regId=%s",j,n):Object(x.default)(x.default.INFO,"%s: Creating new chat with regIds=%s",j,r);const o=P.truncate(e.subject,128);let i;if(void 0!==e.data){try{i=new y.b(e.data)}catch(e){throw new TypeError(`Unsupported type in options.data: ${e}`)}if(0===i.length||123!==i.data[0])throw new TypeError("options.data must be a JSON Object or undefined");if(i.length>T.maxApplicationDataSize)throw new ReferenceError(`options.data must not exceed ${T.maxApplicationDataSize} `+`bytes; size=${i.length}`)}const c=w.generateChatKey().then(function(e){t=e;let r=Promise.resolve();if(S.kmsMode){const e=w.generateBytes(12);r=w.authEncrypt(t,e,d.keyManager.mgmtKey).then(t=>({payload:t.content,mac:t.tag,nonce:e}))}return Promise.all([d.rim_im.protectServerSubject(o,t),i?d.rim_im.protectServerData(i.data,t):Promise.resolve(),r])}).then(function(t){return S.requestManager.retryableRequest(function(){return d.managementClient.createMailbox("chat",t[0],!0,b.a.UpdatePolicy.MembersOnly,e.invitePolicy===a.a.InvitePolicy.AdminsOnly?b.a.InvitePolicy.AdminOnly:b.a.InvitePolicy.MembersOnly,s?b.a.Description.OneToOne:b.a.Description.Conference,t[1],t[2])})}).then(function(i){if(Object(x.default)(x.default.INFO,"%s: Successfully created chatId=%s",j,i.id),s){var c=d.chatCache.get(d.db.getPeerChatId(n));if(c&&c.state!==a.a.State.Defunct)return Object(x.default)(x.default.NOTICE,"%s: Found existing OneToOne chatId=%s with peerRegId=%s; new chatId=%s will be discarded",j,c.chatId,n,i.id),Y(i.id),{chat:c,invites:"string"==typeof r?Promise.resolve(n):[Promise.resolve(n)]}}d.keyManager.setChatKey(i.id,t);const u=[];u.push({regId:d.registrationInfo.regId,state:f.a.State.Active,admin:!s}),n&&(u.push({regId:n,state:f.a.State.PendingInvite,admin:!1}),d.db.removePeerPromise(n));const p=d.db.createChat(i.id,l.a.State.Ready,u,s),g=new a.a(i.id,new Date(i.createdTime),s,a.a.State.Ready,o,p.getParticipantExternalViews(),s?void 0:e.invitePolicy===a.a.InvitePolicy.AdminsOnly?a.a.InvitePolicy.AdminsOnly:a.a.InvitePolicy.ParticipantsOnly,void 0,e.data);d.chatCache.set(g),s&&d.db.addPeerChatId(n,i.id),S.filter&&S.filter.add(g.chatId),k("chatAdded",new h.ChatAdded(g)),z(d.registrationInfo.regId,d.rim_im.chatCreated(S.endpointId,g.chatId,t,o,s?{regId:n}:void 0)).catch(function(e){Object(x.default)(x.default.ERROR,"%s: Failed to notify other endpoints of new chatId=%s; error=%s",j,g.chatId,e)});const y={chat:g,invites:L(g,p,t,r)};return s&&(Array.isArray(y.invites)?y.invites[0]:y.invites).catch(function(e){Object(x.default)(x.default.ERROR,"%s: Failed to invite the participan with regId=%s to OneToOne chatId=%s; leaving chat; error=%s",j,n,g.chatId,e),Y(g.chatId).catch(function(e){Object(x.default)(x.default.ERROR,"%s: Failed to leave chatId=%s; error=%s",j,g.chatId,e)})}),y}).catch(e=>(s&&d.db.removePeerPromise(n),Promise.reject(e)));return s&&d.db.addPeerPromise(n,c),c},e.chatInvite=function(e,t){if(Object(x.default)(x.default.INFO,"%s: Processing invite(s) for chatId=%s",j,e),"string"!=typeof t&&!Array.isArray(t))throw new TypeError("invitees must be a regId or an array of regIds");var r=$(e),s=d.db.findChat(e);return r.isOneToOne?Promise.reject(new g.Error("Cannot invite users to join a 1:1 chatId="+e)):r.invitePolicy!==a.a.InvitePolicy.AdminsOnly||s.findParticipant(d.registrationInfo.regId).isAdmin?r.state===a.a.State.Defunct?Promise.reject(new g.Error("Cannot invite users to join a defunct chat chatId="+e)):d.keyManager.getChatKey(r.chatId).then(function(e){return L(r,s,e,t)}):Promise.reject(new g.Error("Non-admin user not allowed to invite users to join chat with invitePolicy="+r.invitePolicy+" chatId="+e))},e.chatUpdate=function(e,t){return c.c({messengerData:d,requestManager:S.requestManager,postFunc:G,emitFunc:k,newMessageFunc:re,errorFunc:te,maxApplicationDataSize:T.maxApplicationDataSize},e,t)},e.getChat=function(e){return $(e)},e.getChats=function(){return d.chatCache.getAll()},e.chatLeave=function(e){return $(e),Y(e,!0).catch(function(t){throw console.error("Failed to leave chatId="+e+"; error="+t),t})},e.participantRemove=function(e,t){if(t===d.registrationInfo.regId)throw new g.Error(`Not allowed to remove local user from chatId=${e}`);const r=$(e),s=d.db.findChat(e);if(r.isOneToOne)throw new g.Error("Not allowed to remove participants from 1:1 chatId="+e);{const t=s.getParticipant(d.registrationInfo.regId);if(!t||!t.isAdmin)throw new g.Error(`Not allowed to remove participants from chatId=${e} `+"when not an admin")}return Object(x.default)(x.default.DEBUG1,"%s: Removing regId=%s from chatId=%s",j,t,e),S.requestManager.retryableRequest(()=>d.managementClient.removeMember(e,t)).catch(t=>{te(e,t,!0)}).then(()=>{Object(x.default)(x.default.INFO,"%s: Removed regId=%s from chatId=%s",j,t,e);const r=d.db.findChat(e);let s=$(e);c.b({messengerData:d,emitFunc:k},r,s,t,f.a.State.Left),Object(x.default)(x.default.DEBUG1,"%s: Sending remove message to chatId=%s for regId=%s",j,e,t);const a=G(e,d.rim_im.remove(t)).then(s=>{Object(x.default)(x.default.INFO,"%s: Sent remove message to chatId=%s for regId=%s",j,e,t);const a=new i.a(r.id,s,d.registrationInfo.regId,new Date,"Remove",!1,!1,{value:i.a.StateValue.Sent,isPartial:!1},!1,!1,void 0,{regId:t});return re(e,a),Promise.resolve()}).catch(r=>(Object(x.default)(x.default.WARNING,"%s: Failed to send remove message to chatId=%s for regId=%s %s",j,e,t,r),Promise.resolve()));Object(x.default)(x.default.DEBUG1,"%s: Sending chatRemoved message to regId=%s",j,t);const n=d.keyManager.getChatKey(e).then(t=>(Object(x.default)(x.default.DEBUG1,"%s: Retrieved chat key for chatId=%s",j,e),w.generateAuthCode(t))).then(r=>(Object(x.default)(x.default.DEBUG1,"%s: Generated auth code for chatId=%s",j,e),z(t,d.rim_im.chatRemoved(e,r.hash,r.encryptedCode)))).then(()=>(Object(x.default)(x.default.INFO,"%s: Sent chatRemoved message to regId=%s",j,t),Promise.resolve())).catch(e=>(Object(x.default)(x.default.WARNING,"%s: Failed to send chatRemoved to regId=%s: %s",j,t,e),Promise.resolve()));return Promise.all([a,n])}).then(()=>(Object(x.default)(x.default.INFO,"%s: Removed regId=%s from chatId=%s",j,t,e),Promise.resolve())).catch(r=>(Object(x.default)(x.default.ERROR,"%s: Failed to remove regId=%s from chatId=%s: %s",j,t,e,r),Promise.reject(new g.Error)))},e.participantPromote=function(e,t){return s(e,t,!0)},e.participantDemote=function(e,t){return s(e,t,!1)},e.isAdmin=function(e,t){return d.db.findChat(e).findParticipant(t).isAdmin},e.getChatMessages=function(e){return $(e),d.db.findChat(e).messages.get()},e.fetchChatMessages=function(e,t){$(e);const s=d.db.findChat(e),a=s.findParticipant(d.registrationInfo.regId);let n;const o=function(e){return e&&void 0!==e.syncMode?e.syncMode:void 0!==r.syncMode?r.syncMode:q.SyncMode.SyncToRead}(t);if(s.state===l.a.State.Restore&&t&&(o===q.SyncMode.SyncToDelivered||o===q.SyncMode.SyncToRead)){let e,t;switch(o){case q.SyncMode.SyncToDelivered:e="deliveredMsgId";break;case q.SyncMode.SyncToRead:e="readMsgId"}n=function(){if(e){if((t=a[e]).isEmpty())return!1;e=void 0}const r=s.messages.earliestMessageId();return r&&r.isLessThanOrEqual(t)}}let i,c,u;if(t&&void 0!==t.minFetchCount){const e=s.messages.length+t.minFetchCount;i=function(){return s.messages.length>=e}}return t&&t.minMessageId&&(c=function(){var e=s.messages.earliestMessageId();return e&&e.isLessThanOrEqual(t.minMessageId)}),void 0!==i&&(u=function(){return!(n&&!n()||i&&!i()||c&&!c())}),C(s,u)},e.getChatMessageState=function(e,t){var r=[];return d.db.findChat(e).participants.forEach(function(e,s){"Active"===e.state&&s!==d.registrationInfo.regId&&(t.isLessThanOrEqual(e.readMsgId)?r.push({regId:s,state:i.a.StateValue.Read}):t.isLessThanOrEqual(e.deliveredMsgId)?r.push({regId:s,state:i.a.StateValue.Delivered}):r.push({regId:s}))}),Promise.resolve(r)},e.getChatMessage=function(e,t){$(e);var r=d.db.findChat(e),s=r.messages.getPosition(t);return s.isDuplicate?Promise.resolve(r.messages.lookup(s.index)):S.requestManager.retryableRequest(function(){return d.contentClient.pull(e,t)}).then(function(r){if(!r.messages&&r.messages.isEmpty())return Promise.reject(new g.NotFoundError("Cannot find message "+t));var s=r.messages[r.messages.length-1];return s.messageId.isEqual(t)?d.rim_im.receive(e,s.userId,s.message.binary).then(function(r){return A(t,e,s.userId,s.timestamp,r).withFileSize()}):Promise.reject(new g.NotFoundError("Cannot find message "+t))}).catch(function(t){return ee(e,t)})},e.chatMessageSend=function(e,t){console.log("Sending a message for chatId="+e);var r=d.db.findChat(e);if(r.state===l.a.State.Leave||r.state===l.a.State.Defunct)throw new g.Error("Invalid chat state "+r.state);if(void 0===t)throw new g.Error("Missing mandatory message param");if("string"!=typeof t.tag)throw new g.Error("message.tag must be a string, not "+typeof t.tag);if(t.tag.length<1)throw new g.Error("Invalid empty message.tag");if(!B(t.tag))throw new g.Error("Invalid reserved message.tag: "+t.tag);var s,a,n=0,o=0,c=0;if(t.content){if("string"!=typeof t.content)throw new g.Error("message.content must be a string, not "+typeof t.content);n=(s=E.encode(t.content)).length}if(t.data){if("object"!=typeof t.data)throw new g.Error("message.data must be a JSON object, not "+typeof t.data);if(123!==(a=new y.b(t.data)).data[0])throw new TypeError("message.data not a JSON object first char is "+a.data[0]);o=a.length}if(t.thumbData){if(!(t.thumbData instanceof Uint8Array||"node"!==D.a&&t.thumbData instanceof Blob))throw new g.Error("message.thumbData must be a Uint8Array or Blob, not "+typeof t.thumbData);if(t.thumbData.length>56320)throw new g.Error("message.thumbData must have size no more than 56320 bytes, it is "+t.thumbData.length);c=t.thumbData.length}if(t.thumbName&&"string"!=typeof t.thumbName)throw new g.Error("message.thumbName must be a string, not "+typeof t.thumbName);var u,p,f=n+o+c;if(f>T.maxApplicationDataSize)throw new g.Error("The combined length of the message content, data, and thumbData "+`must not exceed ${T.maxApplicationDataSize}; `+`content=${n} data=${o} thumbData=${c} `+`total=${f}`);if(t.fileData){if("object"!=typeof t.fileData)throw new g.Error("message.fileData must be an object");if(!(t.fileData.data instanceof Uint8Array||"node"!==D.a&&t.fileData.data instanceof Blob))throw new g.Error("message.fileData.data must be a Uint8Array or Blob, not "+typeof t.fileData.data);if(t.fileData.data.length>q.MaxFileSize)throw new g.Error("message.fileData.data must have size no more than "+q.MaxFileSize+" bytes, it is "+t.fileData.data.length);if(t.fileData.progress&&"function"!=typeof t.fileData.progress)throw new g.Error("message.fileData.progress must be a function");if(t.fileData.name&&"string"!=typeof t.fileData.name)throw new g.Error("message.fileData.name must be a string, not "+typeof t.fileData.name)}if(t.hasOwnProperty("ref")){if(!(t.ref instanceof Array))throw new g.Error("message ref must be an array");const e=new Set;for(const r of t.ref){if(e.has(r.tag))throw new g.Error('message ref contains multiple "'+r.tag+'" tags');if(!(r.messageId instanceof v.a))throw new g.Error("message ref messageId must be an instance of MessageId");e.add(r.tag)}}if(t.fileData){var h=new Promise(function(e){if("node"!==D.a&&t.fileData.data instanceof Blob){var r=new FileReader;r.onload=function(){e(new Uint8Array(r.result))},r.readAsArrayBuffer(t.fileData.data)}else e(t.fileData.data)});u=Promise.all([h.then(function(e){return w.encryptFile(e)}),d.lastUpload]).then(function(e){return d.busClient.uploadFile(d.registrationInfo.regId,e[0].data,t.fileData.progress).then(function(t){return{url:t,key:e[0].key,hash:e[0].hash}})}),d.lastUpload=u}else u=Promise.resolve();return p=t.thumbData?new Promise(function(e){if("node"!==D.a&&t.thumbData instanceof Blob){var r=new FileReader;r.onload=function(){e(new Uint8Array(r.result))},r.readAsArrayBuffer(t.thumbData)}else e(t.thumbData)}):Promise.resolve(),u.then(function(a){return p.then(function(n){t.fileData&&t.fileData&&t.fileData.name&&(a.name=t.fileData.name);var o=d.rim_im.content(t.tag,s,t.data,n,t.thumbName,a,t.ref);return t.fileData&&(a.size=t.fileData.data instanceof Uint8Array?t.fileData.data.byteLength:t.fileData.data.size),G(e,o).then(function(s){const o=new i.a(r.id,s,d.registrationInfo.regId,new Date,t.tag,!1,!1,{value:i.a.StateValue.Sent,isPartial:!1},!1,!1,t.content,t.data,n,t.thumbName,a,t.ref);return re(e,o),o}).catch(function(e){throw console.error("chatMessageSend: failed to send message due to: "+e),e})})})},e.chatMessageRead=function(e,t){if(console.log("Marking messageId="+t+" in chatId="+e+" as read"),!d.db.chats.has(e))throw new g.NotFoundError("Refusing to post read status to unknown chatId="+e);if(!(t instanceof v.a)||0===t.length)throw TypeError("messageId must be a non-empty instance of MessageId");return X(e,void 0,t)},e.getUnreadCount=function(e){$(e);const t=d.db.findChat(e),r=t.findParticipant(d.registrationInfo.regId);return C(t,()=>{const e=t.messages.earliestMessageId();return!r.readMsgId.isEmpty()&&e&&e.isLessThanOrEqual(r.readMsgId)}).then(()=>{let e=0;const s=t.messages.getPosition(r.readMsgId);let a=t.messages.getMessages();for(let e=0;e<s.index;++e)a.next();s.isDuplicate&&a.next();for(let t of a)t.isIncoming&&++e;return e})},e.chatMessageWatch=function(e,t,r){d.db.findChat(e).messages.setWatcher(t,r)},e.chatMessageUnwatch=function(e,t,r){d.db.findChat(e).messages.unsetWatcher(t,r)},e.chatMessageDestroy=function(e,t){if(void 0===d.chatCache.get(e))throw new g.NotFoundError(`Refusing to destroy messages in unknown chatId=${e}`);let r,s;try{r=d.db.findChat(e)}catch(t){throw new g.NotFoundError(`Refusing to destroy messages in unknown chatId=${e}: ${t}`)}Object(R.default)(void 0!==r);let a={};if(void 0!==t){if(!(t instanceof v.a))throw new g.Error(`Refusing to destroy invalid messageId=${t} in `+`${r}`);const e=r.messages.getMessage(t);if(void 0===e)throw new g.NotFoundError(`Refusing to destroy unknown messageId=${t} in `+`${r}`);if(e.isIncoming)throw new g.Error(`Refusing to destroy inbound messageId=${t} in `+`${r}`);if(!B(e.tag))throw new g.Error(`Refusing to destroy non-content messageId=${t} `+`with tag=${e.tag} in ${r}`);s=d.rim_im.recall([t.binary]),a.replaces=[t]}else{s=d.rim_im.shred();const e=r.shredMessages.get(d.registrationInfo.regId);a.replacesAll=void 0!==e?e:new v.a}return G(e,s,a).then(r=>{const s=d.db.getChat(e);if(void 0===s)return Promise.resolve();if(void 0!==t){const r=s.messages.getMessage(t);if(void 0===r)return Promise.resolve();const a=r.recalled();s.messages.replace(a),k("chatMessageUpdated",new h.ChatMessageUpdated($(e),a))}else{K(e,r,d.registrationInfo.regId);const t=new i.a(s.id,r,d.registrationInfo.regId,new Date,i.a.ReservedTag.Shred,!1,!1,{value:i.a.StateValue.Sent,isPartial:!1},!1,!1);re(e,t)}return Promise.resolve()}).catch(e=>(Object(x.default)(x.default.WARNING,"Failed to destroy "+`${t?"messageId="+t:"all messages"} `+`in ${r}: ${e}`),Promise.reject(e)))},e.chatMessageRecall=function(e,t){if(void 0===d.chatCache.get(e))throw new g.NotFoundError("Refusing to recall from unknown chatId="+e);var r=d.db.findChat(e),s=r.messages.getPosition(t);if(!s.isDuplicate)throw new g.NotFoundError("Cannot recall unknown message="+t+" from chatId="+e);var a=r.messages.lookup(s.index);if(a.isIncoming)throw new g.Error("Ignoring request to recall inbound message="+t);if(!B(a.tag))throw new g.Error("Cannot recall message with tag="+a.tag);return G(e,d.rim_im.recall([t.binary])).then(function(){var t=a.recalled();r.messages.replace(t),k("chatMessageUpdated",new h.ChatMessageUpdated($(e),t))}).catch(function(e){return console.error("chatMessageRecall: failed to send due to: "+e),Promise.reject(e)})},e.chatMessageDelete=function(e,t){var r=d.db.findChat(e),s=r.messages.getPosition(t);if(!s.isDuplicate)throw new g.NotFoundError("Cannot delete unknown message="+t+" from chatId="+e);var a=r.messages.lookup(s.index).deleted();return r.messages.replace(a,s.index),k("chatMessageUpdated",new h.ChatMessageUpdated($(e),a)),G(e,d.rim_im.delete([t.binary])).then(function(){}).catch(function(e){return console.error("chatMessageDelete: failed to send due to: "+e),Promise.reject(e)})},e.chatShred=function(e){if(void 0===d.chatCache.get(e))throw new g.NotFoundError("Refusing to shred from unknown chatId="+e);var t=d.db.findChat(e);return G(e,d.rim_im.shred()).then(function(r){K(e,r,d.registrationInfo.regId);var s=new i.a(t.id,r,d.registrationInfo.regId,new Date,i.a.ReservedTag.Shred,!1,!1,{value:i.a.StateValue.Sent,isPartial:!1},!1,!1);re(e,s)}).catch(function(e){return console.error("chatShred: failed to send due to: "+e),Promise.reject(e)})},e.getTypingUsers=function(e){if(void 0===d.chatCache.get(e))throw new g.Error("No chat known with id: "+e);const t=d.db.findChat(e),r=[];return t.typingUsers.forEach((e,s)=>{try{const e=t.getParticipant(s);N(e)&&r.push(e.externalView)}catch(e){console.warn("Failed to add typing user for regId="+s+" error="+e)}}),r},e.chatTyping=function(e,t,r){if(void 0===d.chatCache.get(e))throw new g.Error(`No chat known with id: ${e}`);if("string"==typeof t){if(r&&(!(r instanceof v.a)||0===r.length))throw TypeError("messageId must be a non-empty instance of MessageId")}else if(t)throw TypeError("tag must be a string");const s=r?r.binary:void 0;return G(e,d.rim_im.typing(t,s),{onlineOnly:!0}).then(()=>{}).catch(e=>(console.error(`chatTyping: failed to send due to: ${e}`),Promise.reject(e)))};var n=Promise.resolve();return e.filterAdd=function(e){if(!S.filter)throw new g.Error("Cannot add to filter list when not in filtered mode");S.filter.add(e);{const t=d.chatCache.get(e);if(void 0!==t)return Promise.resolve(t)}return new Promise(function(t,r){d.mailboxFetcher.fetchAndStore(e).then(e=>{t(e)}).catch(s=>{s instanceof g.Forbidden||s instanceof g.NotFound?(Object(x.default)(x.default.NOTICE,"%s: User is not yet a participant in chatId=%s; checking for outstanding grants",j,e),n=n.then(function(){var a=d.chatCache.get(e);return void 0!==a?(t(a),Promise.resolve()):W().then(function(){const a=d.chatCache.get(e);void 0===a?(Object(x.default)(x.default.NOTICE,"%s: There was no grant outstanding for chatId=%s; user has not yet been invited to join the chat",j,e),r(s)):t(a)}).catch(function(e){Object(x.default)(x.default.ERROR,"%s: Failed to get outstanding grants: %s",j,e),r(e)})})):r(s)})})},e.filterRemove=function(e){if(!S.filter)throw new g.Error("Cannot remove from filter list when not in filtered mode");S.filter.has(e)&&(S.filter.delete(e),Z(e))},e.getMessageStorageFactory=function(){return d.db.messageStorageFactory},e.chatParticipantTimesGet=function(e,t){const r=d.db.findChat(e),s=[];function a(e){return 0===e?void 0:new Date(1e3*e)}function n(e){e.state!==f.a.State.Left&&s.push({regId:e.regId,delivered:a(e.deliveredTimestamp),read:a(e.readTimestamp)})}if(void 0===t){for(const e of r.participants.values())n(e);return s}if(!Array.isArray(t))throw new TypeError("The regIds argument must be an array of strings");for(const e of t){if("string"!=typeof e)throw new TypeError("The regIds argument must be an array of strings");const t=r.getParticipant(e);void 0!==t&&n(t)}return s},t});function k(t,r){x.default.debug(x.default.DEBUG2,"%s: Emitting %s: %s",j,t,JSON.stringify(r));try{e.emit(t,r),Object(x.default)(x.default.INFO,"%s: Emitted %s event",j,t)}catch(e){Object(x.default)(x.default.ERROR,"%s: Error emitting %s event: %s",j,t,e)}}function C(e,t){if(e.synced)return Promise.resolve(e.messages.get());var r=e.id;function s(){var e;try{(e=d.db.findChat(r)).state!==l.a.State.Left&&e.state!==l.a.State.Defunct||(e=void 0)}catch(e){}return e}var n=Promise.resolve();return function a(){var o=[];return d.syncManager.restore(r,e.nextPullPoint,function(e){o.push(d.rim_im.receive(e.mailboxId,e.messageData.userId,e.messageData.message.binary).then(function(t){return{envelope:e.messageData,message:t}}).catch(function(e){console.error("Failed to restore message; error="+e)}))},function(e){let r=s();if(void 0===r)return!0;var a=o;return n=n.then(function(){return Promise.all(a).then(function(e){let t=s();return void 0!==t?function(e,t){let r=[];for(const s of t){if(!s)continue;const t=s.envelope,a=s.message.body;switch(Object(x.default)(x.default.INFO,'%s: Received "%s": %s in chatId=%s v=%s',j,s.message.name,t,e.id,s.message.verified||!1),s.message.name){case"status":{let r={messageId:t.messageId,regId:t.userId,status:a,timestamp:t.timestamp};for(const t of H(e,[r]))k("chatMessageUpdated",new h.ChatMessageUpdated($(e.id),t));continue}case"join":try{let r=A(t.messageId,e.id,t.userId,t.timestamp,s.message),a=e.messages.insertOne(r,s.message.body.inviteId);a&&k("chatMessageUpdated",new h.ChatMessageUpdated($(e.id),a))}catch(t){console.log('Ignoring "join" message for chatId='+e.id+"; "+t)}void 0===e.getParticipant(t.userId)&&e.createParticipant(t.userId,f.a.State.Left,!1);continue;case"recall":U(e.id,a.ids,t.userId);continue;case"shred":K(e.id,t.messageId,t.userId);break;case"delete":_(e.id,a.ids,t.userId);continue;case"metadataChanged":{const r=void 0===s.message.body.changes?"":s.message.body.changes;Object(x.default)(x.default.INFO,"%s: Handling metadataChanged[%s] from regId=%s for %s",j,r,t.userId,e),d.mailboxFetcher.fetchAndStore(e.id,!0);continue}}const n=A(t.messageId,e.id,t.userId,t.timestamp,s.message);r.push(n),e.processPulledReferences(n,r)}r=r.map(function(t){if(e.deletedMessages.has(t.messageId.binary.toString()))return Object(x.default)(x.default.INFO,"Received messageId=%s was deleted",t.messageId),t.deleted();const r=e.recalledMessages.get(t.messageId.binary.toString()),s=e.shredMessages.get(t.sender);return B(t.tag)&&(r&&-1!==r.indexOf(t.sender)||s&&!s.isLessThan(t.messageId))?(Object(x.default)(x.default.INFO,"Received messageId=%s was recalled",t.messageId),t.recalled()):t}),Promise.all(r.map(e=>e.withFileSize())).then(t=>{H(e,[],t[Symbol.iterator]()),e.messages.union(t,!1),k("chatMessageListUpdated",new h.ChatMessageListUpdated($(e.id),e.messages.get()))}),Object(x.default)(x.default.DEBUG1,"%s: Processed %d pulled messages; %d control, %d non-control",j,t.length,t.length-r.length,r.length)}(t,e):Promise.reject(new g.PermanentFailure("Chat has been left"))})}),o=[],r.nextPullPoint=e,!!t}).then(function(){return t?n.then(function(){let e=s();return void 0===e?Promise.reject(new g.PermanentFailure("Chat has been left")):t()||void 0===e.nextPullPoint?Promise.resolve():a()}):Promise.resolve()})}().then(function(){return n}).then(function(){let e=s();if(void 0===e)return Promise.reject(new g.PermanentFailure("Chat has been left"));if(void 0===e.nextPullPoint&&(e.synced=!0),e.state===l.a.State.Ready)return e.messages.get();e.state=l.a.State.Ready,Q(d.chatCache.get(r),a.a.State.Ready);var t=e.messages.latestMessageId();return t&&X(r,t).catch(function(e){console.error("Failed to post delivery notification for messageId="+t+"; error="+e)}),e.messages.get()}).catch(function(e){throw Object(x.default)(x.default.ERROR,"%s: Failed to fetch all messages for chatId=%s; error=%s",j,r,e),e})}function A(e,t,r,s,a){const n=r!==d.registrationInfo.regId;let o,c,l,u,p,f,h=null;const y=d.db.findChat(t),m=a.body;switch(a.name){case"content":if(h=m.tag,o=m.content,c=m.data,l=m.thumb,u=m.thumbName,p=m.attach,m.ref){f=[];for(const e of m.ref)f.push({tag:e.tag,messageId:new v.a(e.messageId)})}break;case"subject":h=i.a.ReservedTag.Subject,o=m.subject;break;case"join":h=i.a.ReservedTag.Join;break;case"leave":h=i.a.ReservedTag.Leave;break;case"shred":h=i.a.ReservedTag.Shred;break;case"remove":h=i.a.ReservedTag.Remove,c=m;break;case"admin":h=i.a.ReservedTag.Admin,c=m;break;default:throw new g.Error('Received unsupported non-identity message "'+a.name+'"')}return new i.a(y.id,e,r,new Date(1e3*s),h,n,!a.verified,{value:n?i.a.StateValue.Delivered:i.a.StateValue.Sent,isPartial:!1},!1,!1,o,c,l,u,p,f)}function U(e,t,r){var s=d.db.findChat(e);t.forEach(function(t){var a=new v.a(t);if(s){var n=s.messages.getPosition(a);if(n.isDuplicate){var o=s.messages.lookup(n.index);if(B(o.tag)&&o.sender===r){var i=s.messages.lookup(n.index).recalled();s.messages.replace(i),k("chatMessageUpdated",new h.ChatMessageUpdated($(e),i))}}s.recalledMessages.has(a.binary.toString()),s.recalledMessages.set(a.binary.toString(),r)}})}function _(e,t,r){if(r===d.registrationInfo.regId){var s=d.db.findChat(e);t.forEach(function(t){var r=new v.a(t),a=s.messages.getPosition(r);if(a.isDuplicate){var n=s.messages.lookup(a.index);if(n.isDeleted)Object(x.default)(x.default.INFO,"%s: Ignoring delete for messageId=%s; already deleted",j,t);else{var o=n.deleted();s.messages.replace(o),k("chatMessageUpdated",new h.ChatMessageUpdated($(e),o))}}else Object(x.default)(x.default.INFO,"%s: Ignoring delete for messageId=%s; not found",j,t);s.deletedMessages.add(r.binary.toString())})}else Object(x.default)(x.default.INFO,"%s: Ignoring delete message received from another identity",j)}function K(e,t,r){var s=d.db.findChat(e),a=s.shredMessages.get(r);if(!a||a.isLessThan(t)){s.shredMessages.set(r,t);var n=[];for(let e of s.messages.getMessages())e.sender===r&&B(e.tag)&&n.push(e.recalled());s.messages.union(n,!0),k("chatMessageListUpdated",new h.ChatMessageListUpdated($(e),s.messages.get()))}}function G(e,t,r){const s=E.decode(t.subarray(1,t.findIndex(e=>58===e)));Object(x.default)(x.default.DEBUG1,"%s: Sending %s message to chatId=%s",j,s,e);const a=d.rim_im.protectChat(e,t);function n(){return a.then(t=>d.syncManager.post(e,t,r))}return(r&&!0===r.onlineOnly?n():S.requestManager.retryableRequest(n)).then(r=>(Object(x.default)(x.default.INFO,"%s: Sent %s message to m=%s M=%s",j,s,e,r),x.default.debug(x.default.DEBUG2,"%s: Sent to m=%s M=%s: %s",j,e,r,y.e(t)),r)).catch(t=>(Object(x.default)(x.default.ERROR,"%s: Failed to post protected %s message to chatId=%s; error=%s",j,s,e,t),ee(e,t)))}function z(e,t){const r=E.decode(t.subarray(1,t.findIndex(e=>58===e)));Object(x.default)(x.default.DEBUG1,"%s: Sending identity %s message to regId=%s",j,r,e);const s=d.rim_im.protectUser(e,t);return S.requestManager.retryableRequest(()=>s.then(t=>{const r="id."+e;return d.syncManager.post(r,t)})).then(s=>(Object(x.default)(x.default.INFO,"%s: Sent identity %s message to regId=%s M=%s",j,r,e,s),x.default.debug(x.default.DEBUG2,"%s: Sent to regId=%s M=%s: %s",j,e,s,y.e(t)),s)).catch(t=>{throw Object(x.default)(x.default.ERROR,"%s: Failed to post protected identity %s message to regId=%s; error=%s",j,r,e,t),t})}function W(){return S.filter&&0===S.filter.size?Promise.resolve():S.requestManager.retryableRequest(function(){return d.throwIfSipRegistrationFailed&&d.throwIfSipRegistrationFailed(),d.managementClient.getAllMailboxGrants()}).then(function(e){var t=[];return e.forEach(function(e){!S.filter||S.filter.has(e.mailboxId)?t.push(d.rim_im.receive("id."+d.registrationInfo.regId,e.sender,e.data).then(function(t){return"invite"!==t.name?(console.error("Dropping grant for chatId="+e.mailboxId+" with an unsupported message type="+t.name),Promise.resolve()):(console.log("Processing grant invite="+JSON.stringify(t)),F.a.digest(F.a.DigestAlgorithm.SHA512,e.data).then(function(r){return V(t.body,e.sender,new Uint8Array(r))}))}).catch(function(t){console.error("Failed to process grant for chatId="+e.mailboxId+" from regId="+e.sender+"; error="+t)})):console.log("Ignoring grant for chatId="+e.mailboxId+" that is not in filter set")}),Promise.all(t)})}function L(e,t,r,s){var a=d.rim_im.invite(e.chatId,e.subject,!e.isOneToOne,r,F.a.getRandomValues(new Uint8Array(32)));function n(r,s){if(Object(x.default)(x.default.INFO,"%s: Sending invite to regId=%s for chatId=%s",j,r,e.chatId),"string"!=typeof r||0===r.length)return Promise.reject(new TypeError("invitees"+(void 0!==s?"["+s+"]":"")+" must be a non-empty string; regId="+JSON.stringify(r)));if(r===d.registrationInfo.regId)return Promise.reject(new ReferenceError("Cannot send invite to own regId"));let n=!1;const o=t.getParticipant(r);void 0===o?(Object(x.default)(x.default.INFO,"%s: Inviting regId=%s to join chatId=%s",j,r,e.chatId),n=!0):o.state!==f.a.State.Left&&null!==o.externalView?Object(x.default)(x.default.INFO,"%s: Inviting %s to join chatId=%s",j,o.externalView,e.chatId):(Object(x.default)(x.default.INFO,"%s: Inviting regId=%s to re-join chatId=%s",j,r,e.chatId),n=!0),n&&(e=c.b({messengerData:d,emitFunc:k},t,e,r,f.a.State.PendingInvite,!1));var i=d.rim_im.protectUser(r,a);return S.requestManager.retryableRequest(function(){return i.then(function(t){return Object(x.default)(x.default.INFO,"%s: Granting regId=%s access to chatId=%s",j,r,e.chatId),d.managementClient.grant(e.chatId,r,t).catch(function(t){te(e.chatId,t,!0)})})}).then(function(){return Object(x.default)(x.default.INFO,"%s: Access granted to chatId=%s for regId=%s",j,e.chatId,r),z(r,a)}).then(function(){const s=t.findParticipant(r);if(s.state===f.a.State.PendingInvite){const s=d.chatCache.get(e.chatId);c.b({messengerData:d,emitFunc:k},t,s,r,f.a.State.PendingJoin)}else Object(x.default)(x.default.NOTICE,"%s: Not changing state for %s to PendingJoin in chatId=%s",j,s,e.chatId);return r}).catch(function(t){throw Object(x.default)(x.default.ERROR,"%s: Failed to grant access to chatId=%s for regId=%s; error=%s",j,e.chatId,r,t),t})}if("string"==typeof s)return n(s);var o=[];return s.forEach(function(e,t){o.push(n(e,t))}),o}function $(e){var t=d.chatCache.get(e);if(void 0===t)throw new g.NotFoundError('Cannot getChat: chatId="'+e+'" not found');return t}function V(e,t,r){if(!(e.symmetricKey instanceof Uint8Array)||0===e.symmetricKey.length)return Promise.reject(new g.Error("Bad symmetricKey="+e.symmetricKey));var s=d.chatCache.get(e.mailboxId);if(void 0!==s)return console.log("Ignoring invite to join known "+s),Promise.resolve();if(S.filter&&!S.filter.has(e.mailboxId))return console.log("Ignoring invite to join mailbox "+e.mailboxId+" which is not in the filter list"),Promise.resolve();if(Object(x.default)(x.default.INFO,"%s: Accepting invite to join %schatId=%s from regId=%s",j,e.isConference?"":"OneToOne ",e.mailboxId,t),!e.isConference){const r=d.chatCache.get(d.db.getPeerChatId(t));if(r&&r.state!==a.a.State.Defunct&&(console.log("Leaving "+r+" in favour of chatId="+e.mailboxId+" from peer="+t),Y(r.chatId).catch(function(e){console.error("Failed to leave "+r+"; error="+e)})),void 0!==d.db.getPeerPromise(t))return Object(x.default)(x.default.NOTICE,"%s: Already creating 1:1 chat with regId=%s; ignoring invite for duplicate 1:1 chat mailboxId=%s",j,t,e.mailboxId),Promise.reject(new g.Error("Duplicate 1:1"))}let n=d.db.createChat(e.mailboxId,l.a.State.Joining,[{regId:d.registrationInfo.regId,state:f.a.State.Active,admin:!1},{regId:t,state:f.a.State.Active,admin:!1}],!e.isConference);n.inviteId=void 0!==e.inviteId?e.inviteId:r,Object(R.default)(void 0!==n.inviteId,"chatData.inviteId must be defined");return(()=>{if(S.kmsMode){const t=w.generateBytes(12);return w.authEncrypt(e.symmetricKey,t,d.keyManager.mgmtKey).then(r=>S.requestManager.retryableRequest(()=>d.managementClient.join(e.mailboxId,{payload:r.content,mac:r.tag,nonce:t})))}return S.requestManager.retryableRequest(()=>d.managementClient.join(e.mailboxId))})().then(function(){return n.state=l.a.State.Restore,d.keyManager.setChatKey(e.mailboxId,e.symmetricKey),Object(x.default)(x.default.INFO,'%s: Posting "join" message after successfully joining chatId=%s',j,n.id),G(e.mailboxId,d.rim_im.join(n.inviteId))}).then(function(){let r=d.db.findChat(e.mailboxId);if(!e.isConference){var n=d.chatCache.get(d.db.getPeerChatId(t));if(n&&n.state!==a.a.State.Defunct)return n.chatId===e.mailboxId?void Object(R.default)(!1):(console.log("Found existing OneToOne chatId="+n.chatId+" with peerRegId="+t+"; invite to chatId="+e.mailboxId+" will be discarded"),void Y(e.mailboxId))}r.inviteId=new Uint8Array([]),s=new a.a(e.mailboxId,new Date(0),!e.isConference,a.a.State.Waiting,P.truncate(e.subject,128),r.getParticipantExternalViews(),e.isConference?a.a.InvitePolicy.ParticipantsOnly:void 0),d.chatCache.set(s),s.isOneToOne&&d.db.addPeerChatId(t,s.chatId),Object(x.default)(x.default.INFO,'%s: Successfully posted "join" to %s',j,s),k("chatAdded",new h.ChatAdded(s)),d.mailboxFetcher.fetchAndStore(e.mailboxId,!0)})}function J(e,t){function r(e){Object(x.default)(x.default.INFO,"%s: Received chatRemoved message for mailboxId=%s; removing chat",j,e),Z(e),d.mailboxFetcher.fetchAndStore(e,!0)}"system"===t?r(e.mailboxId):d.keyManager.getChatKey(e.mailboxId).then(t=>w.verifyAuthCode(e.encryptedAuthCode,e.authCode,t)).then(t=>{t?r(e.mailboxId):console.log("Ignoring chatRemoved due to authCode mismatch")}).catch(e=>{console.error("Ignoring chatRemoved due to crypto failure; error="+e)})}function H(e,t,r){Object(x.default)(x.default.DEBUG1,"%s: Processing %d status messages for %s",j,t.length,e),d.db.updateChatAndParticipantStateData(e,t);const s=e.participants.get(d.registrationInfo.regId),a=[];function n(e,t){e.state.value===t.value&&e.state.isPartial===t.isPartial||a.push(e.withNewState(t))}r||(r=e.messages.getMessages());for(const t of r)if((t.state.value!==i.a.StateValue.Read||!1!==t.state.isPartial)&&t.state.value!==i.a.StateValue.Failed)if(t.isIncoming){if(t.messageId.isLessThanOrEqual(s.readMsgId)){n(t,{value:i.a.StateValue.Read,isPartial:!1});continue}n(t,{value:i.a.StateValue.Delivered,isPartial:!1})}else t.messageId.isLessThanOrEqual(e.fullReadMsgId)?n(t,{value:i.a.StateValue.Read,isPartial:!1}):t.messageId.isLessThanOrEqual(e.partialReadMsgId)?n(t,{value:i.a.StateValue.Read,isPartial:!0}):t.messageId.isLessThanOrEqual(e.fullDeliveredMsgId)?n(t,{value:i.a.StateValue.Delivered,isPartial:!1}):t.messageId.isLessThanOrEqual(e.partialDeliveredMsgId)&&n(t,{value:i.a.StateValue.Delivered,isPartial:!0});return e.messages.union(a,!0),a}function X(e,t,r){Object(x.default)(x.default.INFO,'%s: Sending "status" message for chatId=%s d=%s r=%s',j,e,t,r);const s=d.db.findChat(e);if(s.state!==l.a.State.Ready)return Promise.resolve();const a=s.findParticipant(d.registrationInfo.regId);let n=a.deliveredMsgId,o=a.readMsgId;return H(s,[{messageId:new v.a,regId:d.registrationInfo.regId,status:{d:t?t.binary:t,r:r?r.binary:r},timestamp:d.getCurrentTimestamp()}]).forEach(function(t){k("chatMessageUpdated",new h.ChatMessageUpdated(e,t))}),n.isEqual(a.deliveredMsgId)&&o.isEqual(a.readMsgId)?(console.log('Skipping "status" message send; messageIds did not change'),Promise.resolve()):(n=a.deliveredMsgId,o=a.readMsgId,G(e,d.rim_im.status(o.isGreaterThanOrEqual(n)||0===n.length?void 0:n.binary,0===o.length?void 0:o.binary),{pushAsStatus:!0,replaces:0===s.statusMessageId.length?[]:[s.statusMessageId]}).then(function(e){s.statusMessageId=e}))}function Q(e,t){if(e.state===t||void 0===d.chatCache.get(e.chatId))return e;Object(x.default)(x.default.DEBUG1,"%s: Updating chatId=%s to state=%s",j,e.chatId,t);var r=e.withNewState(t);if(t===a.a.State.Defunct&&e.isOneToOne){const t=e.participants[0].regId===d.registrationInfo.regId?e.participants[1].regId:e.participants[0].regId;d.db.removePeerChatId(t,e.chatId)}if(t===a.a.State.Ready){var s=d.db.findChat(e.chatId),n=s.messages.latestMessage();n&&(r=r.withNewActivity(n.timestamp))}return d.chatCache.set(r),k("chatUpdated",new h.ChatUpdated(r)),r}function Y(e,t=!1){if(e.startsWith("id"))return Promise.reject(new g.Error("Refusing to leave identity mailbox="+e));let r=t;const s=d.db.getChat(e);void 0!==s&&(s.state=l.a.State.Leave);let n=d.chatCache.get(e);void 0===n?r=!0:(n=Q(n,a.a.State.Defunct),(void 0===s||s.messages.isEmpty())&&(r=!0)),Object(x.default)(x.default.INFO,"%s: Leaving %schat mailboxId=%s",j,!0===r?"and removing ":"",e);var o=d.rim_im.protectChat(e,d.rim_im.leave());return S.requestManager.retryableRequest(function(){return o.catch(function(t){if(t instanceof g.NotFoundError)return Object(x.default)(x.default.INFO,"%s: Cannot protect leave message for chatId=%s; posting message unprotected; key not found",j,e),d.rim_im.leave();throw t}).then(function(t){return d.syncManager.post(e,t)})}).catch(function(t){t instanceof g.NotFound||t instanceof g.Forbidden||console.error("Failed to post leave notification to chatId="+e+"; error="+t)}).then(function(){return S.requestManager.retryableRequest(function(){return d.managementClient.removeMember(e,d.registrationInfo.regId)})}).catch(function(t){t instanceof g.NotFound||t instanceof g.Forbidden||console.error("Failed to leave chat chatId="+e+"; error="+t)}).then(function(){return d.syncManager.mailboxHasBeenLeft(e),z(d.registrationInfo.regId,d.rim_im.chatLeft(S.endpointId,e,!!t||void 0)).catch(function(t){console.error("Failed to notify other endpoints that chatId="+e+" has been left; error="+t)}),Object(x.default)(x.default.INFO,"%s: Successfully left chatId=%s",j,e),!0===r&&Z(e),n})}function Z(e){if(Object(x.default)(x.default.INFO,"%s: Removing local data for chatId=%s",j,e),void 0!==d.chatCache){const t=d.chatCache.get(e);if(void 0!==t){if(t.isOneToOne){const r=t.participants[0].regId===d.registrationInfo.regId?t.participants[1].regId:t.participants[0].regId;d.db.removePeerChatId(r,e)}d.chatCache.remove(e),k("chatRemoved",new h.ChatRemoved(t))}}d.db.removeChat(e),d.syncManager.mailboxHasBeenLeft(e),d.keyManager.removeChatKey(e)}function ee(e,t){if(t instanceof g.Forbidden)throw d.mailboxFetcher.fetchAndStore(e,!0),t;te(e,t)}function te(e,t,r){if(e.startsWith("id."))throw t;switch(t.name){case"BBMEnterprise.Error.Forbidden":if(r)throw d.mailboxFetcher.fetchAndStore(e,!0),t;case"BBMEnterprise.Error.NotFound":var s=d.chatCache.get(e),n=d.db.findChat(e);s&&n&&!n.messages.isEmpty()?(console.log("Marking chatId="+e+" defunct due to network error="+t),Q(s,a.a.State.Defunct)):(console.log("Removing chatId="+e+" due to network error="+t),Z(e))}throw t}function re(e,t){var r=d.db.findChat(e);se(t,r.messages.replace(t)===u.a.InsertionResult.Inserted)}function se(t,r){let s=$(t.chatId);const a=s.lastActivity;if((s=s.withNewActivity(t.timestamp)).lastActivity!==a&&(d.chatCache.set(s),k("chatUpdated",new h.ChatUpdated(s))),r){k("chatMessageAdded",new h.ChatMessageAdded(s,t));const r=d.db.findChat(t.chatId),a=r.processSingleReferences(t);for(const t of a){const s=r.messages.getMessage(t);e.emit("chatMessageUpdated",new h.ChatMessageUpdated(e.getChat(s.chatId),s))}}else k("chatMessageUpdated",new h.ChatMessageUpdated(s,t))}},t.shutdown=function(e){A(e)};var s=r(35),a=r(17),n=r(64),o=r(65),i=r(42),d=r(27),c=r(41),l=r(28),u=r(45),p=r(67),f=r(12),g=r(0),h=r(7),y=r(6),m=r(68),b=r(10),I=r(72),v=r(5),M=r(73),w=r(4),O=r(47),R=r(3),P=r(2),E=r(9),x=r(1),S=r(22),F=r.n(S),j=r(24),D=r.n(j),k=r(13),C=r.n(k);const T={maxApplicationDataSize:71680};function q(){C.a.apply(this),A(this)}function B(e){switch(e){case i.a.ReservedTag.Join:case i.a.ReservedTag.Leave:case i.a.ReservedTag.Subject:case i.a.ReservedTag.Shred:case i.a.ReservedTag.Gap:case i.a.ReservedTag.Admin:case i.a.ReservedTag.Remove:return!1}return!0}function A(e){var t;U.forEach(t=>{e[t=t]=(()=>{throw new g.Error("Cannot call "+t+": setup is not complete")})})}function N(e){return void 0!==e&&null!==e.externalView&&e.state!==f.a.State.Left}Object.freeze(T),q.prototype=Object.create(C.a.prototype),q.Chat=a.a,q.ChatMessage=i.a,q.Participant=d.a,q.MessageId=v.a,q.SyncMode={NoSync:0,SyncToDelivered:1,SyncToRead:2},Object.defineProperty(q,"MaxFileSize",{enumerable:!0,value:134217728});var U=["chatStart","chatInvite","chatUpdate","getChat","getChats","chatLeave","participantRemove","participantPromote","participantDemote","isAdmin","getChatMessages","fetchChatMessages","getChatMessageState","getChatMessage","chatMessageSend","chatMessageRead","chatMessageRecall","chatMessageDelete","chatShred","getTypingUsers","chatTyping","filterAdd","filterRemove","getMessageStorageFactory","getUnreadCount","chatMessageWatch","chatMessageUnwatch","chatParticipantTimesGet","getAllEndpoints","deleteEndpoint","getIdentities","chatMessageDestroy"]},function(e,t,r){"use strict";t.a=function(e,t){return function e(t,r,s={left:new Set,right:new Set}){if(s.left.has(t)||s.right.has(r))throw TypeError("JSON objects cannot contain circular references");function a(e){switch(typeof e){case"number":if(!Number.isFinite(e))throw new TypeError(`Invalid JSON value encountered: ${e}`);return;case"boolean":case"string":case"object":return;default:throw new TypeError(`Invalid JSON type encountered: ${typeof e}`)}}if(t===r)return a(t),!0;switch(typeof t){case"number":if(!Number.isFinite(t))throw new TypeError(`Invalid JSON value encountered: ${t}`);case"boolean":case"string":return a(r),!1;case"object":{if(a(r),"object"!=typeof r)return!1;if(null===t||null===r)return!1;if(Array.isArray(t)){if(!Array.isArray(r)||t.length!==r.length)return!1;const a={left:new Set(s.left).add(t),right:new Set(s.right).add(r)};for(let s=0;s<t.length;++s)if(!e(t[s],r[s],a))return!1;return!0}if(Array.isArray(r))return!1;const n=Object.keys(t);if(n.length!==Object.keys(r).length)return!1;const o={left:new Set(s.left).add(t),right:new Set(s.right).add(r)};for(const s of n)if(!r.hasOwnProperty(s)||!r.propertyIsEnumerable(s)||!e(t[s],r[s],o))return!1;return!0}default:throw new TypeError(`Invalid JSON type encountered: ${typeof t}`)}}(e,t)}},function(e,t,r){"use strict";t.b=function(e,t,r,s,a,o){let d=!1;const c=t.getParticipant(s);if(void 0!==c)void 0!==a&&(c.state=a),void 0!==o&&(c.isAdmin=o),d=c.updateExternalView();else{const e=t.createParticipant(s,a||n.a.State.PendingInvite,o||!1);d=null!==e.externalView}d&&(r=r.withNewParticipants(t.getParticipantExternalViews()),e.messengerData.chatCache.set(r),e.emitFunc("chatUpdated",new i.ChatUpdated(r)));e.messengerData.mailboxFetcher.fetching(t.id)&&e.messengerData.mailboxFetcher.fetchAndStore(t.id,!0);return r},t.c=function(e,t,r){Object(u.default)(u.default.INFO,"%s: Processing update for chatId=%s",g,t);const n=e.messengerData.chatCache.get(t);if(void 0===n)throw new o.Error("No chat known with id: "+t);if("object"!=typeof r)throw new o.Error("update must be an object");const h=[Promise.resolve(),Promise.resolve()];let y,m,b,I=!1;if(void 0!==r.subject){if("string"!=typeof r.subject)throw new o.Error("subject must be a string");const s=p.truncate(r.subject,128);s!==n.subject&&(I=!0,y=s,u.default.debug(u.default.DEBUG1,"%s: Protecting subject=%s",g,y),h[0]=e.messengerData.keyManager.getChatKey(t).then(t=>e.messengerData.rim_im.protectServerSubject(y,t)))}if(void 0!==r.invitePolicy){if(!s.a.InvitePolicy.hasOwnProperty(r.invitePolicy))throw new o.Error("invitePolicy must be a valid Chat.InvitePolicy");n.isOneToOne?Object(u.default)(u.default.NOTICE,"%s: Ignoring invitePolicy update for OneToOne chatId=%s",g,n.chatId):r.invitePolicy!==n.invitePolicy&&(m=r.invitePolicy,I=!0)}if(void 0!==r.data){let s,a=!1;try{a=Object(f.a)(r.data,n.data)}catch(e){throw Object(u.default)(u.default.WARNING,"%s: Refusing to update chatId=%s; data is not a JSON object: %s",g,t,e),new o.Error("data must be a valid JSON Object")}if(!a){b=r.data,I=!0;try{s=new d.b(r.data)}catch(e){throw new o.Error(`Unsupported type in data: ${e}`)}if(0===s.length||123!==s.data[0])throw new o.Error("data must be a JSON Object");if(s.length>e.maxApplicationDataSize)throw new o.Error(`data must not exceed ${e.maxApplicationDataSize} bytes; `+`size=${s.length}`);h[1]=e.messengerData.keyManager.getChatKey(t).then(t=>e.messengerData.rim_im.protectServerData(s.data,t))}}if(!I)return Object(u.default)(u.default.INFO,"%s: Nothing to update in chatId=%s",g,n.chatId),Promise.resolve(n);return Promise.all(h).then(r=>{const a=r[0],n=r[1],o={};return void 0!==a&&(o.subject=a),void 0!==n&&(o.data=n),void 0!==m&&(o.invitePolicy=m===s.a.InvitePolicy.ParticipantsOnly?c.a.InvitePolicy.MembersOnly:c.a.InvitePolicy.AdminOnly),Object(l.default)(Object.keys(o).length>0),e.requestManager.retryableRequest(()=>e.messengerData.managementClient.updateMailbox(t,o))}).then(()=>(Object(u.default)(u.default.INFO,"%s: Successfully updated chatId=%s",g,t),void 0!==y?e.postFunc(t,e.messengerData.rim_im.subject(y)):Promise.resolve(void 0))).then(r=>{const s=e.messengerData.chatCache.get(t);if(void 0!==r){const s=new a.a(t,r,e.messengerData.registrationInfo.regId,new Date,a.a.ReservedTag.Subject,!1,!1,{value:a.a.StateValue.Sent,isPartial:!1},!1,!1,y);e.newMessageFunc(t,s)}const n=s.withUpdate({subject:y,invitePolicy:m,data:b});return void 0===n?s:(e.messengerData.chatCache.set(n),e.emitFunc("chatUpdated",new i.ChatUpdated(n)),n)}).catch(r=>{Object(u.default)(u.default.ERROR,"%s: Failed to update chatId=%s; error=%s",g,t,r);try{e.errorFunc(t,r)}catch(e){}return Promise.reject(r)})},t.a=function(e,t){return e.description===c.a.Description.OneToOne&&2===e.members.length&&(e.members[0].regId===t&&e.members[1].regId!==t||e.members[1].regId===t&&e.members[0].regId!==t)?c.a.Description.OneToOne:c.a.Description.Conference},t.d=function(e,t,r){{const t=e.getParticipant(r);if(void 0===t||t.state===n.a.State.Left){let t=new o.Error(`Local user is not a member of chat for chatId=${e.id}`);throw Object(u.default)(u.default.ERROR,"%s: %s",g,t.message),t}}var s="OneToOne"===t;if(s&&e.participants.size>2)return Object(u.default)(u.default.INFO,"%s: Updating %s with more than 2 particpants to be a conference",g,e),!1;if(s&&2!==e.participants.size){let t=new o.Error("OneToOne chatId="+e.id+" must have 2 participants; got "+e.participants.size);throw Object(u.default)(u.default.ERROR,"%s: %s",g,t.message),t}return s};var s=r(17),a=r(42),n=r(12),o=r(0),i=r(7),d=r(6),c=r(10),l=r(3),u=r(1),p=r(2),f=r(40);const g="Messenger.detail"},function(e,t,r){"use strict";t.a=u;var s=r(0),a=r(5),n=r(4),o=r(26),i=r(16),d=r.n(i),c=r(37),l=r.n(c);function u(e,t,r,i,c,p,f,g,h,y,m,b,I,v,M,w,O){if("string"!=typeof e||0===e.length)throw new s.Error("ChatMessage requires the chatId parameter be a non-empty string, not "+typeof e);if(!(t instanceof a.a))throw new s.Error("ChatMessage requires the messageId parameter be a MessageId not "+typeof t);if("string"!=typeof r||0===r.length)throw new s.Error("ChatMessage requires the sender parameter be a non-empty string not "+typeof r);if(!(i instanceof Date))throw new s.Error("ChatMessage requires the timestamp parameter be a Date not "+typeof i);if("string"!=typeof c||0===c.length)throw new s.Error("ChatMessage requires the tag parameter be a non-empty string not "+typeof c);if("boolean"!=typeof p)throw new s.Error("ChatMessage requires the isIncoming parameter be a boolean not "+typeof p);if("boolean"!=typeof f&&void 0!==f)throw new s.Error("ChatMessage requires the isUnverified parameter be a boolean or undefined not "+typeof f);if("object"!=typeof g)throw new s.Error("ChatMessage requires the state parameter be a object not "+typeof g);switch(g.value){case u.StateValue.Read:case u.StateValue.Delivered:case u.StateValue.Sent:case u.StateValue.Failed:break;default:throw new s.Error("ChatMessage requires the state.value parameter to be a string matching one of the ChatMessage.StateValue values; state.value="+g.value)}if("boolean"!=typeof g.isPartial)throw new s.Error("ChatMessage requires the state.isPartial parameter be a boolean not "+typeof g.isPartial);if("boolean"!=typeof h)throw new s.Error("ChatMessage requires the isRecalled parameter be a boolean not "+typeof h);if("boolean"!=typeof y)throw new s.Error("ChatMessage requires the isDeleted parameter be a boolean not "+typeof y);if("string"!=typeof m&&void 0!==m)throw new s.Error("ChatMessage requires the content parameter be either a string or undefined not "+typeof m);if("object"!=typeof b&&void 0!==b)throw new s.Error("ChatMessage requires the data parameter be either a object or undefined not "+typeof b);if(!(I instanceof Uint8Array)&&void 0!==I)throw new s.Error("ChatMessage requires the thumbData parameter be either a Uint8Array or undefined not "+typeof I);if("string"!=typeof v&&void 0!==v)throw new s.Error("ChatMessage requires the thumbName parameter be either a string or undefined not "+typeof v);if(M){if("string"!=typeof M.url)throw new s.Error("ChatMessage requires the attachData.url parameter be a string not "+typeof M.url);if(!(M.key instanceof Uint8Array))throw new s.Error("ChatMessage requires the attachData.key parameter be a Uint8Array not "+typeof M.key);if(!(M.hash instanceof Uint8Array))throw new s.Error("ChatMessage requires the attachData.hash parameter be a Uint8Array not "+typeof M.hash);if("string"!=typeof M.name&&void 0!==M.name)throw new s.Error("ChatMessage requires the attachData.name parameter be a string not "+typeof M.name);if("number"!=typeof M.size&&void 0!==M.size)throw new s.Error("ChatMessage requires the attachData.size parameter be a number not "+typeof M.size)}else if(void 0!==M)throw new s.Error("ChatMessage requires the attachData parameter be either a object or undefined not "+typeof M);var R;function P(e){return Array.isArray(e)&&e.length>0?Object(o.a)(e):void 0}this.messageId=t,this.chatId=e,this.sender=r,this.timestamp=i,this.tag=c,this.isIncoming=p,this.isUnverified=f,this.state="object"==typeof(R=g)?Object(o.a)(R):void 0,this.isRecalled=h,this.isDeleted=y,this.hasFile=void 0!==M,this._attachData=M,this.hasFile&&(this.fileName=M.name,this.fileSize=M.size),this.hasFile&&(this.download=function(e){var t=new l.a(M.url);return d()({serverAddress:t.host,uri:t.pathname+(t.search?t.search:""),method:"GET",responseType:"arraybuffer",progress:e?e.progress:void 0}).catch(function(e){throw console.log("Error while downloading file: ("+e.status+")"+e.responseText),e.status?e.status>=500?new s.TemporaryFailure("Failed attempting to download file from "+M.url):new s.PermanentFailure("Failed attempting to download file from "+M.url):new s.TemporaryFailure("Timed out while attempting to download file from "+M.url)}).then(function(e){return n.decryptFile(e.response,M.key,M.hash)})}),this.content=m,this.data=b,this.thumbData=I,this.ref=P(w),this.refBy=P(O),Object.freeze(this)}u.ReservedTag={Join:"Join",Leave:"Leave",Subject:"Subject",Shred:"Shred",Gap:"Gap",Admin:"Admin",Remove:"Remove"},u.StateValue={Sent:"Sent",Failed:"Failed",Delivered:"Delivered",Read:"Read"},u.prototype.withNewState=function(e){return new u(this.chatId,this.messageId,this.sender,this.timestamp,this.tag,this.isIncoming,this.isUnverified,e,this.isRecalled,this.isDeleted,this.content,this.data,this.thumbData,this.thumbName,this._attachData,this.ref,this.refBy)},u.prototype.withNewRefBy=function(e){return new u(this.chatId,this.messageId,this.sender,this.timestamp,this.tag,this.isIncoming,this.isUnverified,this.state,this.isRecalled,this.isDeleted,this.content,this.data,this.thumbData,this.thumbName,this._attachData,this.ref,e)},u.prototype.withFileSize=function(){if(this._attachData&&!this._attachData.size){var e=new l.a(this._attachData.url);return d()({serverAddress:e.host,uri:e.pathname+(e.search?e.search:""),method:"HEAD",headersOnly:["Content-Length"]}).then(e=>{if(e["Content-Length"]){var t=Object.assign({size:parseInt(e["Content-Length"])},this._attachData);return new u(this.chatId,this.messageId,this.sender,this.timestamp,this.tag,this.isIncoming,this.isUnverified,this.state,this.isRecalled,this.isDeleted,this.content,this.data,this.thumbData,this.thumbName,t,this.ref,this.refBy)}return Promise.resolve(this)}).catch(e=>(console.error("Failed to get file size: "+e),this))}return Promise.resolve(this)},u.prototype.recalled=function(){return new u(this.chatId,this.messageId,this.sender,this.timestamp,this.tag,this.isIncoming,this.isUnverified,this.state,!0,this.isDeleted,void 0,void 0,void 0,void 0,void 0,this.ref,this.refBy)},u.prototype.deleted=function(){return new u(this.chatId,this.messageId,this.sender,this.timestamp,this.tag,this.isIncoming,this.isUnverified,this.state,this.isRecalled,!0,void 0,void 0,void 0,void 0,void 0,this.ref,this.refBy)},u.prototype.toString=function(){return"ChatMessage{id="+this.messageId+" s="+this.sender+" T="+this.tag+" t="+this.timestamp.getTime()+"}"}},function(e,t,r){"use strict";var s=r(2);class a{constructor(e){Object.defineProperty(this,"binary",{enumerable:!0,value:void 0===e?new Uint8Array([]):e}),Object.defineProperty(this,"length",{enumerable:!0,get:()=>this.binary.length})}static fromString(e){return new a(Object(s.hex2array)(e))}toString(){return Object(s.array2hex)(this.binary)}}t.a=a},function(e,t,r){"use strict";t.a=n;var s=r(0),a=r(5);function n(){var e={bookmark:new a.a,timestamp:0,maxMessageId:new a.a,onlyFastForwarded:!0,messageIdsToReconcile:new Set};Object.defineProperty(this,"bookmark",{enumerable:!0,get:function(){return e.bookmark}}),Object.defineProperty(this,"timestamp",{enumerable:!0,get:function(){return e.timestamp}}),Object.defineProperty(this,"maxMessageId",{enumerable:!0,get:function(){return e.maxMessageId}}),Object.defineProperty(this,"onlyFastForwarded",{enumerable:!0,get:function(){return e.onlyFastForwarded}}),Object.defineProperty(this,"_private",{enumerable:!1,get:function(){if(!o)throw new TypeError("Illegal access of private data");return e}})}n.prototype.recordMessageId=function(e){var t=i.call(this);if(!(e instanceof a.a)||e.isEmpty())throw new s.Error("BookmarkData: parameter does not meet expectations");if(e.isGreaterThan(t.maxMessageId)&&(t.maxMessageId=e),!e.isGreaterThan(t.bookmark))return!1;var r=e.toString();return!t.messageIdsToReconcile.has(r)&&(t.messageIdsToReconcile.add(e.toString()),!0)},n.prototype.setBookmark=function(e,t,r){var n=i.call(this);if(!(e instanceof a.a)||e.isEmpty())throw new s.Error("BookmarkData: parameter does not meet expectations");if(void 0===r)n.timestamp=Date.now()/1e3|0;else{if("number"!=typeof r)throw new s.Error("BookmarkData: parameter does not meet expectations");n.timestamp=r}n.bookmark=e;var o=0,d=n.bookmark.toString();n.messageIdsToReconcile.forEach(function(e){e<=d&&(n.messageIdsToReconcile.delete(e),++o)}),n.onlyFastForwarded=n.onlyFastForwarded&&!0===t&&0===o},n.prototype.isUpToDate=function(){return this.bookmark.isGreaterThanOrEqual(this.maxMessageId)},n.prototype.canBeReconciled=function(e){var t=i.call(this),r=e.toString();for(let e of t.messageIdsToReconcile)if(e<=r)return!0;return!1},n.prototype.needsReconciliation=function(e){return i.call(this).messageIdsToReconcile.has(e.toString())},n.prototype.toString=function(){return"[object BookmarkData]"};var o=!1;function i(){o=!0;var e=this._private;return o=!1,e}},function(e,t,r){"use strict";t.a=n;var s=r(0),a=r(66);function n(e){this._comparisonFunction=function(t,r){return e.getMessage(t).messageId.compare(e.getMessage(r).messageId)},this._data=new a.a(this._comparisonFunction,e.storageArray),this._lookupComparison=function(t,r){return e.getMessage(t).messageId.compare(r)},this._newMessage=e.newMessage,this._getMessage=e.getMessage,this._getMessages=e.getMessages,this._secondaryIndex=new Map,this._messageWatchers=new Map,Object.defineProperty(this,"length",{enumerable:!0,get:function(){return this._data.size}})}function o(e,t,r){const s=e._messageWatchers.get(t.toString());if(s)for(const e of s)try{e(r)}catch(e){console.error("Error when attempting to notify for messageId="+t+": "+e)}}n.prototype.insertOne=function(e,t){let r;if(t){const a=this._secondaryIndex.get(t.toString());if(a){if(a.isLessThan(e.messageId))throw new s.DuplicateError("Could not insert message with messageId="+e.messageId+" due to existing secondaryId="+t);const n=this.getPosition(a);if(n.isDuplicate){r=this._getMessage(this._data.data[n.index]).deleted();const e=this._newMessage(r);this._data.replace(e,n),o(this,r.messageId,e)}}this._secondaryIndex.set(t.toString(),e.messageId)}return this.insert(e),r},n.prototype.insert=function(e,t){const r=this._newMessage(e);return this._data.insert(r,t).result?(o(this,e.messageId,r),n.InsertionResult.Inserted):n.InsertionResult.Rejected},n.prototype.replace=function(e,t){const r=this._newMessage(e),s=this._data.replace(r,t).replaced?n.InsertionResult.Updated:n.InsertionResult.Inserted;return o(this,e.messageId,r),s},n.prototype.union=function(e,t){const r=this._data.union(new a.a(this._comparisonFunction,e.map(this._newMessage)),t);for(const e of r)o(this,this._getMessage(e).messageId,e)},n.prototype.getPosition=function(e){return this._data.getPosition(e,this._lookupComparison)},n.prototype.isEmpty=function(){return!this._data.size},n.prototype.earliestMessageId=function(){return this._data.size?this._getMessage(this._data.data[0]).messageId:void 0},n.prototype.latestMessageId=function(){return this._data.size?this._getMessage(this._data.data[this._data.size-1]).messageId:void 0},n.prototype.latestMessage=function(){return this._data.size?this._getMessage(this._data.data[this._data.size-1]):void 0},n.prototype.getMessage=function(e){const t=this.getPosition(e);if(!1!==t.isDuplicate)return this.lookup(t.index)},n.prototype.lookup=function(e){var t=this._data.data[e];return t?this._getMessage(t):t},n.prototype.getMessages=function*(){for(let e of this._data.data[Symbol.iterator]())yield this._getMessage(e)},n.prototype.get=function(){return this._getMessages(this._data.data)},n.prototype.setWatcher=function(e,t){const r=this.getPosition(e);let s=this._messageWatchers.get(e.toString());if(s){if(s.has(t))return;s.add(t)}else this._messageWatchers.set(e.toString(),new Set([t]));if(r.isDuplicate)try{t(this._data.data[r.index])}catch(t){console.error("Error when attempting to notify for messageId="+e+": "+t)}},n.prototype.unsetWatcher=function(e,t){const r=e.toString();let a=this._messageWatchers.get(r);if(!a)throw new s.NotFoundError("No matching callback to unwatch: msgId="+e);if(!a.has(t))throw new s.NotFoundError("No matching callback to unwatch: msgId="+e);a.delete(t),0===a.length&&this._messageWatchers.delete(r)},n.InsertionResult={Rejected:"Rejected",Updated:"Updated",Inserted:"Inserted"},Object.freeze(n.InsertionResult)},function(e,t,r){"use strict";t.a=a;var s=r(2);function a(e){this.binary=e}a.prototype.toString=function(){return Object(s.array2hex)(this.binary)}},function(e,t,r){"use strict";t.a=function(){this.allocate=function(){return{storageArray:function(){const e=[];return e.splice=((t,r,...s)=>{Array.prototype.splice.call(e,t,r,...s),e.frozenSlice=e.slice(),Object.freeze(e.frozenSlice)}),e.splice(0,0),e}(),newMessage:function(e){return e},getMessage:function(e){return e},getMessages:function(e){return e.frozenSlice}}}}},,,,,,,function(e,t,r){"use strict";const s=r(32).default,a=r(55).default,n=r(57).default,o=r(58).default,i=r(59),d=r(0),c=r(7),l=(r(11),r(74).default),u=r(39),p=r(4),f=r(75),g=r(23),h=r(3).default,y=r(2),m=r(9),b=r(1).default,I=(r(38),r(22)),v=r(16),M=r(13),w="BBMEnterprise";function O(e){if(M.apply(this),"object"!=typeof e)throw new TypeError("configuration must be an object");if("STR"!==e.environment&&"Sandbox"!==e.environment&&"Production"!==e.environment)throw new ReferenceError("environment must be one of 'Sandbox' or 'Production'");if("string"!=typeof e.domain)throw new TypeError("domain must be a string");if("string"!=typeof e.userId)throw new TypeError("userId must be a string containing the user identity, as known to the authentication server");if("string"!=typeof e.description)throw new TypeError("description must be a string");if("function"!=typeof e.getToken)throw new TypeError("getToken must be a function which returns a Promise of an authentication token");let t=!1;if(void 0===e.getKeyProvider)t=!0;else if("function"!=typeof e.getKeyProvider)throw new TypeError("getKeyProvider must be a function which returns a Promise of a key provider");if(void 0!==e.filter&&!Array.isArray(e.filter))throw new TypeError("filter must be an array of mailbox identifiers");switch(e.logLevel){case 0:b.logThreshold=b.ERROR;break;case 1:b.logThreshold=b.WARNING;break;case 3:b.logThreshold=b.DEBUG1;break;default:b.logThreshold=b.INFO}if(b.debug(b.WARNING,"%s THIS IS A DEV BUILD OF THE SDK %s","#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*","*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#*#"),e.nickname&&"string"!=typeof e.nickname)throw new TypeError("nickname must be a string or undefined");if(e.messageStorageFactory&&"function"!=typeof e.messageStorageFactory)throw new TypeError("messageStorageFactory must be a function");O.validateBrowser();const r=(()=>{let e=O.SetupState.NotRequested,t=void 0;return Object.defineProperty(this,"setupState",{enumerable:!0,get:()=>e}),{get:()=>e,set:r=>{if(e!==r){switch(h(O.SetupState.hasOwnProperty(r)),r){case O.SetupState.NotRequested:t=void 0;break;case O.SetupState.Success:h(e===O.SetupState.Ongoing),t=!0;break;default:h(e!==O.SetupState.NotRequested||r===O.SetupState.Ongoing),h(e!==O.SetupState.Ongoing||r===O.SetupState.SyncRequired||r===O.SetupState.Success),h(e!==O.SetupState.SyncRequired||r===O.SetupState.SyncStarted),h(e!==O.SetupState.SyncStarted||r===O.SetupState.SyncRequired||r===O.SetupState.Ongoing),t=!1}e=r,P("setupState",new c.SetupState(e))}},isSetup:()=>t}})(),s=(()=>{let e=O.SyncPasscodeState.None;return Object.defineProperty(this,"syncPasscodeState",{enumerable:!0,get:()=>e}),{get:()=>e,set:t=>{h(O.SyncPasscodeState.hasOwnProperty(t)),e=t}}})(),p={kmsMode:t,endpointId:function(){let e="";const t=I.getRandomValues(new Uint8Array(64));for(var r=0;r<64;r++)e+="ABCDEF0123456789".charAt(15&t[r]);return e}(),requestManager:new o,get isSetup(){return r.isSetup()}};var f;let m;Object.defineProperty(this,"messenger",{value:new u.default}),Object.freeze(p.endpointId),Object.defineProperty(this,"endpointId",{value:p.endpointId}),e.filter&&(p.filter=new Set(e.filter)),i.getDiscoveryInfo(this,{configuration:Object.assign({},e,{description:y.truncate(e.description,2e3),nickname:y.truncate(e.nickname,2e3)}),persistentData:p,version:O.version.replace(/-rc/,"."),caManager:v.pinCertificates(g.SIPTransport.CaManager)}),this.setupStart=function(){if(!p.kmsMode)throw new d.Error("The Spark SDK is not configured to use KMS; use the setup function instead");if(r.get()!==O.SetupState.NotRequested){if(r.get()===O.SetupState.Success)throw h(!0===p.isSetup),new d.Error("Setup already complete");throw h(!1===p.isSetup),new d.Error("Setup already in progress")}h(void 0===p.isSetup),r.set(O.SetupState.Ongoing),i.preMessengerSetup(this,()=>f=new n,()=>(f.kmsClient=new l(f.busClient,e.domain,f.registrationInfo.regId,p.endpointId),f.keyManager=new a(p.requestManager,f.kmsClient,e.kmsArgonWasmUrl),p.requestManager.retryableRequest(()=>f.kmsClient.getAllKeys()).then(e=>{r.get()===O.SetupState.Ongoing?(void 0===e?(m=null,s.set(O.SyncPasscodeState.New)):(m=e,s.set(O.SyncPasscodeState.Existing)),r.set(O.SetupState.SyncRequired)):b(b.ERROR,"%s: Setup state has unexpected value=%s; expected=%s",w,r.get(),O.SetupState.Ongoing)}))).catch(E)};let R=0;this.syncStart=((e,t)=>{if(r.get()!==O.SetupState.SyncRequired)throw new d.Error("The Spark SDK must have a setupState of SyncRequired to call syncStart");h(p.kmsMode),h(void 0!==m),r.set(O.SetupState.SyncStarted);const a=++R;new Promise((s,n)=>{if(t===O.SyncStartAction.New||!m)return b(b.INFO,"%s: Creating new profile keys",w),void f.keyManager.createProfileKeys(e).then(s,n);b(b.INFO,"%s: Restoring existing profile keys",w),f.keyManager.restoreProfileKeys(m,e).then(s).catch(()=>{a===R?(r.set(O.SetupState.SyncRequired),s(!0)):s(!0)})}).then(e=>e||a!==R?(a!==R&&b(b.INFO,"%s: Stopping sync because it is stale",w),Promise.resolve()):(m=void 0,s.set(O.SyncPasscodeState.None),r.set(O.SetupState.Ongoing),i.messengerSetup(this,()=>{r.set(O.SetupState.Success),f.transportCallbacks.registrationFailed=(e=>{E(new c.RegistrationChanged({reason:e}))})}))).catch(e=>{if(a!==R)return b(b.INFO,"%s: Stopping sync because it is stale",w),void Promise.resolve();E(e)})}),this.setup=function(){if(p.kmsMode)throw new d.Error("The Spark SDK is configured to use KMS; use the setupStart function instead");if(void 0!==p.isSetup){if(p.isSetup)throw h(r.get()===O.SetupState.Success),new d.Error("Setup already complete");throw h(r.get()===O.SetupState.Ongoing),new d.Error("Setup already in progress")}return h(r.get()===O.SetupState.NotRequested),r.set(O.SetupState.Ongoing),i.preMessengerSetup(this,()=>f=new n,i.setupKeyManagerWithKeyProvider).then(()=>i.messengerSetup(this,()=>{P("registrationChanged",f.registrationInfo),f.transportCallbacks.registrationFailed=(e=>{P("registrationChanged",new c.RegistrationChanged({regId:f.registrationInfo.regId,pin:f.registrationInfo.pin,registrationToken:f.registrationInfo.registrationToken,reason:e})),this.shutdown()}),r.set(O.SetupState.Success)})).catch(e=>{b(b.ERROR,"%s: Failed to complete registration; error=%s",w,e);const t=e instanceof c.RegistrationChanged?e:new c.RegistrationChanged(void 0===f||void 0===f.registrationInfo?void 0:Object.assign({},f.registrationInfo,{reason:c.RegistrationChanged.Failure.GeneralFailure}));throw P("registrationChanged",t),b.logErrorForDebugging(e),this.shutdown(),t})},this.retryServerRequests=function(){if(p.requestManager.doNextRequest(),f)for(let e of f.retryServerRequestFunctions)try{e()}catch(e){console.error("Failed to call retry function; error="+e)}},p.retryServerRequests=this.retryServerRequests,this.getRegistrationInfo=function(){try{return f.registrationInfo}catch(e){throw new d.Error("Cannot retrieve registration information when the SDK is not set up")}},this.isSetup=function(){return!0===p.isSetup},this.shutdown=function(){b(b.INFO,"%s: Starting shutdown; version=%s",w,O.version),f&&void 0!==f.transport&&f.transport.shutdown(),delete this.media,f&&f.busClient&&f.busClient.reset(),p.requestManager.reset(),u.shutdown(this.messenger),f=void 0,s.set(O.SyncPasscodeState.None),r.set(O.SetupState.NotRequested),m=void 0,R=0,b(b.INFO,"%s: Shutdown complete; version=%s",w,O.version)},this.getIdentitiesFromAppUserId=(e=>{try{return f.busClient.resolveAppUserIds([e]).catch(e=>Promise.reject(new d.Error("Failed to get identities: "+e))).then(t=>{if(0===t.length)throw new O.Error.NotFoundError(`appUserId '${e}' not found`);return t[0]})}catch(e){throw new TypeError("appUserId must be a string")}}),this.getIdentitiesFromAppUserIds=(e=>f.busClient.resolveAppUserIds(e).catch(e=>Promise.reject(new d.Error("Failed to get identities: "+e)))),this.getIdentitiesFromRegId=(e=>{try{return f.busClient.resolveRegIds([e]).catch(e=>{throw new d.Error(`Failed to get identities: ${e}`)}).then(t=>{if(0===t.length)throw new O.Error.NotFoundError(`registration ID '${e}' not found`);return t[0]})}catch(e){throw new TypeError("regId must be a string")}}),this.getIdentitiesFromRegIds=(e=>f.busClient.resolveRegIds(e).catch(e=>{throw new d.Error(`Failed to get identities: ${e}`)})),this.syncPasscodeChange=(e=>{if(!this.isSetup())throw new d.Error("Cannot call syncPasscodeChange() until setup is complete");if(!p.kmsMode)throw new d.Error("Cannot call syncPasscodeChange() unless the Spark SDK is configured to use KMS");return f.keyManager.setMgmtKeyPasscode(e)});const P=(e,t)=>{if("setupState"!==e&&r.get()===O.SetupState.NotRequested)return b(b.NOTICE,"%s: Suppressing %s event; SDK setup has not been requested",w,e),void b.debug(b.DEBUG2,"%s: Suppressing %s: %s",w,e,JSON.stringify(t));b(b.INFO,"%s: Emitting %s event",w,e),b.debug(b.DEBUG2,"%s: Emitting %s: %s",w,e,JSON.stringify(t));try{this.emit(e,t)}catch(t){b(b.ERROR,"%s: Error emitting %s event: %s",w,e,t),b.logErrorForDebugging(t)}},E=e=>{let t=c.SetupError.Value.PermanentServerError;if(e){if(e instanceof c.RegistrationChanged)switch(e.failureReason){case c.RegistrationChanged.Failure.RegistrationRevoked:t=c.SetupError.Value.EndpointDeregistered;break;case c.RegistrationChanged.Failure.Forbidden:case c.RegistrationChanged.Failure.DomainConfigurationMismatch:t=e.failureReason}b(b.ERROR,"%s: Failed to complete setup; setupError=%s error=%s",w,t,e),b.logErrorForDebugging(e)}else b(b.ERROR,"%s: Failed to complete setup; setupError=%s",w,t);P("setupError",new c.SetupError(t)),this.shutdown()};b(b.INFO,"%s: Instance created; version=%s",w,O.version)}O.SetupState={NotRequested:"NotRequested",Ongoing:"Ongoing",Success:"Success",SyncRequired:"SyncRequired",SyncStarted:"SyncStarted"},Object.freeze(O.SetupState),O.SyncStartAction={New:"New",Existing:"Existing"},Object.freeze(O.SyncStartAction),O.SyncPasscodeState={None:"None",New:"New",Existing:"Existing"},Object.freeze(O.SyncPasscodeState),O.prototype=Object.create(M.prototype),O.validateBrowser=function(){var e=!1;function t(t){console.log("validateBrowser: error="+t);var r=new d.BrowserNotSupportedError("Browser missing functionality. Error="+t);if(e)return Promise.reject(r);throw r}try{return new Promise(function(){}),e=!0,new Map,new Set([1]),p.generateEncryptionKeyPair().then(p.generateChatKey).then(function(){}).catch(function(e){return t(e)})}catch(e){return t(e)}},e.exports=O,O.Event=c,O.Util=y,O.Utf8=m,O.Error=d,O.StorageFactory=f.default,O.Messenger=u.default,O.Media=g.VVoip,O.KeyProviderInterface=s,Object.defineProperty(O,"version",{value:"1.2.0-rc16"})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(0),a=r(4),n=r(2),o=r(6),i=r(34);t.default=class extends i.a{constructor(e,t,r){super(t.regId,e=>this.getUserKeys(e)),this.requestManager=e,this.kmsClient=t,this.wasmUrl=r,this.mgmtKey=void 0}restoreProfileKeys(e,t){return new Promise((r,s)=>{const i=o.c(n.b2array(e.private.manage));return a.decryptMgmtKey({content:i.payload,tag:i.mac},i.nonce,i.salt,t,this.kmsClient.regId,this.kmsClient.domain,this.wasmUrl).then(r,s)}).then(t=>{const r=o.c(n.b2array(e.private.encrypt)),s=o.c(n.b2array(e.private.sign));return Promise.all([a.authDecrypt({content:r.payload,tag:r.mac},r.nonce,t),a.authDecrypt({content:s.payload,tag:s.mac},s.nonce,t)]).then(r=>(this.mgmtKey=t,super.setProfileKeys({privateEncryptionKey:r[0],privateSigningKey:r[1],publicEncryptionKey:o.c(n.b2array(e.public.encrypt)).key,publicSigningKey:o.c(n.b2array(e.public.sign)).key})))})}createProfileKeys(e){let t,r;return Promise.all([super.generateProfileKeys(),a.generateManagementKey()]).then(s=>{t=s[0],r=s[1];const i=a.generateBytes(12),d=a.generateBytes(12),c=a.generateBytes(12),l=a.generateBytes(16);return Promise.all([a.authEncrypt(t.privateEncryptionKey,i,r),a.authEncrypt(t.privateSigningKey,d,r),a.encryptMgmtKey(r,c,l,e,this.kmsClient.regId,this.kmsClient.domain,this.wasmUrl)]).then(e=>this.requestManager.retryableRequest(()=>this.kmsClient.setProfileKeys(n.array2b(o.d({key:t.publicEncryptionKey})),n.array2b(o.d({key:t.publicSigningKey})),n.array2b(o.d({payload:e[0].content,mac:e[0].tag,nonce:i})),n.array2b(o.d({payload:e[1].content,mac:e[1].tag,nonce:d})),n.array2b(o.d({payload:e[2].content,mac:e[2].tag,nonce:c,salt:l})))))}).then(()=>(this.mgmtKey=r,super.setProfileKeys(t)))}setMgmtKeyPasscode(e){if(void 0===this.mgmtKey)return Promise.reject(new s.NotFoundError("No mgmt key to set a passcode for"));const t=a.generateBytes(12),r=a.generateBytes(16);return a.encryptMgmtKey(this.mgmtKey,t,r,e,this.kmsClient.regId,this.kmsClient.domain,this.wasmUrl).then(e=>{const s=n.array2b(o.d({payload:e.content,mac:e.tag,nonce:t,salt:r}));return this.requestManager.retryableRequest(()=>this.kmsClient.setMgmtKey(s))})}getUserKeys(e){return this.requestManager.retryableRequest(()=>this.kmsClient.getPublicKeys(e).then(t=>{if(void 0===t)throw new s.PermanentFailure("No keys exist for regId="+e);return{encryptionKey:o.c(n.b2array(t.public.encrypt)).key,signingKey:o.c(n.b2array(t.public.sign)).key}}))}}},function(e,t){e.exports=require("./environment_argon2.js")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(){this.busClient=void 0,this.registrationInfo=void 0,this.transportCallbacks=void 0,this.transport=void 0,this.kmsClient=void 0,this.keyManager=void 0,this.rim_im=void 0,this.lastUpload=void 0,this.db=void 0,this.managementClient=void 0,this.contentClient=void 0,this.syncManager=void 0,this.chatCache=void 0,this.lastOnlineMessage=Promise.resolve(),this.retryServerRequestFunctions=[],this.getCurrentTimestamp=function(){return Math.floor(Date.now()/1e3)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=o;var s=r(0),a=r(1);const n="RequestManager";function o(){this.requests=[],this.requestInProgress=!1,this.inCompletionCallback=!1,this.doNextRequestTimerId=null}o.prototype.retryableRequest=function(e){var t=this;return new Promise(function(r,s){t.requests.push({resolve:r,reject:s,doRequestFunction:e}),t.doNextRequest()})},o.prototype.doNextRequest=function(){var e=this;if(0!==e.requests.length&&!e.requestInProgress&&null===e.doNextRequestTimerId)if(e.inCompletionCallback)e.doNextRequestTimerId=setTimeout(function(){e.doNextRequestTimerId=null,e.doNextRequest()});else{e.requestInProgress=!0;try{var t=e.requests[0];t.doRequestFunction().then(function(e){r(function(){t.resolve(e)})}).catch(function(o){if(o instanceof s.TemporaryFailure)return Object(a.default)(a.default.WARNING,"%s: %s; request will be retried",n,o),void(e.requestInProgress=!1);r(function(){t.reject(o)})})}catch(e){Object(a.default)(a.default.ERROR,"%s: Failed to initiate retryable request; error=%s",n,e),r(function(){t.reject(e)})}}function r(t){e.inCompletionCallback=!0,e.requestInProgress=!1,t(),e.requests.shift(1),e.doNextRequest(),e.inCompletionCallback=!1}},o.prototype.reset=function(){this.requests.length>0&&(Object(a.default)(a.default.WARNING,"%s: Reset has been called; rejecting %d request(s)",n,this.requests.length),this.requests.forEach(function(e){e.reject(new s.Error("Request was cancelled")),delete e.doRequestFunction})),null!==this.doNextRequestTimerId&&(Object(a.default)(a.default.WARNING,"%s: Reset has been called; cancelling timer with id=%s",n,this.doNextRequestTimerId),clearTimeout(this.doNextRequestTimerId)),this.requests=[],this.requestInProgress=!1,this.inCompletionCallback=!1,this.doNextRequestTimerId=null}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getDiscoveryInfo=function(e,t){const r=Object(p.getIdpUserIdHash)(t.configuration.userId).then(e=>t.persistentData.requestManager.retryableRequest(()=>I()({serverAddress:{STR:"rtcebus.bblabs.rim.net",Sandbox:"discovery.sandbox.bbmenterprise.com",Production:"discovery.shared.bbmenterprise.com"}[t.configuration.environment],uri:"/domains/"+t.configuration.domain+"/discovery?platform="+m.a+"&osVersion="+M.a.osVersion+"&clientBundle="+t.version+"&endpointId="+t.persistentData.endpointId+"&userId="+e,method:"GET",responseType:"json"}).catch(e=>{const t=!e.status||e.status>=500?n.TemporaryFailure:n.PermanentFailure;throw new t("Failed to perform service discovery")})).then(e=>{const r={};return 200===e.status&&e.response.services.forEach(e=>{var t=e.address.indexOf(":");r[e.name]=-1===t?{host:e.address}:{host:e.address.slice(0,t),port:e.address.slice(t+1)}}),t.discoveryInfo=r,t}));return w.set(e,r),r},t.busRegisterEndpoint=R,t.getBbmToken=P,t.createEndpointManagementInterface=E,t.sipRegisterEndpoint=x,t.setupKeyManagerWithKeyProvider=function(e,t){return new Promise((r,a)=>{t.configuration.getKeyProvider(t.messengerData.registrationInfo.regId,t.messengerData.busClient.bbmToken.oauthToken).then(e=>(t.messengerData.keyManager=new s.a(t.messengerData.registrationInfo.regId,e),t.messengerData.keyManager.setup())).then(r=>r?e.getAllEndpoints().then(r=>Promise.all(r.endpoints.filter(e=>e.endpointId!==t.persistentData.endpointId).map(t=>e.deleteEndpoint(t.endpointId)))):Promise.resolve()).then(r).catch(e=>a(e))})},t.preMessengerSetup=function(e,t,r){return Object(h.default)(h.default.INFO,"%s: Starting setup; version=%s",O,"1.2.0-rc16"),w.get(e).then(e=>(e.messengerData=t(),e.messengerData.throwIfSipRegistrationFailed=function(){const e=this.transport.state;if(!e.connected&&e.reason)throw new o.RegistrationChanged(void 0===this.registrationInfo?void 0:Object.assign({},this.registrationInfo,{reason:e.reason}))},e)).then(R).then(P).then(t=>E(e,t)).then(t=>Promise.all([x(e,t),r(e,t)]).then(()=>t))},t.messengerSetup=function(e,t){return w.get(e).then(t=>(t.messengerData.throwIfSipRegistrationFailed(),t.messengerData.rim_im=new d.a(t.messengerData.registrationInfo.regId,t.messengerData.keyManager),u.setup(e.messenger,t))).then(r=>(r.messengerData.throwIfSipRegistrationFailed(),t(),delete r.messengerData.throwIfSipRegistrationFailed,Object(h.default)(h.default.INFO,"%s: Setup complete; version=%s",O,"1.2.0-rc16"),{messenger:e.messenger,media:e.media}))};var s=r(60),a=r(61),n=r(0),o=r(7),i=r(6),d=r(62),c=r(11),l=r(38),u=r(39),p=r(4),f=r(23),g=r.n(f),h=r(1),y=r(24),m=r.n(y),b=r(16),I=r.n(b),v=r(36),M=r.n(v);const w=new WeakMap,O="BBMEnterprise";function R(e){return e.messengerData.busClient=new c.default(e.discoveryInfo.profile.host,e.discoveryInfo.mailbox.host,e.discoveryInfo.kms&&e.discoveryInfo.kms.host?e.discoveryInfo.kms.host:e.discoveryInfo.profile.host,e.discoveryInfo.profile.port,e.discoveryInfo.mailbox.port,e.discoveryInfo.kms&&e.discoveryInfo.kms.port?e.discoveryInfo.kms.port:e.discoveryInfo.profile.port,e.configuration.domain,e.configuration.userId,e.configuration.getToken),e.persistentData.requestManager.retryableRequest(()=>e.messengerData.busClient.register(e.configuration.userId,e.persistentData.endpointId,2560..toString(),e.version,"1247904",e.configuration.description,e.configuration.nickname)).then(t=>{const r={regId:t.registrationId.toString().valueOf(),registrationToken:t.registrationToken,pin:t.pin};if("SwitchNotSupported"===t.accountStatus||"SwitchRequired"===t.accountStatus){r.reason=o.RegistrationChanged.Failure.DeviceSwitchRequired;const e=new o.RegistrationChanged(r);throw Object(h.default)(h.default.ERROR,"%s: An SPoP client is already registered for this account; regId=%s pin=%s",O,e.regId,e.pin),e}if("Restored"!==t.accountStatus&&"EndpointAdded"!==t.accountStatus&&"Created"!==t.accountStatus&&"Switched"!==t.accountStatus){r.reason=o.RegistrationChanged.Failure.GeneralFailure;const e=new o.RegistrationChanged(r);throw Object(h.default)(h.default.ERROR,"%s: Unexpected registration accountStatus=%s in registration response; regId=%s pin=%s",O,t.accountStatus,r.regId,r.pin),e}if(e.messengerData.registrationInfo=new o.RegistrationChanged(r),Object.freeze(e.messengerData.registrationInfo),void 0!==t.kms&&"boolean"!=typeof t.kms)throw Object(h.default)(h.default.ERROR,"%s: Unexpected kms=%s value in registration response with type=%s",O,t.kms,typeof t.kms),r.reason=o.RegistrationChanged.Failure.GeneralFailure,new o.RegistrationChanged(r);if(!0===t.kms!==e.persistentData.kmsMode)throw e.persistentData.kmsMode?Object(h.default)(h.default.ERROR,"%s: The SDK is configured to use KMS for key storage, however the domain is configured for cloud key storage",O):Object(h.default)(h.default.ERROR,"%s: The SDK is configured to use cloud key storage, however the domain is configured to use KMS for key storage",O),r.reason=o.RegistrationChanged.Failure.DomainConfigurationMismatch,new o.RegistrationChanged(r);return e})}function P(e){return e.persistentData.requestManager.retryableRequest(()=>e.messengerData.busClient.bbmToken.get()).then(t=>(e.bbmToken=t,e))}function E(e,t){const r=new l.default(t.messengerData.busClient,t.configuration.domain,t.messengerData.registrationInfo.regId);return e.getAllEndpoints=((...e)=>r.getAllEndpoints(...e)),e.deleteEndpoint=((...e)=>r.deleteEndpoint(...e)),Promise.resolve(t)}function x(e,t){const r=new Promise((e,r)=>{const s=()=>{};t.messengerData.transportCallbacks={connected:()=>{e(),t.messengerData.transportCallbacks.connected=t.persistentData.retryServerRequests,t.messengerData.transportCallbacks.registrationFailed=s},registrationFailed:e=>{r(new o.RegistrationChanged(Object.assign({},t.messengerData.registrationInfo,{reason:e})))},disconnected:s,receive:s}});function s(e,t){return e+(t&&t.length?":"+t:"")}const d=t.discoveryInfo;return t.messengerData.transport=new a.a({server_addr:d.sip.host,server_port:d.sip.port?d.sip.port:443,id_provider:t.configuration.domain,id_provider_user:t.configuration.userId,regId:t.messengerData.registrationInfo.regId,pin:t.messengerData.registrationInfo.pin,endpoint_id:t.persistentData.endpointId,getPins:e=>t.messengerData.busClient.getPins(e),bbm_token:{bbmToken:t.bbmToken.token,bbmTokenMin:t.bbmToken.tokenMin,secret:t.bbmToken.secret},bbmuser:{refreshBBMToken:(e,r)=>{t.messengerData.busClient.bbmToken.refresh().then(t=>{e({bbmToken:t.token,bbmTokenMin:t.tokenMin,secret:t.secret})}).catch(e=>r(e))}},caManager:t.caManager,logLevel:t.configuration.logLevel},!0===g.a.VVoip.disabled?{}:{protect:(e,r)=>t.messengerData.rim_im.protectUser(r,e),unprotect:(e,r)=>{try{return t.messengerData.rim_im.unprotectUser(r,i.c(e).protected)}catch(e){return Object(h.default)(h.default.ERROR,"%s: Error while unprotecting data blob; error=%s",O,e),Promise.reject(new n.Error("Failed to unprotect data blob"))}},stunServers:["stun:"+s(d.stun.host,d.stun.port)],turnServers:[new g.a.VVoip.TurnServerConfig("udp",s(d["turn-udp"].host,d["turn-udp"].port)),new g.a.VVoip.TurnServerConfig("tcp",s(d["turn-tcp"].host,d["turn-tcp"].port))]},t.messengerData.transportCallbacks),Object.defineProperty(e,"media",{configurable:!0,value:t.messengerData.transport.media}),r}},function(e,t,r){"use strict";var s=r(0),a=r(7),n=(r(2),r(1)),o=r(32),i=r(34);const d="AppKeyManager";function c(e,t){void 0}function l(e,t){void 0}t.a=class extends i.a{constructor(e,t){super(e,e=>t.getPublicKeys(e)),this.keyProvider=t}setup(){let e=null,t=()=>super.generateProfileKeys().then(t=>(e=t,super.setProfileKeys(t))).catch(e=>{throw Object(n.default)(n.default.ERROR,"%s: Failed to import generated profile keys: %s",d,e),n.default.logErrorForDebugging(e),e}).then(()=>{try{return this.keyProvider.saveProfileKeys(e)}catch(e){Object(n.default)(n.default.ERROR,"%s: Failed to save profile keys: %s",d,e),n.default.logErrorForDebugging(e)}});var r=()=>{let s;return new Promise((e,r)=>{try{this.keyProvider.getProfileKeys().then(r=>{r&&0===Object.keys(r).length?(Object(n.default)(n.default.INFO,"%s: Empty profile keys, will generate keys",d),e(t())):e(r)}).catch(e=>{Object(n.default)(n.default.INFO,"%s: Caught error from key provider, error: %s",d,e),s=e,r(e)})}catch(e){s=e,r(e)}}).then(t=>e?t:(l(`keyProvider.getProfileKeys[regId=${this.regId}] result`,t),super.setProfileKeys(t))).then(()=>e?Promise.resolve():new Promise((e,t)=>{this.keyProvider.getChatKeys().then(e,t)}).then(e=>(Object.keys(e).forEach(t=>{this.chatKeys.set(t,e[t])}),l("keyProvider.getChatKeys result",this.chatKeys),Promise.resolve())).catch(e=>{Object(n.default)(n.default.INFO,"%s: Failed to get chat keys: %s",d,e),n.default.logErrorForDebugging(e)})).catch(e=>(Object(n.default)(n.default.ERROR,"%s: Failed to import profile keys, error: %s",d,e),n.default.logErrorForDebugging(e),"function"==typeof this.keyProvider.profileKeysImportFailed?this.keyProvider.profileKeysImportFailed(s).then(e=>(Object(n.default)(n.default.INFO,"%s: keyProvider failureChoice=%s",d,e),e===o.default.FailureChoice.GetProfileKeys?new Promise((e,t)=>{setTimeout(function(){r().then(function(t){e(t)}).catch(function(e){t(e)})},0)}):e===o.default.FailureChoice.GenerateNewKeys?t():(Object(n.default)(n.default.ERROR,"%s: Abandoning setup, failureChoice=%s",d,e),Promise.reject(new a.RegistrationChanged({regId:this.regId,reason:a.RegistrationChanged.Failure.FailedToImportProfileKeys}))))):(Object(n.default)(n.default.ERROR,"%s: Abandoning setup; KeyProvider.profileKeysImportFailed is not defined as a function",d),Promise.reject(new a.RegistrationChanged({regId:this.regId,reason:a.RegistrationChanged.Failure.FailedToImportProfileKeys})))))};return r().then(()=>null!==e).catch(e=>{throw Object(n.default)(n.default.ERROR,"%s: Failed to setup profile keys: %s",d,e),n.default.logErrorForDebugging(e),e})}getChatKey(e){return super.getChatKey(e).catch(t=>{if(t instanceof s.NotFoundError)return this.keyProvider.getChatKey(e).then(t=>{if(t instanceof Uint8Array&&0!==t.length)return c("getChatKey["+e+"] dispensing",t),super.setChatKey(e,t),t;throw new s.NotFoundError("Chat key for chatId="+e+" is not useable")});throw t})}setChatKey(e,t){super.setChatKey(e,t);try{this.keyProvider.saveChatKey(e,t)}catch(t){Object(n.default)(n.default.ERROR,"%s: Failed to save chat key for chatId=%s: %s",d,e,t),n.default.logErrorForDebugging(t)}}removeChatKey(e){super.removeChatKey(e);try{this.keyProvider.removeChatKey(e)}catch(t){Object(n.default)(n.default.ERROR,"%s: Failed to remove chat key for chatId=%s: %s",d,e,t),n.default.logErrorForDebugging(t)}}}},function(e,t,r){"use strict";t.a=o;var s=r(7),a=r(23),n=(r.n(a),r(1));function o(e,t,r){var s=new i(e,t,r);Object.defineProperty(this,"_private",{enumerable:!1,get:function(){if(!i.isAccessAllowed)throw new TypeError("Illegal access of private data");return s}}),Object.defineProperty(this,"media",{enumerable:!0,value:s.media}),Object.defineProperty(this,"state",{enumerable:!0,get:function(){return s.state}}),Object.defineProperty(this,"requestCount",{enumerable:!0,get:function(){return s.requests.size}})}function i(e,t,r){this.name="Transport",this.state={connected:!1},this.callbacks=r,this.requests=new Set,this.hadAuthFailure=!1,this.hadTemporarySipFailure=!1,this.sipTransport=new a.SIPTransport(e),this.registeredCallback=i.prototype.onSipRegistered.bind(this),this.regFailedCallback=i.prototype.onSipRegFailure.bind(this),this.disconnectedCallback=i.prototype.disconnected.bind(this),this.receiveCallback=i.prototype.onMcpOnlineMessage.bind(this),this.sipTransport.on("registered",this.registeredCallback),this.sipTransport.on("registration_failed",this.regFailedCallback),this.sipTransport.on("disconnected",this.disconnectedCallback),this.sipTransport.on("McpOnlineMessage",this.receiveCallback);try{this.media=new a.VVoip(this,t)}catch(e){this.media=null}}o.prototype.mcpPost=function(e,t){return i.getPrivateData(this).sendMcpRequest({name:"mcpPost",mailboxId:e},e,t)},o.prototype.mcpPull=function(e,t){return i.getPrivateData(this).sendMcpRequest({name:"mcpPull",mailboxId:e},e,t)},o.prototype.mcpSync=function(e){return i.getPrivateData(this).sendMcpRequest({name:"mcpSync",mailboxId:"sync"},e)},o.prototype.shutdown=function(){var e=i.getPrivateData(this),t=e.sipTransport;t.removeListener("registered",e.registeredCallback),t.removeListener("registration_failed",e.regFailedCallback),t.removeListener("disconnected",e.disconnectedCallback),t.removeListener("McpOnlineMessage",e.receiveCallback),t.stop(),e.disconnected()},i.isAccessAllowed=!1,i.getPrivateData=function(e){i.isAccessAllowed=!0;var t=e._private;return i.isAccessAllowed=!1,t},i.prototype.onSipRegistered=function(){this.hadAuthFailure&&(Object(n.default)(n.default.INFO,"%s: Recovered from SIP auth failure",this.name),this.hadAuthFailure=!1),this.hadTemporarySipFailure&&(Object(n.default)(n.default.INFO,"%s: Recovered from SIP temporary failure",this.name),this.hadTemporarySipFailure=!1),this.state.connected||(Object(n.default)(n.default.INFO,"%s: Connected",this.name),this.state={connected:!0},this.callCallback("connected"))},i.prototype.onSipRegFailure=function(e){var t=e.status_code;if(this.disconnected(),401===t||403===t){if(!this.hadAuthFailure)return Object(n.default)(n.default.INFO,"%s: Ignoring SIP auth failure: code=%d",this.name,t),void(this.hadAuthFailure=!0)}else if(t>=500&&t<600)return Object(n.default)(n.default.INFO,"%s: Ignoring SIP temporary failure: code=%d",this.name,t),void(this.hadTemporarySipFailure=!0);Object(n.default)(n.default.ERROR,"%s: Failed SIP registration: cause=%s code=%d",this.name,e.cause,t),this.state.reason=410===t?s.RegistrationChanged.Failure.RegistrationRevoked:401===t||403===t?s.RegistrationChanged.Failure.Forbidden:s.RegistrationChanged.Failure.GeneralFailure,this.callCallback("registrationFailed",this.state.reason)},i.prototype.onMcpOnlineMessage=function(e){this.state.connected?this.callCallback("receive",e):Object(n.default)(n.default.ERROR,"%s: Discarding online message received while disconnected",this.name)},i.prototype.callCallback=function(e,...t){try{this.callbacks[e](...t)}catch(t){Object(n.default)(n.default.ERROR,"%s: Failed to call %s callback",this.name,e),n.default.logErrorForDebugging(t)}},i.prototype.sendMcpRequest=function(e,...t){var r=this;return r.state.connected?new Promise(function(s,a){function n(){r.requests.delete(e)}e.reject=a,r.requests.add(e);try{r.sipTransport[e.name](...t).then(function(e){s(e),n()}).catch(function(t){a(r.convertSipError(e.mailboxId,t)),n()})}catch(t){a(r.convertSipError(e.mailboxId,t)),n()}}):Promise.reject({mbx_id:e.mailboxId,status_code:480,cause:"Transport disconnected"})},i.prototype.disconnected=function(){if(this.state.connected){Object(n.default)(n.default.INFO,"%s: Disconnected",this.name),this.state={connected:!1},this.callCallback("disconnected");for(let e of this.requests)Object(n.default)(n.default.DEBUG2,"%s: Failing outstanding %s request with a temporary failure",this.name,e.name),e.reject({mbx_id:e.mailboxId,status_code:480,cause:"Transport disconnected"});this.requests.clear()}else Object(n.default)(n.default.DEBUG2,"%s: Ignoring disconnected event; already disconnected",this.name)},i.prototype.convertSipError=function(e,t){if(t instanceof Error){if("TIMEOUT_ERROR"===t.name)return Object(n.default)(n.default.DEBUG2,"%s: Converting TimeoutError to MCPResponse; code=408",this.name),{mbx_id:e,status_code:408,cause:t.message};if("STATE_ERROR"===t.name)return Object(n.default)(n.default.DEBUG2,"%s: Converting InvalidStateError to MCPResponse; code=480",this.name),{mbx_id:e,status_code:480,cause:t.message}}return t}},function(e,t,r){"use strict";t.a=y;var s=r(6),a=r(0),n=r(10),o=r(4),i=r(33),d=r(3),c=r(2),l=r(1),u=r(9),p=r(20),f=r.n(p);const g="RIM_IM";var h=1;function y(e,t){this.regId=e,this.keyManager=t,this.protectionRequired=!0}function m(e,t,r,a){var n,d=o.generateBytes(16),c=h,l=a(d,c);return h=i.a.getNextCounter(h),o.encrypt(t,l,d,o.encryptDiversifier,r).then(t=>(n=new Uint8Array(t),e.keyManager.getPrivateSigningKey())).then(e=>o.sign(l,n,e)).then(e=>s.d({protected:{nonce:d,counter:c,signature:{sValue:e.s,rValue:e.r},payload:n}}))}function b(e,t,r,s,a){var n=a(t.nonce,t.counter);return e.keyManager.getPublicKeys(s).then(e=>o.verify({s:t.signature.sValue,r:t.signature.rValue},n,t.payload,e.sign).then(function(e){return o.decrypt(t.payload,n,t.nonce,o.encryptDiversifier,r).then(function(t){return{data:t,verified:e}})}))}function I(e){return`"${e.name}"`}function v(e,t,r){M(e,t,Uint8Array);const s=e.body[t];if(!r&&0===s.length)throw new TypeError(`${t} is empty in ${I(e)}`);try{e.body[t]=u.decode(s)}catch(r){throw new TypeError(`${t} could not be converted to a string in `+`${I(e)}; error=${r}`)}}function M(e,t,r){var s=e.body[t];if(void 0===s)throw new TypeError(t+" was not found in "+I(e));if(!(s instanceof r))throw new TypeError(t+" is not an instance of "+r.name+" in "+I(e))}function w(e,t){var r=e.body[t];if(void 0===r)throw new TypeError(t+" was not found in "+I(e));if("boolean"!=typeof r)throw new TypeError(t+" is not a boolean in "+I(e))}function O(e){if(e&&"object"==typeof e)for(const t in e){const r=e[t];if(r instanceof Uint8Array)try{e[t]=u.decode(r)}catch(e){Object(l.default)(l.default.WARNING,"%s: Cannot convert property=%s to string: %s",g,t,e)}else O(r)}}function R(e,t,r){function s(){if(e.regId!==r)throw new TypeError("Ignoring "+I(t)+" from unknown identity="+r)}switch(t.name){case"invite":v(t,"mailboxId"),v(t,"subject",!0),delete t.body.displayName;break;case"chatCreated":s(),v(t,"endpointId"),v(t,"mailboxId"),t.body.subject&&v(t,"subject",!0),t.body.peer&&v({name:t.name,body:t.body.peer},"regId");break;case"chatRemoved":v(t,"mailboxId"),"system"!==r&&(M(t,"authCode",Uint8Array),M(t,"encryptedAuthCode",Uint8Array));break;case"chatLeft":s(),v(t,"endpointId"),v(t,"mailboxId"),void 0===t.body.remove&&(t.body.remove=!1),w(t,"remove");break;case"restoreMarker":s(),v(t,"endpointId");break;case"appMessage":if("system"!==r)throw new TypeError(`Ignoring ${I(t)} from unknown identity=${r}`);if(v(t,"id",!0),void 0===t.body.content)throw new TypeError(`content was not found in ${I(t)}`);if("object"!=typeof t.body.content||null===t.body.content||Array.isArray(t.body.content)||t.body.content instanceof Uint8Array)throw new TypeError(`content is not an object in ${I(t)}`);if(O(t.body.content),void 0===t.body.time)throw new TypeError(`time was not found in ${I(t)}`);if(!Number.isInteger(t.body.time))throw new TypeError(`time was not an integer in ${I(t)}`);break;default:throw new TypeError(I(t)+" not expected in identity mailbox")}return t}function P(e){switch(e.name){case"content":if(v(e,"tag"),void 0!==e.body.content&&v(e,"content",!0),void 0!==e.body.thumbName&&v(e,"thumbName",!0),void 0!==e.body.attach&&(v({name:e.name,body:e.body.attach},"url"),e.body.attach.name&&v({name:e.name,body:e.body.attach},"name")),void 0!==e.body.data&&("object"!=typeof e.body.data||null===e.body.data||Array.isArray(e.body.data))||e.body.data instanceof Uint8Array)throw new TypeError(`data is not an object in ${I(e)}`);if(O(e.body.data),e.body.ref){if(!(e.body.ref instanceof Array))throw new TypeError("ref field not an array in "+I(e));for(const t of e.body.ref)if(v({name:"ref",body:t},"tag",!0),M({name:"ref",body:{messageId:t.messageId}},"messageId",Uint8Array),0===t.messageId.length)throw new TypeError("ref messageId="+t.messageId+" must not be empty in "+I(e));0===e.body.ref.length&&delete e.body.ref}break;case"join":delete e.body.displayName;break;case"remove":v(e,"regId");break;case"status":if(!(void 0===e.body.d||e.body.d instanceof Uint8Array&&0!==e.body.d.length))throw new TypeError(I(e)+" has bad d="+JSON.stringify(e.body.d));if(!(void 0===e.body.r||e.body.r instanceof Uint8Array&&0!==e.body.r.length))throw new TypeError(I(e)+" has bad r="+JSON.stringify(e.body.r));break;case"subject":v(e,"subject",!0);break;case"shred":case"leave":e.body={};break;case"typing":e.body.tag?(v(e,"tag",!0),e.body.messageId&&M(e,"messageId",Uint8Array)):e.body.messageId&&delete e.body.messageId;break;case"recall":case"delete":M(e,"ids",Array),e.body.ids.forEach(function(t){if(!(t instanceof Uint8Array))throw new TypeError("ids in "+I(e)+" has element that is not a Uint8Array")});break;case"admin":w(e,"promotion"),v(e,"regId");break;case"metadataChanged":e.body.changes&&v(e,"changes",!0);break;default:throw new TypeError(I(e)+" not expected in non-identity mailbox")}return e}function E(e){let t;try{t=s.c(e)}catch(t){throw Object(l.default)(l.default.WARNING,"%s: Failed to decode JSON8: %s; data=%s",g,t,Object(c.array2hex)(e)),l.default.logErrorForDebugging(t),t}return x(t)}function x(e){try{for(const t in e)return{name:t,body:e[t]};throw new s.a("Could not find message name")}catch(t){throw Object(l.default)(l.default.WARNING,"%s: Failed to decode message as RIM_IMv2: %s; data=%s",g,t,s.e(e)),l.default.logErrorForDebugging(t),t}}y.prototype.content=function(e,t,r,a,n,o,i){let d={content:{tag:e}};if(void 0!=t&&(d.content.content=t),void 0!==r&&(d.content.data=new s.b(r)),void 0!=a&&(d.content.thumb=a),void 0!=n&&(d.content.thumbName=n),void 0!=o&&(d.content.attach=o),i&&i instanceof Array&&i.length>0){d.content.ref=[];for(const e of i)d.content.ref.push({tag:e.tag,messageId:e.messageId.binary})}return s.d(d)},y.prototype.join=function(e,t){var r={join:{displayName:""}};return void 0!==e&&(Object(d.default)(e instanceof Uint8Array,"inviteId must be a byte array"),r.join.inviteId=e),void 0!==t&&(r.join.messageExpiry=t),s.d(r)},y.prototype.recall=function(e){return s.d({recall:{ids:e}})},y.prototype.delete=function(e){return s.d({delete:{ids:e}})},y.prototype.leave=function(){return s.d({leave:{displayName:""}})},y.prototype.remove=function(e){return s.d({remove:{regId:e}})},y.prototype.shred=function(){return s.d({shred:{}})},y.prototype.status=function(e,t){var r={status:{}};return void 0!==e&&(r.status.d=e),void 0!==t&&(r.status.r=t),s.d(r)},y.prototype.typing=function(e,t){const r={typing:{}};return void 0!==e&&(Object(d.default)("string"==typeof e,"tag must be a string."),r.typing.tag=e,t&&(Object(d.default)(t instanceof Uint8Array&&t.length>0,"tag must be a non empty Uint8Array."),r.typing.messageId=t)),s.d(r)},y.prototype.subject=function(e){return s.d({subject:{subject:e}})},y.prototype.admin=function(e,t){return s.d({admin:{regId:e,promotion:t}})},y.prototype.invite=function(e,t,r,a,n){var o={invite:{mailboxId:e,subject:t,displayName:""}};return void 0!==r&&(o.invite.isConference=r),void 0!==a&&(o.invite.symmetricKey=a),void 0!==n&&(Object(d.default)(n instanceof Uint8Array,"inviteId must be a byte array"),o.invite.inviteId=n),s.d(o)},y.prototype.chatCreated=function(e,t,r,a,n){var o={chatCreated:{endpointId:e,mailboxId:t}};return void 0!==r&&(o.chatCreated.symmetricKey=r),void 0!==a&&(o.chatCreated.subject=a),void 0!==n&&void 0!==n.regId&&(o.chatCreated.peer={regId:n.regId}),s.d(o)},y.prototype.chatRemoved=function(e,t,r){return s.d({chatRemoved:{mailboxId:e,authCode:t,encryptedAuthCode:r}})},y.prototype.chatLeft=function(e,t,r){var a={chatLeft:{endpointId:e,mailboxId:t}};return void 0!==r&&!1!==r&&(a.chatLeft.remove=r),s.d(a)},y.prototype.restoreMarker=function(e){return Object(d.default)("string"==typeof e&&e.length>0,"Parameter does not meet expectations"),s.d({restoreMarker:{endpointId:e}})},y.prototype.protectUser=function(e,t){var r=(t,r)=>o.userPrefix(this.regId,e,t,r);return Promise.all([this.keyManager.getPublicKeys(e),this.keyManager.getPrivateEncryptionKey()]).then(e=>o.generateSharedSecret(e[0].encrypt,e[1])).then(e=>m(this,t,e,r))},y.prototype.protectChat=function(e,t){var r=(t,r)=>o.chatPrefix(this.regId,u.encode(e),t,r);return this.keyManager.getChatKey(e).then(e=>m(this,t,e,r))},y.prototype.protectChatMetadata=function(e,t,r){try{const a=(e,t)=>o.chatPrefix(this.regId,new Uint8Array(0),e,t);var s=t=>m(this,e,t,a).then(e=>{const t=new n.a.AppData({regId:this.regId,data:f.a.base64Uint8Array(e)});return Object(l.default)(l.default.DEBUG1,"%s: Prepared server metadata=%s",g,t),t});return r?s(r):this.keyManager.getChatKey(t).then(s)}catch(e){return Promise.reject("Failed to protect metadata for chatId="+t+": "+e)}},y.prototype.unprotectUser=function(e,t){var r=(t,r)=>o.userPrefix(e,this.regId,t,r);return Promise.all([this.keyManager.getPublicKeys(e),this.keyManager.getPrivateEncryptionKey()]).then(e=>o.generateSharedSecret(e[0].encrypt,e[1])).then(s=>b(this,t,s,e,r))},y.prototype.unprotectChat=function(e,t,r){var s=(r,s)=>o.chatPrefix(t,u.encode(e),r,s);return this.keyManager.getChatKey(e).then(e=>b(this,r,e,t,s))},y.prototype.unprotectChatMetadata=function(e,t,r){try{Object(l.default)(l.default.DEBUG1,"%s: Unprotecting server metadata=%s",g,t);const n=E(f.a.unbase64Array(t.data)),i=(e,r)=>o.chatPrefix(t.regId,new Uint8Array(0),e,r);return(void 0===r?this.keyManager.getChatKey(e):Promise.resolve(r)).then(e=>(Object(l.default)(l.default.DEBUG1,"%s: Decrypting 'protected' metadata=%s",g,s.e(n.body)),b(this,n.body,e,t.regId,i)))}catch(t){return Promise.reject(new a.Error("Failed to unprotect metadata for chatId="+e+": "+t))}},y.prototype.protectServerSubject=function(e,t){return this.protectChatMetadata(s.d({s:Object(c.truncate)(e,128)}),void 0,t)},y.prototype.unprotectServerSubject=function(e,t){if(e.subject)return this.unprotectChatMetadata(e.id,e.subject,t).then(e=>Object(c.truncate)(u.decode(s.c(e.data).s),128));try{return o.decodeAndDecryptMetadata(e.name,t).then(e=>Object(c.truncate)(e,128))}catch(e){return Promise.reject(e)}},y.prototype.protectServerData=function(e,t){return this.protectChatMetadata(e,void 0,t)},y.prototype.unprotectServerData=function(e,t){return this.unprotectChatMetadata(e.id,e.data,t).then(e=>{if(0===e.data.length||123!==e.data[0])throw new a.Error("Application data is not an object");const t=s.c(e.data);return O(t),t})},y.prototype.receiveJson=function(e,t,r,n){var o=this;try{const d=x(n);l.default.debug(l.default.DEBUG2,"%s: Parsed message from m=%s M=%s r=%s: %s",g,e,r,t,s.e(d));var i=e.startsWith("id.");if(i&&e!=="id."+o.regId)throw new TypeError("Ignoring "+I(d)+" received for unknown identity="+e);switch(d.name){case"protected":if("system"===t)throw new TypeError(`Ignoring ${I(d)} received from system`);return i?o.unprotectUser(t,d.body).then(function(i){l.default.debug(l.default.DEBUG2,"%s: Unprotected identity message from m=%s M=%s r=%s: ",g,e,r,t,s.e(i));const d=E(i.data);if(d.verified=i.verified,l.default.debug(l.default.DEBUG2,"%s: Parsed message from m=%s M=%s r=%s: %s",g,e,r,t,s.e(d)),!i.verified){const s=new a.ProtectionError("Ignoring unverified "+I(d));throw s.retry=(()=>o.receiveJson(e,t,r,n)),s}return R(o,d,t)}).catch(i=>{if(Object(l.default)(l.default.ERROR,"%s: Failed to receive message from m=%s M=%s r=%s: %s",g,e,r,t,i),l.default.logErrorForDebugging(i),i instanceof s.a){const s=new a.ProtectionError(i);throw s.retry=(()=>o.receiveJson(e,t,r,n)),s}throw i}):o.unprotectChat(e,t,d.body).then(function(a){l.default.debug(l.default.DEBUG2,"%s: Unprotected chat message from m=%s M=%s r=%s: ",g,e,r,t,s.e(a));const i=E(a.data);return i.verified=!0===a.verified,i.verified||(i.retry=(()=>o.receiveJson(e,t,r,n))),l.default.debug(l.default.DEBUG2,"%s: Parsed message from m=%s M=%s r=%s: %s",g,e,r,t,s.e(i)),P(i)}).catch(function(s){throw Object(l.default)(l.default.ERROR,"%s: Failed to receive message from m=%s M=%s r=%s: %s",g,e,r,t,s),l.default.logErrorForDebugging(s),s});default:if(!o.protectionRequired||"leave"===d.name||"restoreMarker"===d.name||"metadataChanged"===d.name||"appMessage"===d.name||"chatRemoved"===d.name&&"system"===t)return Promise.resolve(i?R(o,d,t):P(d));throw new TypeError("Ignoring unprotected "+I(d)+"; protection is required")}}catch(s){return Object(l.default)(l.default.ERROR,"%s: Failed to receive message from m=%s M=%s r=%s: %s",g,e,r,t,s),l.default.logErrorForDebugging(s),Promise.reject(s)}};let S=0;y.prototype.receive=function(e,t,r){let a=++S;try{return Object(l.default)(l.default.DEBUG2,"%s: Receiving message from m=%s M=%s r=%s d=%s",g,e,a,t,Object(c.array2hex)(r)),this.receiveJson(e,t,a,s.c(r))}catch(e){return Object(l.default)(l.default.WARNING,"%s: Failed to decode JSON8: %s; data=%s",g,e,Object(c.array2hex)(r)),l.default.logErrorForDebugging(e),Promise.reject(e)}}},function(e,t,r){"use strict";function s(e){this.tokenFetcher=e,this.promises=[],this.token=void 0,this.requestOutstanding=!1,this.refreshNeeded=!0,this.expiryTimerId=void 0,this.get().catch(function(){})}t.a=s,s.prototype.get=function(){var e=this;return!1===e.refreshNeeded&&void 0!==e.token?Promise.resolve(e.token):(!1===e.requestOutstanding&&(e.requestOutstanding=!0,e.tokenFetcher().then(function(t){!function(e,t){e.token=t,e.oauthToken=t.oauthToken,e.refreshNeeded=!1;var r=t.expiry-Date.now();r<=2147483647&&(e.expiryTimerId=setTimeout(function(){e.refreshNeeded=!0,e.expiryTimerId=void 0},r)),e.promises.forEach(function(t){t.resolve(e.token)}),e.promises=[]}(e,t),e.requestOutstanding=!1}).catch(function(t){console.error("Failed to fetch BBM token.  Rejecting "+e.promises.length+" promise(s) with error="+t),e.promises.forEach(function(e){e.reject(t)}),e.promises=[],e.requestOutstanding=!1})),new Promise(function(t,r){e.promises.push({resolve:t,reject:r})}))},s.prototype.refresh=function(){return this.refreshNeeded=!0,this.get()},s.prototype.reset=function(){this.expiryTimerId&&(clearTimeout(this.expiryTimerId),this.expiryTimerId=void 0)}},function(e,t,r){"use strict";var s=r(17);t.a=class{constructor(){const e={chats:new Map,list:void 0};a.set(this,e)}size(){return a.get(this).chats.size}get(e){return a.get(this).chats.get(e)}set(e){if(!(e instanceof s.a))throw new TypeError("Refusing to cache chat that isn't an instance of Messenger.Chat");const t=a.get(this);t.chats.set(e.chatId,e),t.list=void 0}remove(e){const t=a.get(this);!0===t.chats.delete(e)&&(t.list=void 0)}getAll(){const e=a.get(this);return void 0===e.list&&(e.list=Object.freeze(Array.from(e.chats.values()))),e.list}};const a=new WeakMap},function(e,t,r){"use strict";var s=r(17),a=r(27),n=r(41),o=r(28),i=r(12),d=r(10),c=r(0),l=r(7),u=r(4),p=r(3),f=r(1),g=r(2);const h="MailboxFetcher";t.a=class{constructor(e,t,r,s,a,n,o){const i={messengerData:e,requestManager:t,mailboxFilter:r,kmsMode:s,emitFunction:a,leaveChatFunction:n,removeChatFunction:o,outstanding:new Map};y.set(this,i)}fetch(e){return b(this,e)}store(e){const t=y.get(this);return void 0===t.mailboxFilter||t.mailboxFilter.has(e.id)?(Object(f.default)(f.default.INFO,"%s: Storing mailboxId=%s",h,e.id),function(e,t){const r=e.messengerData.db.getChat(t.id);let y=e.messengerData.chatCache.get(t.id);return void 0===y?function(e,t){Object(f.default)(f.default.INFO,"%s: Creating chat for mailboxId=%s",h,t.id);try{e.messengerData.db.createChat(t.id,o.a.State.WaitingForKey,t.members.map(e=>({regId:e.regId.toString().valueOf(),state:i.a.State.Active,admin:!0===e.admin})),n.a(t,e.messengerData.registrationInfo.regId)===d.a.Description.OneToOne)}catch(r){return r instanceof c.DuplicateError?Object(f.default)(f.default.NOTICE,"%s: Refusing to create chat for mailboxId=%s: %s",h,t.id,r):(Object(f.default)(f.default.ERROR,"%s: Failed to create chat for mailboxId=%s: %s",h,t.id,r),e.leaveChatFunction(t.id).catch(e=>{Object(f.default)(f.default.ERROR,"%s: Failed to leave mailboxId=%s: %s",h,t.id,e)})),Promise.reject(r)}if(e.kmsMode){Object(f.default)(f.default.INFO,"%s: Storing chat key in KMS",h);const r=e.messengerData.keyManager;return void 0===t.protectedKey||void 0===t.protectedKey.payload||void 0===t.protectedKey.mac||void 0===t.protectedKey.nonce||void 0===r.mgmtKey?e.leaveChatFunction(t.id).then(()=>Promise.reject(new Error("Leaving chat with id="+t.id+"; no protectedKey found"))):Object(u.authDecrypt)({content:t.protectedKey.payload,tag:t.protectedKey.mac},t.protectedKey.nonce,r.mgmtKey).then(s=>(r.setChatKey(t.id,s),I(e,t).catch(e=>Promise.reject(e)))).catch(r=>(Object(f.default)(f.default.WARNING,"%s: Failed to store chat key in KMS: %s",h,r),e.leaveChatFunction(t.id).then(()=>Promise.reject(new Error("Leaving chat with id="+t.id+"; failed to decrypt protectedKey: "+r.message)))))}return I(e,t).catch(e=>Promise.reject(e))}(e,t).catch(r=>{throw r instanceof c.DuplicateError&&e.leaveChatFunction(t.id),r}).then(t=>(function(e,t){if(Object(f.default)(f.default.DEBUG1,"%s: Resolving 1:1 conflicts for %s",h,t),!1===t.isOneToOne||t.state===s.a.State.Defunct)return Object(f.default)(f.default.DEBUG1,"%s: No need to resolve conflicts for %s that isn't 1:1 or non-Defunct",h,t),Promise.resolve(t);var r=t.participants[0].regId===e.messengerData.registrationInfo.regId?t.participants[1].regId:t.participants[0].regId;const a=e.messengerData.db.getPeerChatId(r);if(!a)return e.messengerData.db.addPeerChatId(r,t.chatId),Object(f.default)(f.default.DEBUG1,"%s: No existing 1:1 with regId=%s found to conflict with %s",h,r,t),Promise.resolve(t);if(a===t.chatId)return Object(f.default)(f.default.DEBUG1,"%s: %s is already the current 1:1 with regId=%s",h,t,r),Promise.resolve(t);const n=e.messengerData.chatCache.get(a);let o,i;return Object(p.default)(void 0!==n),n.creationTime>t.creationTime?(i=n,o=t):(i=t,o=n,e.messengerData.db.addPeerChatId(r,t.chatId)),Object(f.default)(f.default.INFO,"%s: Found duplicate 1:1 chat for peer regId=%s; leaving %s (%s) and keeping %s (%s)",h,r,o,o.creationTime,i,i.creationTime),e.leaveChatFunction(o.chatId).catch(e=>(Object(f.default)(f.default.ERROR,"Failed to leave chatId=%s: %s",h,o.chatId,e),t)).then(()=>{if(o.chatId===t.chatId)throw new c.DuplicateError;return t})})(e,t)).then(e=>e):e.messengerData.keyManager.getChatKey(t.id).catch(e=>(Object(f.default)(f.default.WARNING,"%s: Could not get chat key for Chat %s; subject will not be updated; error=%s",h,t.id,e),null)).then(r=>null===r?(Object(f.default)(f.default.DEBUG1,"%s: Key not found for chatId=%s",h,t.id),[null,null]):Promise.all([e.messengerData.rim_im.unprotectServerSubject(t,r).catch(e=>(Object(f.default)(f.default.NOTICE,"%s: Failed to decrypt subject for chatId=%s; error=%s; ignoring",h,t.id,e),null)),(void 0===t.data?Promise.resolve():e.messengerData.rim_im.unprotectServerData(t,r)).catch(e=>(Object(f.default)(f.default.NOTICE,"%s: Failed to decrypt data for chatId=%s; error=%s; ignoring",h,t.id,e),null))])).then(o=>{const c=o[0],u=o[1];function p(e,t){return e.regId<t.regId?-1:e.regId>t.regId?1:0}const m=Array.from(r.participants.values()).sort(p),b=t.members.map(e=>new a.a(e.regId.toString().valueOf(),a.a.State.Active,!0===e.admin)).sort(p);let I=(0===m.length||0===b.length)&&m.length!==b.length;function v(e){Object(f.default)(f.default.INFO,"%s: Found new participant for chatId=%s with regId=%s; adding",h,r.id,e.regId),r.createParticipant(e.regId,i.a.State.Active,e.isAdmin),I=!0}function M(e){e.state===i.a.State.Active&&(Object(f.default)(f.default.INFO,"%s: Participant for chatId=%s with regId=%s is no longer in  the chat; removing",h,r.id,e.regId),e.state=i.a.State.Left,I|=e.updateExternalView())}for(let e=0,t=0,r=m.length,s=b.length;e<r||t<s;){const a=m[e],n=b[t];e!==r?t!==s?a.regId!==n.regId?a.regId>n.regId?(v(n),++t):(M(a),++e):(a.state=i.a.State.Active,a.isAdmin=n.isAdmin,I|=a.updateExternalView(),++e,++t):(M(a),++e):(v(n),++t)}try{const s=n.d(r,t.description,e.messengerData.registrationInfo.regId);if(y.isOneToOne&&!s){const r=(y=y.withNewType(s)).participants[0].regId===e.messengerData.registrationInfo.regId?y.participants[1].regId:y.participants[0].regId;e.messengerData.db.removePeerChatId(r,t.id),I=!0}}catch(r){throw Object(f.default)(f.default.ERROR,"%s: Failed to determine chat type for chatId=%s; error=%s",h,t.id,r),e.leaveChatFunction(t.id).catch(function(e){Object(f.default)(f.default.ERROR,"%s: Failed to leave %s: %s",h,y,e)}),r}I&&(y=y.withNewParticipants(r.getParticipantExternalViews()));const w={};null!==c&&(w.subject=Object(g.truncate)(c,128)),t.invitePolicy!==d.a.InvitePolicy.Anyone?w.invitePolicy=t.invitePolicy===d.a.InvitePolicy.AdminOnly?s.a.InvitePolicy.AdminsOnly:s.a.InvitePolicy.ParticipantsOnly:Object(f.default)(f.default.NOTICE,"%s: Ignoring unknown or unsupported invite policy %s for mailboxId=%s",h,t.invitePolicy,t.id),null!==u&&(w.data=u);const O=y.withUpdate(w,new Date(t.createdTime));return void 0!==O&&(y=O,I=!0),I&&(e.messengerData.chatCache.set(y),e.emitFunction("chatUpdated",new l.ChatUpdated(y))),y}).catch(function(e){return Object(f.default)(f.default.ERROR,"%s: Failed to update chatId=%s; error=%s",h,t.id,e),y})}(t,e)):(Object(f.default)(f.default.NOTICE,"%s: Refusing to store mailbox id=%s that isn't in the filter",h,e.id),Promise.reject(new c.Error("mailbox not in filter")))}fetchAndStore(e,t=!1){return!1===t?b(this,e,!0):void b(this,e,!0).then(()=>{}).catch(t=>{Object(f.default)(f.default.WARNING,"%s: Failed to fetch and store mailboxId=%s: %s; ignoring",h,e,t)})}fetching(e){return y.get(this).outstanding.has(e)}};const y=new WeakMap;function m(e){let t="";return!0===e.again&&(t+="A"),!0===e.inProgress&&(t+="P"),!0===e.store&&(t+="S"),t}function b(e,t,r=!1){const s=y.get(e);if(void 0!==s.mailboxFilter&&!s.mailboxFilter.has(t))return Object(f.default)(f.default.NOTICE,"%s: Refusing to fetch mailbox id=%s that isn't in the filter",h,t),Promise.reject(new c.Error("mailbox not in filter"));let a=s.outstanding.get(t);if(void 0===a)(a={promise:void 0,resolve:void 0,reject:void 0,store:r,again:!1,inProgress:!0}).promise=new Promise((e,t)=>{a.resolve=e,a.reject=t}),s.outstanding.set(t,a),Object(f.default)(f.default.INFO,"%s[%s]: Initiating new fetch %sfor mailboxId=%s",h,m(a),r?"and store ":"",t);else{if(!0===a.inProgress)return a.again=!0,Object(f.default)(f.default.INFO,"%s[%s]: Fetch %sfor mailboxId=%s already in progress; subsequent fetch %sscheduled",h,m(a),a.store?"and store ":"",t,r?"and store ":""),!0===r&&(a.store=!0),a.promise;a.inProgress=!0,Object(f.default)(f.default.INFO,"%s[%s]: Initiating subsequent fetch %sfor mailboxId=%s",h,m(a),a.store?"and store ":"",t)}const n=(r,a)=>{const n=s.outstanding.get(t);Object(p.default)(void 0!==n),n.inProgress=!1,!0===n.again?(Object(f.default)(f.default.INFO,"%s[%s]: Ignoring result of fetch for mailboxId=%s; will issue subsequent request",h,m(n),t),n.again=!1,e.fetch(t)):(s.outstanding.delete(t),void 0!==r?n.resolve(r):((a instanceof c.Forbidden||a instanceof c.NotFound)&&s.removeChatFunction(t,!0),n.reject(a)))};return s.requestManager.retryableRequest(()=>s.messengerData.managementClient.getMailbox(t)).then(r=>{const a=s.outstanding.get(t);if(Object(f.default)(f.default.INFO,"%s[%s]: Fetch for mailboxId=%s completed",h,m(a),t),!0===a.store&&!1===a.again)return e.store(r);n(r)}).then(e=>{if(void 0!==e){const r=s.outstanding.get(t);Object(f.default)(f.default.INFO,"%s[%s]: Store for mailboxId=%s completed",h,m(r),t),n(e)}}).catch(e=>{const r=s.outstanding.get(t);Object(f.default)(f.default.WARNING,"%s[%s]: Fetch %sfor mailboxId=%s failed: %s",h,m(r),r.store?"and store ":"",t,e),n(void 0,e)}),a.promise}function I(e,t){return e.messengerData.keyManager.getChatKey(t.id).catch(function(e){if(e instanceof c.NotFoundError)throw e;return Object(f.default)(f.default.NOTICE,"%s: Could not get chat key for chatId=%s; proceeding without subject or application data; error=%s",h,t.id,e),null}).then(function(r){if(null===r)return["",void 0];const s=e.messengerData.db.findChat(t.id);if(s.state!==o.a.State.WaitingForKey)throw new c.Error(`Chat data state changed to ${s.state} while waiting for `+`key to create mailbox for chatId=${t.id}`);return s.state=o.a.State.Restore,Promise.all([e.messengerData.rim_im.unprotectServerSubject(t,r).catch(e=>(Object(f.default)(f.default.WARNING,"%s: Invalid subject in chatId=%s; leaving blank; error=%s",h,t.id,e),"")),(void 0===t.data?Promise.resolve():e.messengerData.rim_im.unprotectServerData(t,r)).catch(e=>(Object(f.default)(f.default.WARNING,"%s: Invalid data in chatId=%s; error=%s; ignoring",h,t.id,e),{}))])}).then(r=>{const a=e.messengerData.db.findChat(t.id);if(a.state!==o.a.State.Restore)throw new c.Error(`Chat data state changed to ${a.state} while unprotecting `+`metadata to create mailbox for chatId=${t.id}`);const i=r[0],u=r[1];Object(f.default)(f.default.DEBUG2,"%s: Parsed subject='%s' for chatId=%s",h,i,t.id),Object(f.default)(f.default.DEBUG2,"%s: Parsed data='%s' for chatId=%s",h,JSON.stringify(u),t.id);const p=Object(g.truncate)(i,128);if("chat"!==t.type){const r=`Ignoring chatId=${t.id} with unknown `+`type=${t.type}`;throw Object(f.default)(f.default.ERROR,"%s: %s",h,r),e.removeChatFunction(t.id),new c.Error(r)}try{const r=n.d(a,t.description,e.messengerData.registrationInfo.regId),o=new s.a(t.id,new Date(t.createdTime),r,s.a.State.Waiting,p,a.getParticipantExternalViews(),r?void 0:t.invitePolicy===d.a.InvitePolicy.AdminOnly?s.a.InvitePolicy.AdminsOnly:s.a.InvitePolicy.ParticipantsOnly,new Date(0),u);return e.messengerData.chatCache.set(o),e.emitFunction("chatAdded",new l.ChatAdded(o)),o}catch(r){throw e.leaveChatFunction(t.id).catch(function(e){Object(f.default)(f.default.ERROR,"%s: Failed to leave chatId=%s; error=%s",h,t.id,e)}),r}}).catch(function(r){throw r instanceof c.NotFoundError?(Object(f.default)(f.default.INFO,"%s: Failed to recover key for chatId=%s; automatically leaving chat",h,t.id),e.leaveChatFunction(t.id).catch(function(e){Object(f.default)(f.default.ERROR,"%s: Failed to leave chatId=%s; error=%s",h,t.id,e)})):Object(f.default)(f.default.ERROR,"%s: Chat id=%s was not created; error=%s",h,t.id,r),new c.Error("Failed to create chat")})}},function(e,t,r){"use strict";t.a=function e(t,r){var n=this;Object(a.default)("function"==typeof t,"compareFunction must be a function");Object(a.default)(void 0===r||Array.isArray(r),"storageArray must be an Array when defined");var o=t;var i=r||[];var d=i;Object.defineProperty(n,"size",{enumerable:!0,get:function(){return i.length}});Object.defineProperty(n,"data",{enumerable:!0,get:function(){return d}});n.insert=function(e,t){var r=n.getInsertPosition(e,t);return r.index>=i.length?(i.splice(i.length,0,e),{result:!0,index:i.length-1}):r.isDuplicate?{result:!1,index:r.index}:(i.splice(r.index,0,e),{result:!0,index:r.index})};n.replace=function(e,t){var r=n.getInsertPosition(e,t);return r.index>=i.length?(i.splice(i.length,0,e),{replaced:!1,index:i.length-1}):r.isDuplicate?(i.splice(r.index,1,e),{replaced:!0,index:r.index}):(i.splice(r.index,0,e),{replaced:!1,index:r.index})};n.union=function(t,r){Object(a.default)(t instanceof e,"The set parameter must be an instance of ArraySetAdapter");let o=[];if(0===t.size)return o;if(0===i.length)return Object(s.spliceArray)(i,i.length,0,t.data,0,t.data.length),t.data.slice();for(var d,c=0,l=t.size;c<l;){var u=n.getInsertPosition(t.data[c],d),p=0;if(u.index>=i.length)return Object(s.spliceArray)(i,i.length,p,t.data,c,t.data.length),Object(s.appendToArray)(o,t.data.slice(c)),o;var f=u.index;if(u.isDuplicate){if(!r){++c,d=u.index+1;continue}++p,++f}for(var g={index:c};;){if(f===i.length)return Object(s.spliceArray)(i,u.index,p,t.data,c,t.data.length),Object(s.appendToArray)(o,t.data.slice(c)),o;if(g=t.getInsertPosition(i[f],g.index),!r||!g.isDuplicate)break;++p,++f,++g.index}if(g.index>=t.data.length)return Object(s.spliceArray)(i,u.index,p,t.data,c,t.data.length),Object(s.appendToArray)(o,t.data.slice(c)),o;const e=Object(s.spliceArray)(i,u.index,p,t.data,c,g.index);Object(s.appendToArray)(o,t.data.slice(c,g.index)),c=g.index,d=u.index+e,g.isDuplicate&&++c}return o};n.upperBound=function(e){var t=n.getInsertPosition(e);return t.isDuplicate&&(Object(a.default)(t.index>=0&&t.index<i.length,"Invalid pos.index={0}; m_data.length={1}",t.index,i.length),++t.index),Object(a.default)(t.index>=0&&t.index<=i.length,"Invalid pos.index={0}; m_data.length={1}",t.index,i.length),t.index};n.erase=function(e,t){Object(a.default)(e>=0,"Invalid begin={0}; m_data.length={1}",e,i.length),Object(a.default)(t<=i.length,"Invalid end={0}; m_data.length={1}",t,i.length),Object(a.default)(e<=t,"Invalid range; begin={0} end={1}",e,t);var r=t-e;if(Object(a.default)(r>=0&&r<=i.length,"Invalid count={0} removal; begin={1} m_data.length={2}",r,e,i.length),0===r)return[];var s=i.splice(e,r);return s};n.getInsertPosition=function(e,t){return n.getPosition(e,o,t)};n.getPosition=function(e,t,r){var s,n,o=0,d=i.length-1;if(void 0!==r&&i.length>0&&0<=r&&r<=i.length){r===i.length&&(r=i.length-1);for(var c=[],l=0;l<2;++l){if(r<0)return{index:0,isDuplicate:!1};if(r===i.length)return{index:i.length,isDuplicate:!1};if(c.push({index:r,result:t(i[r],e)}),c[l].result<0)o=++r;else{if(!(c[l].result>0))return{index:r,isDuplicate:!0};d=--r}}if(Object(a.default)(2===c.length,"Expected 2 comparisons to be made; got {0}",c.length),c[0].result!==c[1].result)return{index:c[0].result>0?c[0].index:c[1].index,isDuplicate:!1}}for(;o<=d;){n=i[s=(o+d)/2|0];var u=t(n,e);if(u<0)o=s+1;else{if(!(u>0))return{index:s,isDuplicate:!0};d=s-1}}return{index:o,isDuplicate:!1}};0};var s=r(2),a=r(3)},function(e,t,r){"use strict";var s=r(44),a=r(28),n=r(12),o=r(5),i=r(0);t.a=class{constructor(e,t){Object.defineProperty(this,"messageStorageFactory",{value:e}),Object.defineProperty(this,"regId",{value:t}),Object.defineProperty(this,"chats",{value:new Map}),Object.defineProperty(this,"identityMailboxId",{value:`id.${t}`}),Object.defineProperty(this,"identityBookmarkData",{value:new s.a}),Object.defineProperty(this,"peerPromises",{value:new Map}),Object.defineProperty(this,"peerChatIds",{value:new Map})}createChat(e,t,r=[],s=!1){if(this.chats.has(e))throw new i.DuplicateError(`Chat with mailboxId=${e} already exists`);let n=!1,o=!1;for(const e of r)e.regId===this.regId?n=!0:o=!0;if(r.length>0&&!n)throw new i.Error("Participants must include the local user");if(s){if(2!==r.length||!n||!o)throw new i.Error("1:1 chats must include the local user and one other peer");const e=r[0].regId===this.regId?r[1].regId:r[0].regId;if(this.peerPromises.has(e))throw new i.DuplicateError(`1:1 chat with regId=${e} already being created`)}const d=new a.a(this.messageStorageFactory,e,t);for(const e of r)d.createParticipant(e.regId,e.state,e.admin);return this.chats.set(e,d),d}addPeerPromise(e,t){this.peerPromises.set(e,t)}getPeerPromise(e){return this.peerPromises.get(e)}removePeerPromise(e){this.peerPromises.delete(e)}addPeerChatId(e,t){this.peerChatIds.set(e,t)}getPeerChatId(e){return this.peerChatIds.get(e)}removePeerChatId(e,t){void 0!==t&&this.peerChatIds.get(e)!==t||this.peerChatIds.delete(e)}findChat(e){var t=this.chats.get(e);if(!t)throw new i.NotFoundError("Could not find chat with chatId="+e);return t}getChat(e){return this.chats.get(e)}removeChat(e){this.chats.delete(e)}findBookmarkData(e){if(e.startsWith("id.")){if(e===this.identityMailboxId)return this.identityBookmarkData;throw new i.NotFoundError("No such bookmark: "+e)}return this.findChat(e).bookmarkData}updateChatAndParticipantStateData(e,t){let r,s,a=!1;for(const r of t){const t=r.regId,s=r.status;t===this.regId&&r.messageId.isGreaterThan(e.statusMessageId)&&(e.statusMessageId=r.messageId);const i=void 0!==s.r?new o.a(s.r):void 0,d=void 0!==s.d?new o.a(s.d):i;let c=e.getParticipant(t);if(void 0===c&&(c=e.createParticipant(t,n.a.State.Left,!1)),d){const s=c.deliveredMsgId;s.isLessThan(d)&&(c.deliveredMsgId=d,c.deliveredTimestamp=r.timestamp),a||t===this.regId||(a=d.isGreaterThan(e.partialDeliveredMsgId)||s.isLessThanOrEqual(e.fullDeliveredMsgId))}if(i){const s=c.readMsgId;s.isLessThan(i)&&(c.readMsgId=i,c.readTimestamp=r.timestamp),a||t===this.regId||(a=i.isGreaterThan(e.partialReadMsgId)||s.isLessThanOrEqual(e.fullReadMsgId))}}if(a){for(const[t,a]of e.participants){if(t===this.regId||"Active"!==a.state)continue;const n=a.deliveredMsgId,o=a.readMsgId;(void 0===r||r.isGreaterThan(n))&&(r=n),n.isGreaterThan(e.partialDeliveredMsgId)&&(e.partialDeliveredMsgId=n),(void 0===s||s.isGreaterThan(o))&&(s=o),o.isGreaterThan(e.partialReadMsgId)&&(e.partialReadMsgId=o)}r&&(e.fullDeliveredMsgId=r),s&&(e.fullReadMsgId=s)}}}},function(e,t,r){"use strict";t.a=y;var s=r(69),a=r.n(s),n=r(46),o=r(71),i=r(5),d=r(0),c=r(3),l=r(2),u=r(1),p=d.PermanentFailure,f=d.TemporaryFailure,g=d.Forbidden,h=d.NotFound;function y(e){var t=new m(e);Object.defineProperty(this,"_private",{enumerable:!1,get:function(){if(!1===m.isAccessAllowed)throw new TypeError("Illegal access of private data");return t}})}function m(e){this.name="ContentClient",this.sipTransport=e}function b(e){try{var t=e.body;if(!t)throw"No body";delete e.body;var r="";return Object.keys(e).forEach(function(t){r+=t+"="+e[t]+" "}),r+="body="+Object(l.array2hex)(t)}catch(t){return e instanceof Error?e.toString():JSON.stringify(e)}}y.prototype.post=function(e,t,r){r=Object.assign({onlineOnly:!1,pushAsStatus:!1,replaces:[],replacesAll:void 0},r);var s=m.getPrivateData(this);return Object(c.default)("string"==typeof e&&e.length>0,"mailboxId inconsistent with expectations"),Object(c.default)(t instanceof Uint8Array&&t.length>0,"message inconsistent with expectations"),Object(c.default)(Array.isArray(r.replaces),"options.replaces inconsistent with expectations"),Object(c.default)(void 0===r.replacesAll||r.replacesAll instanceof i.a,"options.replacesAll inconsistent with expectations"),Object(u.default)(u.default.INFO,"%s: Posting message size=%d to m=%s",s.name,t.length,e),new Promise(function(n,o){var l,h;try{var y=new a.a.PostRequest,m=new a.a.PostRequest.MetaData;m.setType(0),m.setSubType(0),!0===r.onlineOnly&&m.setOnlineOnly(!0),!0===r.pushAsStatus&&m.setPushAsStatus(!0);for(const e of r.replaces)Object(c.default)(e instanceof i.a&&!e.isEmpty(),"options.replaces inconsistent with expectations"),m.addReplaces(e.binary);void 0!==r.replacesAll&&m.setReplacesAll(r.replacesAll.binary),y.setMetaData(m),y.setMessageData(t),h=y.serializeBinary()}catch(t){return t instanceof d.AssertionError?void o(t):void o(new p("Failed to create post request for chatId="+e+"; error="+t))}try{l=s.sipTransport.mcpPost(e,h)}catch(t){return void o(new f("Failed to send post request for mailboxId="+e+"; error="+t))}l.then(function(r){try{if(!r)return void o(new p("Bad post response for mailboxId="+e+": "+b(r)));if(!r.mbx_id||r.mbx_id!=e)return void o(new p("MailboxId mismatch; expected post response for mailboxId="+e+": "+b(r)));if(200!=r.status_code)return void o(new p("Unexpected failure in post response for mailboxId="+e+"; cause="+r.cause+"; code="+r.status_code));var d=a.a.PostResponse.deserializeBinary(r.body),c=new i.a(d.getMessageId_asU8());if(0===c.length)return void o(new p("No MessageId in post response for mailboxId="+e+": "+b(r)));Object(u.default)(u.default.INFO,"%s: Posted message size=%d to m=%s with M=%s",s.name,t.length,e,c),n(c)}catch(t){o(new p("Failed to parse post response for mailboxId="+e+"; error="+t+"; response="+b(r)))}}).catch(function(t){if(t&&t.status_code){var r=p;401==t.status_code||408==t.status_code||480==t.status_code||t.status_code>=500&&t.status_code<600?r=f:403==t.status_code&&(r=g),o(new r("Post for mailboxId="+e+" failed; cause="+t.cause+"; code="+t.status_code))}else o(new p("Post for mailboxId="+e+" failed; response="+b(t)))})})},y.prototype.pull=function(e,t,r,s){Object(c.default)("string"==typeof e&&e.length>0,"Parameter 1 inconsistent with expectations"),Object(c.default)(void 0===t||t instanceof i.a,"Parameter 2 inconsistent with expectations"),Object(c.default)(void 0===r||r instanceof i.a,"Parameter 3 inconsistent with expectations");var d=m.getPrivateData(this);return t=t||new i.a,r=r||new i.a,Object(u.default)(u.default.DEBUG1,"%s: Pulling %s from m=%s; p=%s s=%s",d.name,s?"forward":"in reverse",e,t,r),new Promise(function(c,l){var y,m;try{var I=new a.a.PullRequest;!0!==s&&I.setReadDirection(a.a.PullRequest.ReadDirection.REVERSE),!1===t.isEmpty()&&I.setMessageId(t.binary),!1===r.isEmpty()&&I.setStopMessageId(r.binary),m=I.serializeBinary()}catch(t){return void l(new p("Failed to create pull request for mailboxId="+e+"; error="+t))}try{y=d.sipTransport.mcpPull(e,m)}catch(t){return void l(new f("Failed to send pull request for mailboxId="+e+"; error="+t))}y.then(function(f){Object(u.default)(u.default.DEBUG1,"%s: Received pull %s response for m=%s; p=%s s=%s",d.name,s?"forward":"in reverse",e,t,r);try{if(!f)throw"Bad pull response";if(!f.mbx_id||f.mbx_id!=e)throw"MailboxId mismatch; expected response for mailboxId="+e;if(200!=f.status_code)throw"Unexpected failure in resolution";var g=a.a.PullResponse.deserializeBinary(f.body),h={messages:[],nextPullPoint:void 0,serverBookmark:void 0,syncDelay:void 0},y=new i.a,m=new i.a,I=g.getEntryList();for(const a of I){var v=a.getMetaData(),M=new o.a(new i.a(v.getMessageId_asU8()),v.getUserId(),v.getTimestamp(),new n.a(a.getMessageData_asU8()),!0,!1);if(y.isEmpty()&&(y=M.messageId),M.messageId.isLessThan(m))throw"Messages are out of order";m=M.messageId,(s?(t.isEmpty()||m.isGreaterThanOrEqual(t))&&(r.isEmpty()||m.isLessThan(r)):(r.isEmpty()||m.isGreaterThan(r))&&(t.isEmpty()||m.isLessThanOrEqual(t)))?h.messages.push(M):Object(u.default)(u.default.WARNING,"%s: Discarding %s from m=%s; not in %s pull range p=%s s=%s",d.name,M,e,s?"forward":"reverse",t,r)}var w=new i.a(g.getNextMessageId_asU8());!1===w.isEmpty()&&((s?0!==I.length&&!w.isGreaterThan(m)||!t.isEmpty()&&!w.isGreaterThan(t):0!==I.length&&!w.isLessThan(y)||!t.isEmpty()&&!w.isLessThan(t))?Object(u.default)(u.default.WARNING,"%s: Discarding np=%s; value is too %s",d.name,w,s?"small":"large"):h.nextPullPoint=w);var O=new i.a(g.getServerBookmark_asU8());if(0===O.length)throw"No ServerBookmark";h.serverBookmark=O,g.hasBookmarkSyncDelay()&&(h.syncDelay=g.getBookmarkSyncDelay()),c(h)}catch(t){l(new p("Failed to parse pull response for mailboxId="+e+"; error="+t+"; response="+b(f)))}}).catch(function(a){if(Object(u.default)(u.default.DEBUG1,"%s: Failed pull %s response for m=%s; p=%s s=%s",d.name,s?"forward":"in reverse",e,t,r),a&&a.status_code){var n=f;403==a.status_code?n=g:404==a.status_code&&(n=h),l(new n("Pull for mailboxId="+e+" failed; cause="+a.cause+"; code="+a.status_code))}else l(new p("Pull for mailboxId="+e+" failed; response="+b(a)))})})},y.prototype.sync=function(e){var t=m.getPrivateData(this);return new Promise(function(r,s){var n,o,c={mailboxes:{}};try{var l=new a.a.SyncRequest;e.forEach(function(e){try{var r=new a.a.SyncRequest.Mailbox;if("string"!=typeof e.mailboxId||0===e.mailboxId.length)throw"mailbox to sync must have a non-empty string mailboxId";if(r.setMailboxId(e.mailboxId),!(e.bookmark instanceof i.a))throw"mailbox to sync does not have a MessageId bookmark";if(r.setClientBookmark(e.bookmark.binary),void 0!==e.maxMessageId){if(!(e.maxMessageId instanceof i.a))throw"mailbox to sync must have a MessageId maxMessageId";e.maxMessageId.isEmpty()||r.setMaxMessageId(e.maxMessageId.binary)}l.addMailboxes(r),c.mailboxes[e.mailboxId]={}}catch(r){Object(u.default)(u.default.WARNING,"%s: Ignoring mailbox to sync; error=%s: %s",t.name,r,JSON.stringify(e))}}),o=l.serializeBinary()}catch(t){throw new p("Failed to create sync request for "+e.length+" mailbox(es); error="+t)}if(0!==o.length){try{n=t.sipTransport.mcpSync(o)}catch(t){throw new f("Failed to send sync request for "+e.length+" mailbox(es); error="+t)}n.then(function(e){try{if(!e)throw"Bad sync response";if(!e.mbx_id||"sync"!=e.mbx_id)throw"MailboxId mismatch; expected response for mailboxId=sync";if(200!=e.status_code)throw"Unexpected failure in resolution";var t=a.a.SyncResponse.deserializeBinary(e.body),n=new i.a(t.getServerBookmark_asU8());if(0===n.length)throw"No ServerBookmark";c.serverBookmark=n,t.getErrorList().forEach(function(e){var t=e.getMailboxId(),r=c.mailboxes[t];if(!r)throw"Received MailboxError for mailboxId="+t+" that was not in sync request";if(r.error)throw"Received duplicate MailboxError for mailboxId="+t;switch(e.getError()){case a.a.SyncResponse.MailboxError.Error.NOTSUBSCRIBED:r.error=new d.Forbidden;break;case a.a.SyncResponse.MailboxError.Error.NOTFOUND:r.error=new d.NotFound;break;default:throw"Received unknown MailboxError for mailboxId="+t+": Error="+e.getError()}}),t.getMailboxesList().forEach(function(e){var t=e.getMailboxId(),r=c.mailboxes[t];if(!r)throw"Received Mailbox result for mailboxId="+t+" that was not in sync request";if(r.error)throw"Received MailboxError and Mailbox results for mailboxId="+t;if(r.nextPullPoint||r.ids)throw"Received duplicate Mailbox result for mailboxId="+t;var s=new i.a(e.getNextMessageId_asU8());s.length>0&&(r.nextPullPoint=s);var a=e.getIdList_asU8();a.length>0&&(r.ids=[]);var n=new i.a;a.forEach(function(e){var s=new i.a(e);if(s.isEmpty())throw"Received empty id in Mailbox result for mailboxId="+t;if(!n.isLessThan(s))throw"Received id list with messageIds out of order";r.ids.push(s),n=s})}),r(c)}catch(t){s(new p("Failed to parse sync response; error="+t+"; response="+b(e)))}}).catch(function(e){e&&e.status_code?s(new f("Sync for "+Object.keys(c.mailboxes).length+" mailbox(es) failed; cause="+e.cause+"; code="+e.status_code)):s(new p("Sync for "+Object.keys(c.mailboxes).length+" mailbox(es) failed; response="+b(e)))})}else r({})})},y.prototype.receiveOnlineMessage=function(e,t){var r=e.mbx_id;if("string"!=typeof r||0===r.length)throw new d.Error("Received online message for an invalid mailboxId="+r);try{var s=a.a.OnlineMessage.deserializeBinary(e.body).getEntryList();for(const e of s){var c=e.getMetaData();t({mailboxId:r,messageData:new o.a(new i.a(c.getMessageId_asU8()),c.getUserId(),c.getTimestamp(),new n.a(e.getMessageData_asU8()),!1,c.getOnlineOnly())})}}catch(t){var l=e.body;throw l instanceof Uint8Array&&(l=new n.a(l)),new d.Error("Failed to parse online message received from mailboxId="+r+"; error="+t+"; "+l)}},m.isAccessAllowed=!1,m.getPrivateData=function(e){m.isAccessAllowed=!0;var t=e._private;return m.isAccessAllowed=!1,t}},function(e,t,r){var s=r(70),a=s,n="undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0!==n?n:Function("return this")();a.exportSymbol("proto.OnlineMessage",null,n),a.exportSymbol("proto.OnlineMessage.MailboxEntry",null,n),a.exportSymbol("proto.OnlineMessage.MailboxEntry.MetaData",null,n),a.exportSymbol("proto.PostRequest",null,n),a.exportSymbol("proto.PostRequest.MetaData",null,n),a.exportSymbol("proto.PostResponse",null,n),a.exportSymbol("proto.PullRequest",null,n),a.exportSymbol("proto.PullRequest.ReadDirection",null,n),a.exportSymbol("proto.PullResponse",null,n),a.exportSymbol("proto.PullResponse.MailboxEntry",null,n),a.exportSymbol("proto.PullResponse.MailboxEntry.MetaData",null,n),a.exportSymbol("proto.SyncRequest",null,n),a.exportSymbol("proto.SyncRequest.Mailbox",null,n),a.exportSymbol("proto.SyncResponse",null,n),a.exportSymbol("proto.SyncResponse.Mailbox",null,n),a.exportSymbol("proto.SyncResponse.MailboxError",null,n),a.exportSymbol("proto.SyncResponse.MailboxError.Error",null,n),proto.PostRequest=function(e){s.Message.initialize(this,e,0,-1,null,null)},a.inherits(proto.PostRequest,s.Message),a.DEBUG&&!COMPILED&&(proto.PostRequest.displayName="proto.PostRequest"),s.Message.GENERATE_TO_OBJECT&&(proto.PostRequest.prototype.toObject=function(e){return proto.PostRequest.toObject(e,this)},proto.PostRequest.toObject=function(e,t){var r,s={metaData:(r=t.getMetaData())&&proto.PostRequest.MetaData.toObject(e,r),messageData:t.getMessageData_asB64()};return e&&(s.$jspbMessageInstance=t),s}),proto.PostRequest.deserializeBinary=function(e){var t=new s.BinaryReader(e),r=new proto.PostRequest;return proto.PostRequest.deserializeBinaryFromReader(r,t)},proto.PostRequest.deserializeBinaryFromReader=function(e,t){for(;t.nextField()&&!t.isEndGroup();){switch(t.getFieldNumber()){case 1:var r=new proto.PostRequest.MetaData;t.readMessage(r,proto.PostRequest.MetaData.deserializeBinaryFromReader),e.setMetaData(r);break;case 2:r=t.readBytes();e.setMessageData(r);break;default:t.skipField()}}return e},proto.PostRequest.prototype.serializeBinary=function(){var e=new s.BinaryWriter;return proto.PostRequest.serializeBinaryToWriter(this,e),e.getResultBuffer()},proto.PostRequest.serializeBinaryToWriter=function(e,t){var r=void 0;null!=(r=e.getMetaData())&&t.writeMessage(1,r,proto.PostRequest.MetaData.serializeBinaryToWriter),null!=(r=s.Message.getField(e,2))&&t.writeBytes(2,r)},proto.PostRequest.MetaData=function(e){s.Message.initialize(this,e,0,-1,proto.PostRequest.MetaData.repeatedFields_,null)},a.inherits(proto.PostRequest.MetaData,s.Message),a.DEBUG&&!COMPILED&&(proto.PostRequest.MetaData.displayName="proto.PostRequest.MetaData"),proto.PostRequest.MetaData.repeatedFields_=[3],s.Message.GENERATE_TO_OBJECT&&(proto.PostRequest.MetaData.prototype.toObject=function(e){return proto.PostRequest.MetaData.toObject(e,this)},proto.PostRequest.MetaData.toObject=function(e,t){var r={type:s.Message.getField(t,1),subType:s.Message.getField(t,2),replacesList:t.getReplacesList_asB64(),onlineOnly:s.Message.getFieldWithDefault(t,5,!1),replacesAll:t.getReplacesAll_asB64(),pushAsStatus:s.Message.getField(t,7)};return e&&(r.$jspbMessageInstance=t),r}),proto.PostRequest.MetaData.deserializeBinary=function(e){var t=new s.BinaryReader(e),r=new proto.PostRequest.MetaData;return proto.PostRequest.MetaData.deserializeBinaryFromReader(r,t)},proto.PostRequest.MetaData.deserializeBinaryFromReader=function(e,t){for(;t.nextField()&&!t.isEndGroup();){switch(t.getFieldNumber()){case 1:var r=t.readUint32();e.setType(r);break;case 2:r=t.readUint32();e.setSubType(r);break;case 3:r=t.readBytes();e.addReplaces(r);break;case 5:r=t.readBool();e.setOnlineOnly(r);break;case 6:r=t.readBytes();e.setReplacesAll(r);break;case 7:r=t.readBool();e.setPushAsStatus(r);break;default:t.skipField()}}return e},proto.PostRequest.MetaData.prototype.serializeBinary=function(){var e=new s.BinaryWriter;return proto.PostRequest.MetaData.serializeBinaryToWriter(this,e),e.getResultBuffer()},proto.PostRequest.MetaData.serializeBinaryToWriter=function(e,t){var r=void 0;null!=(r=s.Message.getField(e,1))&&t.writeUint32(1,r),null!=(r=s.Message.getField(e,2))&&t.writeUint32(2,r),(r=e.getReplacesList_asU8()).length>0&&t.writeRepeatedBytes(3,r),null!=(r=s.Message.getField(e,5))&&t.writeBool(5,r),null!=(r=s.Message.getField(e,6))&&t.writeBytes(6,r),null!=(r=s.Message.getField(e,7))&&t.writeBool(7,r)},proto.PostRequest.MetaData.prototype.getType=function(){return s.Message.getFieldWithDefault(this,1,0)},proto.PostRequest.MetaData.prototype.setType=function(e){s.Message.setField(this,1,e)},proto.PostRequest.MetaData.prototype.clearType=function(){s.Message.setField(this,1,void 0)},proto.PostRequest.MetaData.prototype.hasType=function(){return null!=s.Message.getField(this,1)},proto.PostRequest.MetaData.prototype.getSubType=function(){return s.Message.getFieldWithDefault(this,2,0)},proto.PostRequest.MetaData.prototype.setSubType=function(e){s.Message.setField(this,2,e)},proto.PostRequest.MetaData.prototype.clearSubType=function(){s.Message.setField(this,2,void 0)},proto.PostRequest.MetaData.prototype.hasSubType=function(){return null!=s.Message.getField(this,2)},proto.PostRequest.MetaData.prototype.getReplacesList=function(){return s.Message.getRepeatedField(this,3)},proto.PostRequest.MetaData.prototype.getReplacesList_asB64=function(){return s.Message.bytesListAsB64(this.getReplacesList())},proto.PostRequest.MetaData.prototype.getReplacesList_asU8=function(){return s.Message.bytesListAsU8(this.getReplacesList())},proto.PostRequest.MetaData.prototype.setReplacesList=function(e){s.Message.setField(this,3,e||[])},proto.PostRequest.MetaData.prototype.addReplaces=function(e,t){s.Message.addToRepeatedField(this,3,e,t)},proto.PostRequest.MetaData.prototype.clearReplacesList=function(){this.setReplacesList([])},proto.PostRequest.MetaData.prototype.getOnlineOnly=function(){return s.Message.getFieldWithDefault(this,5,!1)},proto.PostRequest.MetaData.prototype.setOnlineOnly=function(e){s.Message.setField(this,5,e)},proto.PostRequest.MetaData.prototype.clearOnlineOnly=function(){s.Message.setField(this,5,void 0)},proto.PostRequest.MetaData.prototype.hasOnlineOnly=function(){return null!=s.Message.getField(this,5)},proto.PostRequest.MetaData.prototype.getReplacesAll=function(){return s.Message.getFieldWithDefault(this,6,"")},proto.PostRequest.MetaData.prototype.getReplacesAll_asB64=function(){return s.Message.bytesAsB64(this.getReplacesAll())},proto.PostRequest.MetaData.prototype.getReplacesAll_asU8=function(){return s.Message.bytesAsU8(this.getReplacesAll())},proto.PostRequest.MetaData.prototype.setReplacesAll=function(e){s.Message.setField(this,6,e)},proto.PostRequest.MetaData.prototype.clearReplacesAll=function(){s.Message.setField(this,6,void 0)},proto.PostRequest.MetaData.prototype.hasReplacesAll=function(){return null!=s.Message.getField(this,6)},proto.PostRequest.MetaData.prototype.getPushAsStatus=function(){return s.Message.getFieldWithDefault(this,7,!1)},proto.PostRequest.MetaData.prototype.setPushAsStatus=function(e){s.Message.setField(this,7,e)},proto.PostRequest.MetaData.prototype.clearPushAsStatus=function(){s.Message.setField(this,7,void 0)},proto.PostRequest.MetaData.prototype.hasPushAsStatus=function(){return null!=s.Message.getField(this,7)},proto.PostRequest.prototype.getMetaData=function(){return s.Message.getWrapperField(this,proto.PostRequest.MetaData,1,1)},proto.PostRequest.prototype.setMetaData=function(e){s.Message.setWrapperField(this,1,e)},proto.PostRequest.prototype.clearMetaData=function(){s.Message.setField(this,1,void 0)},proto.PostRequest.prototype.hasMetaData=function(){return null!=s.Message.getField(this,1)},proto.PostRequest.prototype.getMessageData=function(){return s.Message.getFieldWithDefault(this,2,"")},proto.PostRequest.prototype.getMessageData_asB64=function(){return s.Message.bytesAsB64(this.getMessageData())},proto.PostRequest.prototype.getMessageData_asU8=function(){return s.Message.bytesAsU8(this.getMessageData())},proto.PostRequest.prototype.setMessageData=function(e){s.Message.setField(this,2,e)},proto.PostRequest.prototype.clearMessageData=function(){s.Message.setField(this,2,void 0)},proto.PostRequest.prototype.hasMessageData=function(){return null!=s.Message.getField(this,2)},proto.PostResponse=function(e){s.Message.initialize(this,e,0,-1,null,null)},a.inherits(proto.PostResponse,s.Message),a.DEBUG&&!COMPILED&&(proto.PostResponse.displayName="proto.PostResponse"),s.Message.GENERATE_TO_OBJECT&&(proto.PostResponse.prototype.toObject=function(e){return proto.PostResponse.toObject(e,this)},proto.PostResponse.toObject=function(e,t){var r={messageId:t.getMessageId_asB64(),bookmarkSyncDelay:s.Message.getField(t,2)};return e&&(r.$jspbMessageInstance=t),r}),proto.PostResponse.deserializeBinary=function(e){var t=new s.BinaryReader(e),r=new proto.PostResponse;return proto.PostResponse.deserializeBinaryFromReader(r,t)},proto.PostResponse.deserializeBinaryFromReader=function(e,t){for(;t.nextField()&&!t.isEndGroup();){switch(t.getFieldNumber()){case 1:var r=t.readBytes();e.setMessageId(r);break;case 2:r=t.readUint64();e.setBookmarkSyncDelay(r);break;default:t.skipField()}}return e},proto.PostResponse.prototype.serializeBinary=function(){var e=new s.BinaryWriter;return proto.PostResponse.serializeBinaryToWriter(this,e),e.getResultBuffer()},proto.PostResponse.serializeBinaryToWriter=function(e,t){var r=void 0;null!=(r=s.Message.getField(e,1))&&t.writeBytes(1,r),null!=(r=s.Message.getField(e,2))&&t.writeUint64(2,r)},proto.PostResponse.prototype.getMessageId=function(){return s.Message.getFieldWithDefault(this,1,"")},proto.PostResponse.prototype.getMessageId_asB64=function(){return s.Message.bytesAsB64(this.getMessageId())},proto.PostResponse.prototype.getMessageId_asU8=function(){return s.Message.bytesAsU8(this.getMessageId())},proto.PostResponse.prototype.setMessageId=function(e){s.Message.setField(this,1,e)},proto.PostResponse.prototype.clearMessageId=function(){s.Message.setField(this,1,void 0)},proto.PostResponse.prototype.hasMessageId=function(){return null!=s.Message.getField(this,1)},proto.PostResponse.prototype.getBookmarkSyncDelay=function(){return s.Message.getFieldWithDefault(this,2,0)},proto.PostResponse.prototype.setBookmarkSyncDelay=function(e){s.Message.setField(this,2,e)},proto.PostResponse.prototype.clearBookmarkSyncDelay=function(){s.Message.setField(this,2,void 0)},proto.PostResponse.prototype.hasBookmarkSyncDelay=function(){return null!=s.Message.getField(this,2)},proto.PullRequest=function(e){s.Message.initialize(this,e,0,-1,null,null)},a.inherits(proto.PullRequest,s.Message),a.DEBUG&&!COMPILED&&(proto.PullRequest.displayName="proto.PullRequest"),s.Message.GENERATE_TO_OBJECT&&(proto.PullRequest.prototype.toObject=function(e){return proto.PullRequest.toObject(e,this)},proto.PullRequest.toObject=function(e,t){var r={messageId:t.getMessageId_asB64(),stopMessageId:t.getStopMessageId_asB64(),readDirection:s.Message.getFieldWithDefault(t,3,0)};return e&&(r.$jspbMessageInstance=t),r}),proto.PullRequest.deserializeBinary=function(e){var t=new s.BinaryReader(e),r=new proto.PullRequest;return proto.PullRequest.deserializeBinaryFromReader(r,t)},proto.PullRequest.deserializeBinaryFromReader=function(e,t){for(;t.nextField()&&!t.isEndGroup();){switch(t.getFieldNumber()){case 1:var r=t.readBytes();e.setMessageId(r);break;case 2:r=t.readBytes();e.setStopMessageId(r);break;case 3:r=t.readEnum();e.setReadDirection(r);break;default:t.skipField()}}return e},proto.PullRequest.prototype.serializeBinary=function(){var e=new s.BinaryWriter;return proto.PullRequest.serializeBinaryToWriter(this,e),e.getResultBuffer()},proto.PullRequest.serializeBinaryToWriter=function(e,t){var r=void 0;null!=(r=s.Message.getField(e,1))&&t.writeBytes(1,r),null!=(r=s.Message.getField(e,2))&&t.writeBytes(2,r),null!=(r=s.Message.getField(e,3))&&t.writeEnum(3,r)},proto.PullRequest.ReadDirection={FORWARD:0,REVERSE:1},proto.PullRequest.prototype.getMessageId=function(){return s.Message.getFieldWithDefault(this,1,"")},proto.PullRequest.prototype.getMessageId_asB64=function(){return s.Message.bytesAsB64(this.getMessageId())},proto.PullRequest.prototype.getMessageId_asU8=function(){return s.Message.bytesAsU8(this.getMessageId())},proto.PullRequest.prototype.setMessageId=function(e){s.Message.setField(this,1,e)},proto.PullRequest.prototype.clearMessageId=function(){s.Message.setField(this,1,void 0)},proto.PullRequest.prototype.hasMessageId=function(){return null!=s.Message.getField(this,1)},proto.PullRequest.prototype.getStopMessageId=function(){return s.Message.getFieldWithDefault(this,2,"")},proto.PullRequest.prototype.getStopMessageId_asB64=function(){return s.Message.bytesAsB64(this.getStopMessageId())},proto.PullRequest.prototype.getStopMessageId_asU8=function(){return s.Message.bytesAsU8(this.getStopMessageId())},proto.PullRequest.prototype.setStopMessageId=function(e){s.Message.setField(this,2,e)},proto.PullRequest.prototype.clearStopMessageId=function(){s.Message.setField(this,2,void 0)},proto.PullRequest.prototype.hasStopMessageId=function(){return null!=s.Message.getField(this,2)},proto.PullRequest.prototype.getReadDirection=function(){return s.Message.getFieldWithDefault(this,3,0)},proto.PullRequest.prototype.setReadDirection=function(e){s.Message.setField(this,3,e)},proto.PullRequest.prototype.clearReadDirection=function(){s.Message.setField(this,3,void 0)},proto.PullRequest.prototype.hasReadDirection=function(){return null!=s.Message.getField(this,3)},proto.PullResponse=function(e){s.Message.initialize(this,e,0,-1,proto.PullResponse.repeatedFields_,null)},a.inherits(proto.PullResponse,s.Message),a.DEBUG&&!COMPILED&&(proto.PullResponse.displayName="proto.PullResponse"),proto.PullResponse.repeatedFields_=[1],s.Message.GENERATE_TO_OBJECT&&(proto.PullResponse.prototype.toObject=function(e){return proto.PullResponse.toObject(e,this)},proto.PullResponse.toObject=function(e,t){var r={entryList:s.Message.toObjectList(t.getEntryList(),proto.PullResponse.MailboxEntry.toObject,e),nextMessageId:t.getNextMessageId_asB64(),gap:s.Message.getFieldWithDefault(t,3,!1),serverBookmark:t.getServerBookmark_asB64(),bookmarkSyncDelay:s.Message.getField(t,5)};return e&&(r.$jspbMessageInstance=t),r}),proto.PullResponse.deserializeBinary=function(e){var t=new s.BinaryReader(e),r=new proto.PullResponse;return proto.PullResponse.deserializeBinaryFromReader(r,t)},proto.PullResponse.deserializeBinaryFromReader=function(e,t){for(;t.nextField()&&!t.isEndGroup();){switch(t.getFieldNumber()){case 1:var r=new proto.PullResponse.MailboxEntry;t.readMessage(r,proto.PullResponse.MailboxEntry.deserializeBinaryFromReader),e.addEntry(r);break;case 2:r=t.readBytes();e.setNextMessageId(r);break;case 3:r=t.readBool();e.setGap(r);break;case 4:r=t.readBytes();e.setServerBookmark(r);break;case 5:r=t.readUint64();e.setBookmarkSyncDelay(r);break;default:t.skipField()}}return e},proto.PullResponse.prototype.serializeBinary=function(){var e=new s.BinaryWriter;return proto.PullResponse.serializeBinaryToWriter(this,e),e.getResultBuffer()},proto.PullResponse.serializeBinaryToWriter=function(e,t){var r=void 0;(r=e.getEntryList()).length>0&&t.writeRepeatedMessage(1,r,proto.PullResponse.MailboxEntry.serializeBinaryToWriter),null!=(r=s.Message.getField(e,2))&&t.writeBytes(2,r),null!=(r=s.Message.getField(e,3))&&t.writeBool(3,r),null!=(r=s.Message.getField(e,4))&&t.writeBytes(4,r),null!=(r=s.Message.getField(e,5))&&t.writeUint64(5,r)},proto.PullResponse.MailboxEntry=function(e){s.Message.initialize(this,e,0,-1,null,null)},a.inherits(proto.PullResponse.MailboxEntry,s.Message),a.DEBUG&&!COMPILED&&(proto.PullResponse.MailboxEntry.displayName="proto.PullResponse.MailboxEntry"),s.Message.GENERATE_TO_OBJECT&&(proto.PullResponse.MailboxEntry.prototype.toObject=function(e){return proto.PullResponse.MailboxEntry.toObject(e,this)},proto.PullResponse.MailboxEntry.toObject=function(e,t){var r,s={metaData:(r=t.getMetaData())&&proto.PullResponse.MailboxEntry.MetaData.toObject(e,r),messageData:t.getMessageData_asB64()};return e&&(s.$jspbMessageInstance=t),s}),proto.PullResponse.MailboxEntry.deserializeBinary=function(e){var t=new s.BinaryReader(e),r=new proto.PullResponse.MailboxEntry;return proto.PullResponse.MailboxEntry.deserializeBinaryFromReader(r,t)},proto.PullResponse.MailboxEntry.deserializeBinaryFromReader=function(e,t){for(;t.nextField()&&!t.isEndGroup();){switch(t.getFieldNumber()){case 1:var r=new proto.PullResponse.MailboxEntry.MetaData;t.readMessage(r,proto.PullResponse.MailboxEntry.MetaData.deserializeBinaryFromReader),e.setMetaData(r);break;case 2:r=t.readBytes();e.setMessageData(r);break;default:t.skipField()}}return e},proto.PullResponse.MailboxEntry.prototype.serializeBinary=function(){var e=new s.BinaryWriter;return proto.PullResponse.MailboxEntry.serializeBinaryToWriter(this,e),e.getResultBuffer()},proto.PullResponse.MailboxEntry.serializeBinaryToWriter=function(e,t){var r=void 0;null!=(r=e.getMetaData())&&t.writeMessage(1,r,proto.PullResponse.MailboxEntry.MetaData.serializeBinaryToWriter),null!=(r=s.Message.getField(e,2))&&t.writeBytes(2,r)},proto.PullResponse.MailboxEntry.MetaData=function(e){s.Message.initialize(this,e,0,-1,null,null)},a.inherits(proto.PullResponse.MailboxEntry.MetaData,s.Message),a.DEBUG&&!COMPILED&&(proto.PullResponse.MailboxEntry.MetaData.displayName="proto.PullResponse.MailboxEntry.MetaData"),s.Message.GENERATE_TO_OBJECT&&(proto.PullResponse.MailboxEntry.MetaData.prototype.toObject=function(e){return proto.PullResponse.MailboxEntry.MetaData.toObject(e,this)},proto.PullResponse.MailboxEntry.MetaData.toObject=function(e,t){var r={messageId:t.getMessageId_asB64(),userId:s.Message.getField(t,2),timestamp:s.Message.getField(t,3)};return e&&(r.$jspbMessageInstance=t),r}),proto.PullResponse.MailboxEntry.MetaData.deserializeBinary=function(e){var t=new s.BinaryReader(e),r=new proto.PullResponse.MailboxEntry.MetaData;return proto.PullResponse.MailboxEntry.MetaData.deserializeBinaryFromReader(r,t)},proto.PullResponse.MailboxEntry.MetaData.deserializeBinaryFromReader=function(e,t){for(;t.nextField()&&!t.isEndGroup();){switch(t.getFieldNumber()){case 1:var r=t.readBytes();e.setMessageId(r);break;case 2:r=t.readString();e.setUserId(r);break;case 3:r=t.readUint64();e.setTimestamp(r);break;default:t.skipField()}}return e},proto.PullResponse.MailboxEntry.MetaData.prototype.serializeBinary=function(){var e=new s.BinaryWriter;return proto.PullResponse.MailboxEntry.MetaData.serializeBinaryToWriter(this,e),e.getResultBuffer()},proto.PullResponse.MailboxEntry.MetaData.serializeBinaryToWriter=function(e,t){var r=void 0;null!=(r=s.Message.getField(e,1))&&t.writeBytes(1,r),null!=(r=s.Message.getField(e,2))&&t.writeString(2,r),null!=(r=s.Message.getField(e,3))&&t.writeUint64(3,r)},proto.PullResponse.MailboxEntry.MetaData.prototype.getMessageId=function(){return s.Message.getFieldWithDefault(this,1,"")},proto.PullResponse.MailboxEntry.MetaData.prototype.getMessageId_asB64=function(){return s.Message.bytesAsB64(this.getMessageId())},proto.PullResponse.MailboxEntry.MetaData.prototype.getMessageId_asU8=function(){return s.Message.bytesAsU8(this.getMessageId())},proto.PullResponse.MailboxEntry.MetaData.prototype.setMessageId=function(e){s.Message.setField(this,1,e)},proto.PullResponse.MailboxEntry.MetaData.prototype.clearMessageId=function(){s.Message.setField(this,1,void 0)},proto.PullResponse.MailboxEntry.MetaData.prototype.hasMessageId=function(){return null!=s.Message.getField(this,1)},proto.PullResponse.MailboxEntry.MetaData.prototype.getUserId=function(){return s.Message.getFieldWithDefault(this,2,"")},proto.PullResponse.MailboxEntry.MetaData.prototype.setUserId=function(e){s.Message.setField(this,2,e)},proto.PullResponse.MailboxEntry.MetaData.prototype.clearUserId=function(){s.Message.setField(this,2,void 0)},proto.PullResponse.MailboxEntry.MetaData.prototype.hasUserId=function(){return null!=s.Message.getField(this,2)},proto.PullResponse.MailboxEntry.MetaData.prototype.getTimestamp=function(){return s.Message.getFieldWithDefault(this,3,0)},proto.PullResponse.MailboxEntry.MetaData.prototype.setTimestamp=function(e){s.Message.setField(this,3,e)},proto.PullResponse.MailboxEntry.MetaData.prototype.clearTimestamp=function(){s.Message.setField(this,3,void 0)},proto.PullResponse.MailboxEntry.MetaData.prototype.hasTimestamp=function(){return null!=s.Message.getField(this,3)},proto.PullResponse.MailboxEntry.prototype.getMetaData=function(){return s.Message.getWrapperField(this,proto.PullResponse.MailboxEntry.MetaData,1,1)},proto.PullResponse.MailboxEntry.prototype.setMetaData=function(e){s.Message.setWrapperField(this,1,e)},proto.PullResponse.MailboxEntry.prototype.clearMetaData=function(){s.Message.setField(this,1,void 0)},proto.PullResponse.MailboxEntry.prototype.hasMetaData=function(){return null!=s.Message.getField(this,1)},proto.PullResponse.MailboxEntry.prototype.getMessageData=function(){return s.Message.getFieldWithDefault(this,2,"")},proto.PullResponse.MailboxEntry.prototype.getMessageData_asB64=function(){return s.Message.bytesAsB64(this.getMessageData())},proto.PullResponse.MailboxEntry.prototype.getMessageData_asU8=function(){return s.Message.bytesAsU8(this.getMessageData())},proto.PullResponse.MailboxEntry.prototype.setMessageData=function(e){s.Message.setField(this,2,e)},proto.PullResponse.MailboxEntry.prototype.clearMessageData=function(){s.Message.setField(this,2,void 0)},proto.PullResponse.MailboxEntry.prototype.hasMessageData=function(){return null!=s.Message.getField(this,2)},proto.PullResponse.prototype.getEntryList=function(){return s.Message.getRepeatedWrapperField(this,proto.PullResponse.MailboxEntry,1)},proto.PullResponse.prototype.setEntryList=function(e){s.Message.setRepeatedWrapperField(this,1,e)},proto.PullResponse.prototype.addEntry=function(e,t){return s.Message.addToRepeatedWrapperField(this,1,e,proto.PullResponse.MailboxEntry,t)},proto.PullResponse.prototype.clearEntryList=function(){this.setEntryList([])},proto.PullResponse.prototype.getNextMessageId=function(){return s.Message.getFieldWithDefault(this,2,"")},proto.PullResponse.prototype.getNextMessageId_asB64=function(){return s.Message.bytesAsB64(this.getNextMessageId())},proto.PullResponse.prototype.getNextMessageId_asU8=function(){return s.Message.bytesAsU8(this.getNextMessageId())},proto.PullResponse.prototype.setNextMessageId=function(e){s.Message.setField(this,2,e)},proto.PullResponse.prototype.clearNextMessageId=function(){s.Message.setField(this,2,void 0)},proto.PullResponse.prototype.hasNextMessageId=function(){return null!=s.Message.getField(this,2)},proto.PullResponse.prototype.getGap=function(){return s.Message.getFieldWithDefault(this,3,!1)},proto.PullResponse.prototype.setGap=function(e){s.Message.setField(this,3,e)},proto.PullResponse.prototype.clearGap=function(){s.Message.setField(this,3,void 0)},proto.PullResponse.prototype.hasGap=function(){return null!=s.Message.getField(this,3)},proto.PullResponse.prototype.getServerBookmark=function(){return s.Message.getFieldWithDefault(this,4,"")},proto.PullResponse.prototype.getServerBookmark_asB64=function(){return s.Message.bytesAsB64(this.getServerBookmark())},proto.PullResponse.prototype.getServerBookmark_asU8=function(){return s.Message.bytesAsU8(this.getServerBookmark())},proto.PullResponse.prototype.setServerBookmark=function(e){s.Message.setField(this,4,e)},proto.PullResponse.prototype.clearServerBookmark=function(){s.Message.setField(this,4,void 0)},proto.PullResponse.prototype.hasServerBookmark=function(){return null!=s.Message.getField(this,4)},proto.PullResponse.prototype.getBookmarkSyncDelay=function(){return s.Message.getFieldWithDefault(this,5,0)},proto.PullResponse.prototype.setBookmarkSyncDelay=function(e){s.Message.setField(this,5,e)},proto.PullResponse.prototype.clearBookmarkSyncDelay=function(){s.Message.setField(this,5,void 0)},proto.PullResponse.prototype.hasBookmarkSyncDelay=function(){return null!=s.Message.getField(this,5)},proto.SyncRequest=function(e){s.Message.initialize(this,e,0,-1,proto.SyncRequest.repeatedFields_,null)},a.inherits(proto.SyncRequest,s.Message),a.DEBUG&&!COMPILED&&(proto.SyncRequest.displayName="proto.SyncRequest"),proto.SyncRequest.repeatedFields_=[1],s.Message.GENERATE_TO_OBJECT&&(proto.SyncRequest.prototype.toObject=function(e){return proto.SyncRequest.toObject(e,this)},proto.SyncRequest.toObject=function(e,t){var r={mailboxesList:s.Message.toObjectList(t.getMailboxesList(),proto.SyncRequest.Mailbox.toObject,e)};return e&&(r.$jspbMessageInstance=t),r}),proto.SyncRequest.deserializeBinary=function(e){var t=new s.BinaryReader(e),r=new proto.SyncRequest;return proto.SyncRequest.deserializeBinaryFromReader(r,t)},proto.SyncRequest.deserializeBinaryFromReader=function(e,t){for(;t.nextField()&&!t.isEndGroup();){switch(t.getFieldNumber()){case 1:var r=new proto.SyncRequest.Mailbox;t.readMessage(r,proto.SyncRequest.Mailbox.deserializeBinaryFromReader),e.addMailboxes(r);break;default:t.skipField()}}return e},proto.SyncRequest.prototype.serializeBinary=function(){var e=new s.BinaryWriter;return proto.SyncRequest.serializeBinaryToWriter(this,e),e.getResultBuffer()},proto.SyncRequest.serializeBinaryToWriter=function(e,t){var r;(r=e.getMailboxesList()).length>0&&t.writeRepeatedMessage(1,r,proto.SyncRequest.Mailbox.serializeBinaryToWriter)},proto.SyncRequest.Mailbox=function(e){s.Message.initialize(this,e,0,-1,null,null)},a.inherits(proto.SyncRequest.Mailbox,s.Message),a.DEBUG&&!COMPILED&&(proto.SyncRequest.Mailbox.displayName="proto.SyncRequest.Mailbox"),s.Message.GENERATE_TO_OBJECT&&(proto.SyncRequest.Mailbox.prototype.toObject=function(e){return proto.SyncRequest.Mailbox.toObject(e,this)},proto.SyncRequest.Mailbox.toObject=function(e,t){var r={mailboxId:s.Message.getField(t,1),maxMessageId:t.getMaxMessageId_asB64(),clientBookmark:t.getClientBookmark_asB64()};return e&&(r.$jspbMessageInstance=t),r}),proto.SyncRequest.Mailbox.deserializeBinary=function(e){var t=new s.BinaryReader(e),r=new proto.SyncRequest.Mailbox;return proto.SyncRequest.Mailbox.deserializeBinaryFromReader(r,t)},proto.SyncRequest.Mailbox.deserializeBinaryFromReader=function(e,t){for(;t.nextField()&&!t.isEndGroup();){switch(t.getFieldNumber()){case 1:var r=t.readString();e.setMailboxId(r);break;case 2:r=t.readBytes();e.setMaxMessageId(r);break;case 3:r=t.readBytes();e.setClientBookmark(r);break;default:t.skipField()}}return e},proto.SyncRequest.Mailbox.prototype.serializeBinary=function(){var e=new s.BinaryWriter;return proto.SyncRequest.Mailbox.serializeBinaryToWriter(this,e),e.getResultBuffer()},proto.SyncRequest.Mailbox.serializeBinaryToWriter=function(e,t){var r=void 0;null!=(r=s.Message.getField(e,1))&&t.writeString(1,r),null!=(r=s.Message.getField(e,2))&&t.writeBytes(2,r),null!=(r=s.Message.getField(e,3))&&t.writeBytes(3,r)},proto.SyncRequest.Mailbox.prototype.getMailboxId=function(){return s.Message.getFieldWithDefault(this,1,"")},proto.SyncRequest.Mailbox.prototype.setMailboxId=function(e){s.Message.setField(this,1,e)},proto.SyncRequest.Mailbox.prototype.clearMailboxId=function(){s.Message.setField(this,1,void 0)},proto.SyncRequest.Mailbox.prototype.hasMailboxId=function(){return null!=s.Message.getField(this,1)},proto.SyncRequest.Mailbox.prototype.getMaxMessageId=function(){return s.Message.getFieldWithDefault(this,2,"")},proto.SyncRequest.Mailbox.prototype.getMaxMessageId_asB64=function(){return s.Message.bytesAsB64(this.getMaxMessageId())},proto.SyncRequest.Mailbox.prototype.getMaxMessageId_asU8=function(){return s.Message.bytesAsU8(this.getMaxMessageId())},proto.SyncRequest.Mailbox.prototype.setMaxMessageId=function(e){s.Message.setField(this,2,e)},proto.SyncRequest.Mailbox.prototype.clearMaxMessageId=function(){s.Message.setField(this,2,void 0)},proto.SyncRequest.Mailbox.prototype.hasMaxMessageId=function(){return null!=s.Message.getField(this,2)},proto.SyncRequest.Mailbox.prototype.getClientBookmark=function(){return s.Message.getFieldWithDefault(this,3,"")},proto.SyncRequest.Mailbox.prototype.getClientBookmark_asB64=function(){return s.Message.bytesAsB64(this.getClientBookmark())},proto.SyncRequest.Mailbox.prototype.getClientBookmark_asU8=function(){return s.Message.bytesAsU8(this.getClientBookmark())},proto.SyncRequest.Mailbox.prototype.setClientBookmark=function(e){s.Message.setField(this,3,e)},proto.SyncRequest.Mailbox.prototype.clearClientBookmark=function(){s.Message.setField(this,3,void 0)},proto.SyncRequest.Mailbox.prototype.hasClientBookmark=function(){return null!=s.Message.getField(this,3)},proto.SyncRequest.prototype.getMailboxesList=function(){return s.Message.getRepeatedWrapperField(this,proto.SyncRequest.Mailbox,1)},proto.SyncRequest.prototype.setMailboxesList=function(e){s.Message.setRepeatedWrapperField(this,1,e)},proto.SyncRequest.prototype.addMailboxes=function(e,t){return s.Message.addToRepeatedWrapperField(this,1,e,proto.SyncRequest.Mailbox,t)},proto.SyncRequest.prototype.clearMailboxesList=function(){this.setMailboxesList([])},proto.SyncResponse=function(e){s.Message.initialize(this,e,0,-1,proto.SyncResponse.repeatedFields_,null)},a.inherits(proto.SyncResponse,s.Message),a.DEBUG&&!COMPILED&&(proto.SyncResponse.displayName="proto.SyncResponse"),proto.SyncResponse.repeatedFields_=[1,2],s.Message.GENERATE_TO_OBJECT&&(proto.SyncResponse.prototype.toObject=function(e){return proto.SyncResponse.toObject(e,this)},proto.SyncResponse.toObject=function(e,t){var r={mailboxesList:s.Message.toObjectList(t.getMailboxesList(),proto.SyncResponse.Mailbox.toObject,e),errorList:s.Message.toObjectList(t.getErrorList(),proto.SyncResponse.MailboxError.toObject,e),serverBookmark:t.getServerBookmark_asB64()};return e&&(r.$jspbMessageInstance=t),r}),proto.SyncResponse.deserializeBinary=function(e){var t=new s.BinaryReader(e),r=new proto.SyncResponse;return proto.SyncResponse.deserializeBinaryFromReader(r,t)},proto.SyncResponse.deserializeBinaryFromReader=function(e,t){for(;t.nextField()&&!t.isEndGroup();){switch(t.getFieldNumber()){case 1:var r=new proto.SyncResponse.Mailbox;t.readMessage(r,proto.SyncResponse.Mailbox.deserializeBinaryFromReader),e.addMailboxes(r);break;case 2:r=new proto.SyncResponse.MailboxError;t.readMessage(r,proto.SyncResponse.MailboxError.deserializeBinaryFromReader),e.addError(r);break;case 3:r=t.readBytes();e.setServerBookmark(r);break;default:t.skipField()}}return e},proto.SyncResponse.prototype.serializeBinary=function(){var e=new s.BinaryWriter;return proto.SyncResponse.serializeBinaryToWriter(this,e),e.getResultBuffer()},proto.SyncResponse.serializeBinaryToWriter=function(e,t){var r=void 0;(r=e.getMailboxesList()).length>0&&t.writeRepeatedMessage(1,r,proto.SyncResponse.Mailbox.serializeBinaryToWriter),(r=e.getErrorList()).length>0&&t.writeRepeatedMessage(2,r,proto.SyncResponse.MailboxError.serializeBinaryToWriter),null!=(r=s.Message.getField(e,3))&&t.writeBytes(3,r)},proto.SyncResponse.MailboxError=function(e){s.Message.initialize(this,e,0,-1,null,null)},a.inherits(proto.SyncResponse.MailboxError,s.Message),a.DEBUG&&!COMPILED&&(proto.SyncResponse.MailboxError.displayName="proto.SyncResponse.MailboxError"),s.Message.GENERATE_TO_OBJECT&&(proto.SyncResponse.MailboxError.prototype.toObject=function(e){return proto.SyncResponse.MailboxError.toObject(e,this)},proto.SyncResponse.MailboxError.toObject=function(e,t){var r={mailboxId:s.Message.getField(t,1),error:s.Message.getField(t,2)};return e&&(r.$jspbMessageInstance=t),r}),proto.SyncResponse.MailboxError.deserializeBinary=function(e){var t=new s.BinaryReader(e),r=new proto.SyncResponse.MailboxError;return proto.SyncResponse.MailboxError.deserializeBinaryFromReader(r,t)},proto.SyncResponse.MailboxError.deserializeBinaryFromReader=function(e,t){for(;t.nextField()&&!t.isEndGroup();){switch(t.getFieldNumber()){case 1:var r=t.readString();e.setMailboxId(r);break;case 2:r=t.readEnum();e.setError(r);break;default:t.skipField()}}return e},proto.SyncResponse.MailboxError.prototype.serializeBinary=function(){var e=new s.BinaryWriter;return proto.SyncResponse.MailboxError.serializeBinaryToWriter(this,e),e.getResultBuffer()},proto.SyncResponse.MailboxError.serializeBinaryToWriter=function(e,t){var r=void 0;null!=(r=s.Message.getField(e,1))&&t.writeString(1,r),null!=(r=s.Message.getField(e,2))&&t.writeEnum(2,r)},proto.SyncResponse.MailboxError.Error={NOTSUBSCRIBED:0,NOTFOUND:1},proto.SyncResponse.MailboxError.prototype.getMailboxId=function(){return s.Message.getFieldWithDefault(this,1,"")},proto.SyncResponse.MailboxError.prototype.setMailboxId=function(e){s.Message.setField(this,1,e)},proto.SyncResponse.MailboxError.prototype.clearMailboxId=function(){s.Message.setField(this,1,void 0)},proto.SyncResponse.MailboxError.prototype.hasMailboxId=function(){return null!=s.Message.getField(this,1)},proto.SyncResponse.MailboxError.prototype.getError=function(){return s.Message.getFieldWithDefault(this,2,0)},proto.SyncResponse.MailboxError.prototype.setError=function(e){s.Message.setField(this,2,e)},proto.SyncResponse.MailboxError.prototype.clearError=function(){s.Message.setField(this,2,void 0)},proto.SyncResponse.MailboxError.prototype.hasError=function(){return null!=s.Message.getField(this,2)},proto.SyncResponse.Mailbox=function(e){s.Message.initialize(this,e,0,-1,proto.SyncResponse.Mailbox.repeatedFields_,null)},a.inherits(proto.SyncResponse.Mailbox,s.Message),a.DEBUG&&!COMPILED&&(proto.SyncResponse.Mailbox.displayName="proto.SyncResponse.Mailbox"),proto.SyncResponse.Mailbox.repeatedFields_=[4],s.Message.GENERATE_TO_OBJECT&&(proto.SyncResponse.Mailbox.prototype.toObject=function(e){return proto.SyncResponse.Mailbox.toObject(e,this)},proto.SyncResponse.Mailbox.toObject=function(e,t){var r={mailboxId:s.Message.getField(t,1),nextMessageId:t.getNextMessageId_asB64(),gap:s.Message.getFieldWithDefault(t,3,!1),idList:t.getIdList_asB64()};return e&&(r.$jspbMessageInstance=t),r}),proto.SyncResponse.Mailbox.deserializeBinary=function(e){var t=new s.BinaryReader(e),r=new proto.SyncResponse.Mailbox;return proto.SyncResponse.Mailbox.deserializeBinaryFromReader(r,t)},proto.SyncResponse.Mailbox.deserializeBinaryFromReader=function(e,t){for(;t.nextField()&&!t.isEndGroup();){switch(t.getFieldNumber()){case 1:var r=t.readString();e.setMailboxId(r);break;case 2:r=t.readBytes();e.setNextMessageId(r);break;case 3:r=t.readBool();e.setGap(r);break;case 4:r=t.readBytes();e.addId(r);break;default:t.skipField()}}return e},proto.SyncResponse.Mailbox.prototype.serializeBinary=function(){var e=new s.BinaryWriter;return proto.SyncResponse.Mailbox.serializeBinaryToWriter(this,e),e.getResultBuffer()},proto.SyncResponse.Mailbox.serializeBinaryToWriter=function(e,t){var r=void 0;null!=(r=s.Message.getField(e,1))&&t.writeString(1,r),null!=(r=s.Message.getField(e,2))&&t.writeBytes(2,r),null!=(r=s.Message.getField(e,3))&&t.writeBool(3,r),(r=e.getIdList_asU8()).length>0&&t.writeRepeatedBytes(4,r)},proto.SyncResponse.Mailbox.prototype.getMailboxId=function(){return s.Message.getFieldWithDefault(this,1,"")},proto.SyncResponse.Mailbox.prototype.setMailboxId=function(e){s.Message.setField(this,1,e)},proto.SyncResponse.Mailbox.prototype.clearMailboxId=function(){s.Message.setField(this,1,void 0)},proto.SyncResponse.Mailbox.prototype.hasMailboxId=function(){return null!=s.Message.getField(this,1)},proto.SyncResponse.Mailbox.prototype.getNextMessageId=function(){return s.Message.getFieldWithDefault(this,2,"")},proto.SyncResponse.Mailbox.prototype.getNextMessageId_asB64=function(){return s.Message.bytesAsB64(this.getNextMessageId())},proto.SyncResponse.Mailbox.prototype.getNextMessageId_asU8=function(){return s.Message.bytesAsU8(this.getNextMessageId())},proto.SyncResponse.Mailbox.prototype.setNextMessageId=function(e){s.Message.setField(this,2,e)},proto.SyncResponse.Mailbox.prototype.clearNextMessageId=function(){s.Message.setField(this,2,void 0)},proto.SyncResponse.Mailbox.prototype.hasNextMessageId=function(){return null!=s.Message.getField(this,2)},proto.SyncResponse.Mailbox.prototype.getGap=function(){return s.Message.getFieldWithDefault(this,3,!1)},proto.SyncResponse.Mailbox.prototype.setGap=function(e){s.Message.setField(this,3,e)},proto.SyncResponse.Mailbox.prototype.clearGap=function(){s.Message.setField(this,3,void 0)},proto.SyncResponse.Mailbox.prototype.hasGap=function(){return null!=s.Message.getField(this,3)},proto.SyncResponse.Mailbox.prototype.getIdList=function(){return s.Message.getRepeatedField(this,4)},proto.SyncResponse.Mailbox.prototype.getIdList_asB64=function(){return s.Message.bytesListAsB64(this.getIdList())},proto.SyncResponse.Mailbox.prototype.getIdList_asU8=function(){return s.Message.bytesListAsU8(this.getIdList())},proto.SyncResponse.Mailbox.prototype.setIdList=function(e){s.Message.setField(this,4,e||[])},proto.SyncResponse.Mailbox.prototype.addId=function(e,t){s.Message.addToRepeatedField(this,4,e,t)},proto.SyncResponse.Mailbox.prototype.clearIdList=function(){this.setIdList([])},proto.SyncResponse.prototype.getMailboxesList=function(){return s.Message.getRepeatedWrapperField(this,proto.SyncResponse.Mailbox,1)},proto.SyncResponse.prototype.setMailboxesList=function(e){s.Message.setRepeatedWrapperField(this,1,e)},proto.SyncResponse.prototype.addMailboxes=function(e,t){return s.Message.addToRepeatedWrapperField(this,1,e,proto.SyncResponse.Mailbox,t)},proto.SyncResponse.prototype.clearMailboxesList=function(){this.setMailboxesList([])},proto.SyncResponse.prototype.getErrorList=function(){return s.Message.getRepeatedWrapperField(this,proto.SyncResponse.MailboxError,2)},proto.SyncResponse.prototype.setErrorList=function(e){s.Message.setRepeatedWrapperField(this,2,e)},proto.SyncResponse.prototype.addError=function(e,t){return s.Message.addToRepeatedWrapperField(this,2,e,proto.SyncResponse.MailboxError,t)},proto.SyncResponse.prototype.clearErrorList=function(){this.setErrorList([])},proto.SyncResponse.prototype.getServerBookmark=function(){return s.Message.getFieldWithDefault(this,3,"")},proto.SyncResponse.prototype.getServerBookmark_asB64=function(){return s.Message.bytesAsB64(this.getServerBookmark())},proto.SyncResponse.prototype.getServerBookmark_asU8=function(){return s.Message.bytesAsU8(this.getServerBookmark())},proto.SyncResponse.prototype.setServerBookmark=function(e){s.Message.setField(this,3,e)},proto.SyncResponse.prototype.clearServerBookmark=function(){s.Message.setField(this,3,void 0)},proto.SyncResponse.prototype.hasServerBookmark=function(){return null!=s.Message.getField(this,3)},proto.OnlineMessage=function(e){s.Message.initialize(this,e,0,-1,proto.OnlineMessage.repeatedFields_,null)},a.inherits(proto.OnlineMessage,s.Message),a.DEBUG&&!COMPILED&&(proto.OnlineMessage.displayName="proto.OnlineMessage"),proto.OnlineMessage.repeatedFields_=[1],s.Message.GENERATE_TO_OBJECT&&(proto.OnlineMessage.prototype.toObject=function(e){return proto.OnlineMessage.toObject(e,this)},proto.OnlineMessage.toObject=function(e,t){var r={entryList:s.Message.toObjectList(t.getEntryList(),proto.OnlineMessage.MailboxEntry.toObject,e),bookmarkSyncDelay:s.Message.getField(t,2)};return e&&(r.$jspbMessageInstance=t),r}),proto.OnlineMessage.deserializeBinary=function(e){var t=new s.BinaryReader(e),r=new proto.OnlineMessage;return proto.OnlineMessage.deserializeBinaryFromReader(r,t)},proto.OnlineMessage.deserializeBinaryFromReader=function(e,t){for(;t.nextField()&&!t.isEndGroup();){switch(t.getFieldNumber()){case 1:var r=new proto.OnlineMessage.MailboxEntry;t.readMessage(r,proto.OnlineMessage.MailboxEntry.deserializeBinaryFromReader),e.addEntry(r);break;case 2:r=t.readUint64();e.setBookmarkSyncDelay(r);break;default:t.skipField()}}return e},proto.OnlineMessage.prototype.serializeBinary=function(){var e=new s.BinaryWriter;return proto.OnlineMessage.serializeBinaryToWriter(this,e),e.getResultBuffer()},proto.OnlineMessage.serializeBinaryToWriter=function(e,t){var r=void 0;(r=e.getEntryList()).length>0&&t.writeRepeatedMessage(1,r,proto.OnlineMessage.MailboxEntry.serializeBinaryToWriter),null!=(r=s.Message.getField(e,2))&&t.writeUint64(2,r)},proto.OnlineMessage.MailboxEntry=function(e){s.Message.initialize(this,e,0,-1,null,null)},a.inherits(proto.OnlineMessage.MailboxEntry,s.Message),a.DEBUG&&!COMPILED&&(proto.OnlineMessage.MailboxEntry.displayName="proto.OnlineMessage.MailboxEntry"),s.Message.GENERATE_TO_OBJECT&&(proto.OnlineMessage.MailboxEntry.prototype.toObject=function(e){return proto.OnlineMessage.MailboxEntry.toObject(e,this)},proto.OnlineMessage.MailboxEntry.toObject=function(e,t){var r,s={metaData:(r=t.getMetaData())&&proto.OnlineMessage.MailboxEntry.MetaData.toObject(e,r),messageData:t.getMessageData_asB64()};return e&&(s.$jspbMessageInstance=t),s}),proto.OnlineMessage.MailboxEntry.deserializeBinary=function(e){var t=new s.BinaryReader(e),r=new proto.OnlineMessage.MailboxEntry;return proto.OnlineMessage.MailboxEntry.deserializeBinaryFromReader(r,t)},proto.OnlineMessage.MailboxEntry.deserializeBinaryFromReader=function(e,t){for(;t.nextField()&&!t.isEndGroup();){switch(t.getFieldNumber()){case 1:var r=new proto.OnlineMessage.MailboxEntry.MetaData;t.readMessage(r,proto.OnlineMessage.MailboxEntry.MetaData.deserializeBinaryFromReader),e.setMetaData(r);break;case 2:r=t.readBytes();e.setMessageData(r);break;default:t.skipField()}}return e},proto.OnlineMessage.MailboxEntry.prototype.serializeBinary=function(){var e=new s.BinaryWriter;return proto.OnlineMessage.MailboxEntry.serializeBinaryToWriter(this,e),e.getResultBuffer()},proto.OnlineMessage.MailboxEntry.serializeBinaryToWriter=function(e,t){var r=void 0;null!=(r=e.getMetaData())&&t.writeMessage(1,r,proto.OnlineMessage.MailboxEntry.MetaData.serializeBinaryToWriter),null!=(r=s.Message.getField(e,2))&&t.writeBytes(2,r)},proto.OnlineMessage.MailboxEntry.MetaData=function(e){s.Message.initialize(this,e,0,-1,null,null)},a.inherits(proto.OnlineMessage.MailboxEntry.MetaData,s.Message),a.DEBUG&&!COMPILED&&(proto.OnlineMessage.MailboxEntry.MetaData.displayName="proto.OnlineMessage.MailboxEntry.MetaData"),s.Message.GENERATE_TO_OBJECT&&(proto.OnlineMessage.MailboxEntry.MetaData.prototype.toObject=function(e){return proto.OnlineMessage.MailboxEntry.MetaData.toObject(e,this)},proto.OnlineMessage.MailboxEntry.MetaData.toObject=function(e,t){var r={messageId:t.getMessageId_asB64(),userId:s.Message.getField(t,2),timestamp:s.Message.getField(t,3),onlineOnly:s.Message.getFieldWithDefault(t,14,!1),type:s.Message.getField(t,15)};return e&&(r.$jspbMessageInstance=t),r}),proto.OnlineMessage.MailboxEntry.MetaData.deserializeBinary=function(e){var t=new s.BinaryReader(e),r=new proto.OnlineMessage.MailboxEntry.MetaData;return proto.OnlineMessage.MailboxEntry.MetaData.deserializeBinaryFromReader(r,t)},proto.OnlineMessage.MailboxEntry.MetaData.deserializeBinaryFromReader=function(e,t){for(;t.nextField()&&!t.isEndGroup();){switch(t.getFieldNumber()){case 1:var r=t.readBytes();e.setMessageId(r);break;case 2:r=t.readString();e.setUserId(r);break;case 3:r=t.readUint64();e.setTimestamp(r);break;case 14:r=t.readBool();e.setOnlineOnly(r);break;case 15:r=t.readString();e.setType(r);break;default:t.skipField()}}return e},proto.OnlineMessage.MailboxEntry.MetaData.prototype.serializeBinary=function(){var e=new s.BinaryWriter;return proto.OnlineMessage.MailboxEntry.MetaData.serializeBinaryToWriter(this,e),e.getResultBuffer()},proto.OnlineMessage.MailboxEntry.MetaData.serializeBinaryToWriter=function(e,t){var r=void 0;null!=(r=s.Message.getField(e,1))&&t.writeBytes(1,r),null!=(r=s.Message.getField(e,2))&&t.writeString(2,r),null!=(r=s.Message.getField(e,3))&&t.writeUint64(3,r),null!=(r=s.Message.getField(e,14))&&t.writeBool(14,r),null!=(r=s.Message.getField(e,15))&&t.writeString(15,r)},proto.OnlineMessage.MailboxEntry.MetaData.prototype.getMessageId=function(){return s.Message.getFieldWithDefault(this,1,"")},proto.OnlineMessage.MailboxEntry.MetaData.prototype.getMessageId_asB64=function(){return s.Message.bytesAsB64(this.getMessageId())},proto.OnlineMessage.MailboxEntry.MetaData.prototype.getMessageId_asU8=function(){return s.Message.bytesAsU8(this.getMessageId())},proto.OnlineMessage.MailboxEntry.MetaData.prototype.setMessageId=function(e){s.Message.setField(this,1,e)},proto.OnlineMessage.MailboxEntry.MetaData.prototype.clearMessageId=function(){s.Message.setField(this,1,void 0)},proto.OnlineMessage.MailboxEntry.MetaData.prototype.hasMessageId=function(){return null!=s.Message.getField(this,1)},proto.OnlineMessage.MailboxEntry.MetaData.prototype.getUserId=function(){return s.Message.getFieldWithDefault(this,2,"")},proto.OnlineMessage.MailboxEntry.MetaData.prototype.setUserId=function(e){s.Message.setField(this,2,e)},proto.OnlineMessage.MailboxEntry.MetaData.prototype.clearUserId=function(){s.Message.setField(this,2,void 0)},proto.OnlineMessage.MailboxEntry.MetaData.prototype.hasUserId=function(){return null!=s.Message.getField(this,2)},proto.OnlineMessage.MailboxEntry.MetaData.prototype.getTimestamp=function(){return s.Message.getFieldWithDefault(this,3,0)},proto.OnlineMessage.MailboxEntry.MetaData.prototype.setTimestamp=function(e){s.Message.setField(this,3,e)},proto.OnlineMessage.MailboxEntry.MetaData.prototype.clearTimestamp=function(){s.Message.setField(this,3,void 0)},proto.OnlineMessage.MailboxEntry.MetaData.prototype.hasTimestamp=function(){return null!=s.Message.getField(this,3)},proto.OnlineMessage.MailboxEntry.MetaData.prototype.getOnlineOnly=function(){return s.Message.getFieldWithDefault(this,14,!1)},proto.OnlineMessage.MailboxEntry.MetaData.prototype.setOnlineOnly=function(e){s.Message.setField(this,14,e)},proto.OnlineMessage.MailboxEntry.MetaData.prototype.clearOnlineOnly=function(){s.Message.setField(this,14,void 0)},proto.OnlineMessage.MailboxEntry.MetaData.prototype.hasOnlineOnly=function(){return null!=s.Message.getField(this,14)},proto.OnlineMessage.MailboxEntry.MetaData.prototype.getType=function(){return s.Message.getFieldWithDefault(this,15,"")},proto.OnlineMessage.MailboxEntry.MetaData.prototype.setType=function(e){s.Message.setField(this,15,e)},proto.OnlineMessage.MailboxEntry.MetaData.prototype.clearType=function(){s.Message.setField(this,15,void 0)},proto.OnlineMessage.MailboxEntry.MetaData.prototype.hasType=function(){return null!=s.Message.getField(this,15)},proto.OnlineMessage.MailboxEntry.prototype.getMetaData=function(){return s.Message.getWrapperField(this,proto.OnlineMessage.MailboxEntry.MetaData,1,1)},proto.OnlineMessage.MailboxEntry.prototype.setMetaData=function(e){s.Message.setWrapperField(this,1,e)},proto.OnlineMessage.MailboxEntry.prototype.clearMetaData=function(){s.Message.setField(this,1,void 0)},proto.OnlineMessage.MailboxEntry.prototype.hasMetaData=function(){return null!=s.Message.getField(this,1)},proto.OnlineMessage.MailboxEntry.prototype.getMessageData=function(){return s.Message.getFieldWithDefault(this,2,"")},proto.OnlineMessage.MailboxEntry.prototype.getMessageData_asB64=function(){return s.Message.bytesAsB64(this.getMessageData())},proto.OnlineMessage.MailboxEntry.prototype.getMessageData_asU8=function(){return s.Message.bytesAsU8(this.getMessageData())},proto.OnlineMessage.MailboxEntry.prototype.setMessageData=function(e){s.Message.setField(this,2,e)},proto.OnlineMessage.MailboxEntry.prototype.clearMessageData=function(){s.Message.setField(this,2,void 0)},proto.OnlineMessage.MailboxEntry.prototype.hasMessageData=function(){return null!=s.Message.getField(this,2)},proto.OnlineMessage.prototype.getEntryList=function(){return s.Message.getRepeatedWrapperField(this,proto.OnlineMessage.MailboxEntry,1)},proto.OnlineMessage.prototype.setEntryList=function(e){s.Message.setRepeatedWrapperField(this,1,e)},proto.OnlineMessage.prototype.addEntry=function(e,t){return s.Message.addToRepeatedWrapperField(this,1,e,proto.OnlineMessage.MailboxEntry,t)},proto.OnlineMessage.prototype.clearEntryList=function(){this.setEntryList([])},proto.OnlineMessage.prototype.getBookmarkSyncDelay=function(){return s.Message.getFieldWithDefault(this,2,0)},proto.OnlineMessage.prototype.setBookmarkSyncDelay=function(e){s.Message.setField(this,2,e)},proto.OnlineMessage.prototype.clearBookmarkSyncDelay=function(){s.Message.setField(this,2,void 0)},proto.OnlineMessage.prototype.hasBookmarkSyncDelay=function(){return null!=s.Message.getField(this,2)},a.object.extend(t,proto)},function(e,t){e.exports=require("google-protobuf")},function(e,t,r){"use strict";t.a=o;var s=r(46),a=r(5),n=r(0);function o(e,t,r,o,i,d){if(!(e instanceof a.a)||0==e.length)throw new n.Error("MessageData requires the messageId parameter be a non-empty instance of bbm.mailbox.MessageId: messageId="+e);if(this.messageId=e,"string"!=typeof t||0==t.length)throw new n.Error("MessageData requires the userId parameter be a non-empty string: userId="+t);if(this.userId=t,!r||!Number.isInteger(r))throw new n.Error("MessageData requires the timestamp parameter be an integer larger than 0: timestamp="+r);if(this.timestamp=r,!(o instanceof s.a))throw new n.Error("MessageData requires the message parameter be an instance of bbm.mailbox.Message: message="+o);this.message=o,this.fromPull=!0===i,this.onlineOnly=!0===d}o.prototype.toString=function(){return"MessageData{M="+this.messageId+" r="+this.userId+" t="+this.timestamp+(this.fromPull?" pulled":"")+(this.onlineOnly?" online":"")+"}"}},function(e,t,r){"use strict";t.a=m;var s=r(11),a=r(10),n=r(0),o=r(6),i=r(3),d=r(1),c=r(2),l=r(20),u=r.n(l),p=r(15),f=(r.n(p),r(14)),g=r.n(f);const h="ManagementClient",y=s.default.Method;function m(e,t,r){this.busClient=e,this.domain=t,this.regId=r}m.prototype.createMailbox=function(e,t,r,s,l,u,f,g){Object(i.default)("chat"===e),Object(i.default)(t instanceof a.a.AppData),Object(i.default)(!0===r),Object(i.default)(a.a.UpdatePolicy.hasOwnProperty(s)),Object(i.default)(a.a.InvitePolicy.hasOwnProperty(l)),Object(i.default)(a.a.Description.hasOwnProperty(u)),Object(i.default)(void 0===f||f instanceof a.a.AppData),Object(i.default)(void 0===g||g instanceof Object&&!Array.isArray(g));const m=`/domains/${this.domain}/user/mailboxes?caller=${this.regId}`,b={type:e,subject:t.toString(),protected:r,updatePolicy:s,invitePolicy:l,description:u,data:f?f.toString():void 0,protectedKey:g?c.array2b(o.d(g)):void 0};return this.busClient.request(m,this.busClient.requestOptions(y.POST),b).then(e=>{if(d.default.debug(d.default.DEBUG1,"%s: Received create mailbox response entity: %s",h,p.stringify(e)),!e)throw new n.PermanentFailure("Failed to create mailbox; bad response");if("string"!=typeof e.id||0===e.id.length)throw new n.PermanentFailure("Failed to create mailbox; bad mailboxId in response="+p.stringify(e));if("number"!=typeof e.createdTime)throw new n.PermanentFailure("Failed to create mailbox; bad createdTime in response="+p.stringify(e));return{id:e.id,createdTime:e.createdTime}})},m.prototype.updateMailbox=function(e,t){Object(d.default)(d.default.INFO,"%s: Updating mailboxId=%s",h,e),Object(i.default)(void 0===t.subject||t.subject instanceof a.a.AppData),Object(i.default)(void 0===t.invitePolicy||a.a.InvitePolicy.hasOwnProperty(t.invitePolicy)),Object(i.default)(void 0===t.data||t.data instanceof a.a.AppData);const r=`/domains/${this.domain}/user/mailboxes/${e}?caller=${this.regId}`,s={};return t.invitePolicy&&(s.invitePolicy=t.invitePolicy),t.subject&&(s.subject=t.subject.toString()),t.data&&(s.data=t.data.toString()),0==Object.keys(s).length?(Object(d.default)(d.default.WARNING,"%s: Rejecting empty update for mailboxId=%s",h,e),Promise.reject(new n.PermanentFailure("Empty update requested"))):this.busClient.request(r,this.busClient.requestOptions(y.PUT),s)},m.prototype.getMailbox=function(e){Object(i.default)("string"==typeof e&&e.length>0);const t=`/domains/${this.domain}/user/mailboxes/${e}?caller=${this.regId}`;return this.busClient.request(t).then(e=>new a.a(e))},m.prototype.getAllMailboxes=function(){Object(d.default)(d.default.INFO,"%s: Getting all mailboxes",h);const e=`/domains/${this.domain}/user/mailboxes?caller=${this.regId}`+"&size=0",t=[],r=s=>this.busClient.request(e+s).then(e=>{if(!Array.isArray(e.mailboxes))throw new n.PermanentFailure("Received invalid response while getting all mailboxes: response="+p.stringify(e));const o=t.length;if(e.mailboxes.reduce((e,t)=>{try{e.push(new a.a(t))}catch(e){Object(d.default)(d.default.ERROR,"%s: Ignoring mailbox in response; error=%s",h,e)}return e},t),Object(d.default)(d.default.INFO,"%s: Successfully processed %d mailboxes; accumulated size=%d; %smore available",h,t.length-o,t.length,e.hasMore?"no ":""),e.hasMore){if(t.length===o)return Object(d.default)(d.default.NOTICE,"%s: Get all mailboxes response indicated more mailboxes are available but contained no valid mailboxes; returning incomplete list"),t;let e;if(0===t.length||(e=`&from=${t[t.length-1].id}`)===s)throw new n.PermanentFailure("Failed to get all mailboxes; no valid mailboxes in response");return r(e)}return t});return r("")},m.prototype.grant=function(e,t,r){Object(i.default)("string"==typeof e&&e.length>0,"mailboxId must be a non-empty string"),Object(i.default)("string"==typeof t&&t.length>0,"regId must be a non-empty string");var s,a="/domains/"+this.domain+"/user/mailboxes/"+e+"/members/"+t+"?caller="+this.regId;return r&&(Object(i.default)(r instanceof Uint8Array&&r.length>0,"grantData must be a non-empty Uint8Array"),s={grant:u.a.base64Uint8Array(r)}),this.busClient.request(a,this.busClient.requestOptions(y.PUT),s)},m.prototype.join=function(e,t){Object(i.default)("string"==typeof e&&e.length>0,"mailboxId must be a non-empty string");const r="/domains/"+this.domain+"/user/mailboxes/"+e+"/members/"+this.regId+"?caller="+this.regId;let s;return t&&(s={protectedKey:c.array2b(o.d(t))}),this.busClient.request(r,this.busClient.requestOptions(y.PUT),s)},m.prototype.removeMember=function(e,t){var r="/domains/"+this.domain+"/user/mailboxes/"+e+"/members/"+t+"?caller="+this.regId;return this.busClient.request(r,this.busClient.requestOptions(y.DELETE))},m.prototype.addAdmin=function(e,t){var r="/domains/"+this.domain+"/user/mailboxes/"+e+"/admins/"+t+"?caller="+this.regId;return this.busClient.request(r,this.busClient.requestOptions(y.PUT))},m.prototype.removeAdmin=function(e,t){var r="/domains/"+this.domain+"/user/mailboxes/"+e+"/admins/"+t+"?caller="+this.regId;return this.busClient.request(r,this.busClient.requestOptions(y.DELETE))},m.prototype.getAllMailboxGrants=function(){var e=this,t="/domains/"+e.domain+"/user/mailboxgrants?caller="+e.regId,r=[];return new Promise(function(s,a){!function o(){var i=t+(0===r.length?"":"&from_mailboxid="+r[r.length-1].mailboxId);e.busClient.request(i).then(function(e){if(!(e instanceof Array))throw new n.PermanentFailure("Request to get all grants returned an invalid response: "+p.stringify(e));e.forEach(function(e,t){if("string"!=typeof e.mailboxId||0===e.mailboxId.length)throw new n.PermanentFailure("Received grant with invalid mailboxId="+e.mailboxId+" at index="+t);var s;if(e.inviter instanceof g.a&&(s=e.inviter.toString().valueOf()),!s)throw new n.PermanentFailure("Received grant for mailboxId="+e.mailboxId+" with invalid inviter="+e.inviter+" at index="+t);if("string"!=typeof e.grant||0===e.grant.length)throw new n.PermanentFailure("Received grant for mailboxId="+e.mailboxId+" with invalid grant="+e.grant+" at index="+t);try{r.push({mailboxId:e.mailboxId,sender:s,data:u.a.unbase64Array(e.grant)})}catch(r){console.warn("Ignoring grant that failed to decode for mailboxId="+e.mailboxId+" for inviter="+e.inviter+" at index="+t+"; grant="+e.grant+"; error="+r)}}),0!==e.length?o():s(r)}).catch(function(e){a(e)})}()})}},function(e,t,r){"use strict";t.a=i;var s=r(5),a=r(0),n=r(3),o=r(1);function i(e,t,r,s){Object(n.default)(void 0!==e,"contentClient must be defined"),Object(n.default)(void 0!==e.post,"ContentClient must support post"),Object(n.default)(void 0!==e.pull,"contentClient must support pull"),Object(n.default)(void 0!==e.sync,"contentClient must support sync"),Object(n.default)(void 0!==t,"db must be defined"),Object(n.default)(void 0!==r,"receiveFunction must be defined");var a=new y(e,t,r,s);Object.defineProperty(this,"_private",{enumerable:!1,get:function(){if(!y.isAccessAllowed)throw new TypeError("Illegal access of private data");return a}})}function d(e,t){this.mailboxId=e,this.requestId=t,this.isSync=!0,this.requestType="Sync",this.isInSyncCycle=!0,this.startPoint=new s.a,this.stopPoint=new s.a;var r=null;Object.defineProperty(this,"retryData",{get:function(){return r},set:function(e){r=c.assign(r,e)}}),this.retryBackoff=i.initialBackoff;var a=null;Object.defineProperty(this,"reconciliationData",{get:function(){return a},set:function(e){a=c.assign(a,e)}}),this.pullPoint=new s.a,this.isBookmarkedPull=!1,this.completeFunction=null,this.isForward=!0,this.receiveFunction=null,this.resolve=null,this.reject=null}function c(e,t,r){var s=this;this.fired=!1,this.id=setTimeout(function(){s.fired=!0,e()},r),this.refCount=0,this.cancelledCallback=t}function l(e,t){d.call(this,e,t),this.requestType="Reconnect Sync"}function u(e,t){d.call(this,e,t),this.isSync=!1,this.requestType="Reconnect Pull"}function p(e,t){l.call(this,e,t),this.requestType="Reconciliation Sync",this.isInSyncCycle=!1}function f(e,t,r){u.call(this,e,t),this.requestType="Reconciliation Pull",this.isInSyncCycle=!1,this.pullPoint=r||new s.a,this.isForward=!1,this.completeFunction=function(e){return!e.bookmark.isEmpty()}}function g(e,t,r,s){u.call(this,e,t),this.requestType="Recovery Pull",this.isInSyncCycle=!1,this.pullPoint=r,this.isBookmarkedPull=!0,this.startPoint=r,this.stopPoint=s}function h(e,t,r,a,n,o,i){u.call(this,e,t),this.requestType="Restore Pull",this.isInSyncCycle=!0,this.pullPoint=r||new s.a,this.completeFunction=n,this.isBookmarkedPull=!1,this.isForward=!1,this.receiveFunction=a||null,this.resolve=o,this.reject=i}function y(e,t,r,s){this.name="SyncManager",this.contentClient=e,this.db=t,this.receiveFunction=r,this.errorFunction=s,this.trackedMailboxes=new Set,this.requestMap=new Map,this.requestId=0,this.syncDelay=i.syncDelay,this.requestsAwaitingRetry=new Set}Object.defineProperty(i,"maxMailboxesPerSync",{value:50,writable:!1}),Object.defineProperty(i,"initialBackoff",{value:5e3,writable:!1}),Object.defineProperty(i,"maxBackoff",{value:18e5,writable:!1}),Object.defineProperty(i,"userRetryInterval",{value:5e3}),Object.defineProperty(i,"syncDelay",{value:3e4,writable:!1}),Object.defineProperty(i,"staleThreshold",{value:216e5}),i.prototype.startReconnectSync=function(){var e=y.getPrivateData(this);if(0!==e.trackedMailboxes.size){Object(o.default)(o.default.INFO,"%s: Starting reconnect sync for %d mailbox(es)",e.name,e.trackedMailboxes.size);var t=++e.requestId,r=[];for(let c of e.trackedMailboxes){var s,n,d;r.length>=i.maxMailboxesPerSync&&(e.sendSync(t,r),r=[],t=++e.requestId);try{s=e.db.findBookmarkData(c)}catch(t){t instanceof a.NotFoundError?(Object(o.default)(o.default.NOTICE,"%s: Ignoring reconnect sync for m=%s; no bookmark data",e.name,c),e.trackedMailboxes.delete(c)):(Object(o.default)(o.default.ERROR,"%s: Ignoring reconnect sync for m=%s; error=%s",e.name,c,t),o.default.logErrorForDebugging(t));continue}s.bookmark.isEmpty()?(Object(o.default)(o.default.NOTICE,"%s: Missing bookmark for m=%s; most recent content will be pulled",e.name,c),n=new f(c,++e.requestId),d=function(){e.sendPull(n)}):(Object(o.default)(o.default.DEBUG1,"%s: Starting reconnect sync for m=%s",e.name,c),n=new l(c,t),d=function(){r.push({mailboxId:c,bookmark:s.bookmark,maxMessageId:s.maxMessageId})}),e.insert(n)&&d()}0!==r.length?e.sendSync(t,r):Object(o.default)(o.default.INFO,"%s: Not sending empty reconnect sync request",e.name)}else Object(o.default)(o.default.INFO,"%s: No mailboxes tracked; reconnect sync will not be started",e.name)},i.prototype.transportDisconnected=function(){var e=y.getPrivateData(this);Object(o.default)(o.default.INFO,"%s: Transport has disconnected; aborting %d requests",e.name,e.requestMap.size),e.requestMap.forEach(function(e){e.clearTimers(),e.reject&&e.reject(new a.TemporaryFailure("Connection disconnected"))}),e.requestMap.clear(),e.syncDelay=i.syncDelay},i.prototype.mailboxHasBeenLeft=function(e){var t=y.getPrivateData(this);if(e.startsWith("id."))Object(o.default)(o.default.TRACE,"%s: Refusing to abort requests for m=%s",t.name,e);else{t.trackedMailboxes.delete(e);var r=t.requestMap.get(e);if(void 0!==r){t.syncAbort(o.default.INFO,"Chat has been left",r,new a.PermanentFailure("Chat has been left"))}}},i.prototype.post=function(e,t,r){const s=y.getPrivateData(this),a=r&&!0===r.onlineOnly;return Object(o.default)(o.default.DEBUG1,"%s: Sending post for m=%s%s",s.name,e,a?" online only":""),s.contentClient.post(e,t,r).then(function(t){return Object(o.default)(o.default.DEBUG1,"%s: Received post response for m=%s with M=%s%s",s.name,e,t,a?" online only":""),!0!==a&&s.recordMessageId(e,t),t}).catch(function(t){throw Object(o.default)(o.default.ERROR,"%s: Failed to post to m=%s; error=%s",s.name,e,t),t})},i.prototype.reconcileFromPost=function(e,t){var r=y.getPrivateData(this);try{r.db.findBookmarkData(e)}catch(t){return Object(o.default)(o.default.ERROR,"%s: Cannot send reconciliation post for m=%s; error=%s",r.name,e,t),Promise.reject(t)}return Object(o.default)(o.default.INFO,"%s: Sending reconciliation post for m=%s",r.name,e),r.contentClient.post(e,t).then(function(t){try{return r.db.findBookmarkData(e).setBookmark(t),Object(o.default)(o.default.INFO,"%s: Using reconciliation post bookmark=%s for m=%s",r.name,t,e),r.recordMessageId(e,t,!0),t}catch(t){throw Object(o.default)(o.default.ERROR,"%s: Cannot set reconciliation post bookmark for m=%s; error=%s",r.name,e,t),t}}).catch(function(t){throw Object(o.default)(o.default.ERROR,"%s: Failed to send reconciliation post to m=%s; error=%s",r.name,e,t),t})},i.prototype.handleOnlineMessage=function(e){var t=y.getPrivateData(this);return e.messageData.onlineOnly||t.recordMessageId(e.mailboxId,e.messageData.messageId),t.receiveFunction(e)},i.prototype.restore=function(e,t,r,i){Object(n.default)(!t||t instanceof s.a,"Parameter 2 inconcistent with expectations"),Object(n.default)(!r||"function"==typeof r,"Parameter 3 inconcistent with expectations"),Object(n.default)(!i||"function"==typeof i,"Parameter 3 inconcistent with expectations");var d=y.getPrivateData(this);return d.trackedMailboxes.add(e),new Promise(function(s,c){try{d.db.findBookmarkData(e)}catch(t){return Object(o.default)(o.default.ERROR,"%s: Cannot restore content for m=%s; error=%s",d.name,e,t),void c(t)}var l,u;var p=new h(e,++d.requestId,t,r,function(e,t){return u=e,l=t,i&&i(t)},function(){if(s(),Object(n.default)(u,"last bookmark data must be set"),l&&u.bookmark.isEmpty()){var t=new f(e,++d.requestId,l);d.insert(t)?d.sendPull(t):Object(n.default)(!1,"unexpected request outstanding")}},c);if(!d.insert(p))return Object(o.default)(o.default.ERROR,"%s: Cannot initiate restore for m=%s; restore already ongoing",d.name,e),void c(new a.TemporaryFailure("Request outstanding"));d.sendPull(p)})},i.prototype.retrySingleRequest=function(){y.getPrivateData(this).retrySingleRequest()},c.prototype.addRef=function(){return++this.refCount,this},c.prototype.delRef=function(){return--this.refCount,!this.fired&&this.refCount<=0&&(clearTimeout(this.id),this.cancelledCallback()),null},c.assign=function(e,t){return e===t?e:null===t?(Object(n.default)(e instanceof c,"left must be a TimerData instance"),e.delRef()):null===e?(Object(n.default)(t instanceof c,"right must be a TimerData instance"),t.addRef()):(Object(n.default)(!1,"Unknown data types being assigned"),null)},d.prototype.clearTimers=function(){this.retryData=null,this.reconciliationData=null},l.prototype=Object.create(d.prototype),l.prototype.constructor=l,u.prototype=Object.create(d.prototype),u.prototype.constructor=u,p.prototype=Object.create(l.prototype),p.prototype.constructor=p,f.prototype=Object.create(u.prototype),f.prototype.constructor=f,g.prototype=Object.create(u.prototype),g.prototype.constructor=g,h.prototype=Object.create(u.prototype),h.prototype.constructor=h,y.isAccessAllowed=!1,y.getPrivateData=function(e){y.isAccessAllowed=!0;var t=e._private;return y.isAccessAllowed=!1,t},y.prototype.insert=function(e){var t=this.requestMap.get(e.mailboxId);if(void 0!==t){if(t.isInSyncCycle||!e.isInSyncCycle)return Object(o.default)(o.default.INFO,"%s: Not starting %s for m=%s while %s is outstanding",this.name,e.requestType,e.mailboxId,t.requestType),!1;Object(o.default)(o.default.NOTICE,"%s: Starting %s for m=%s; outstanding %s rId=%d will be ignored",this.name,e.requestType,e.mailboxId,t.requestType,t.requestId),t.clearTimers()}return this.requestMap.set(e.mailboxId,e),!0},y.prototype.sendSync=function(e,t,r){var s,a=this;Object(n.default)(0!==t.length),Object(o.default)(o.default.INFO,"%s: Sending sync request with rId=%d for %d mailbox(es)%s%s",a.name,e,t.length,...r?[" to reconcile m=",r]:["",""]),o.default.logThreshold>=o.default.DEBUG2&&Object(o.default)(o.default.DEBUG2,"%s: Sync request contains:",a.name,(s="",t.forEach(function(e){s+="\n  "+e.mailboxId+": b="+e.bookmark+" max="+(e.maxMessageId?e.maxMessageId:"")}),s)),a.contentClient.sync(t).then(function(t){a.handleSyncResults(e,t),a.retrySingleRequest()}).catch(function(t){o.default.logErrorForDebugging(t),a.handleSyncResults(e,null,t)}).catch(function(e){o.default.logErrorForDebugging(e)})},y.prototype.handleSyncResults=function(e,t,r){var i,d=this;if(Object(o.default)(o.default.INFO,"%s: Sync result for rId=%d contains %d mailbox(es)%s%s",d.name,e,t?Object.keys(t.mailboxes).length:0,...r?[" with error=",r]:["",""]),void 0!==r){var c=++d.requestId;return Object(o.default)(o.default.ERROR,"%s: Failed to send sync request rId=%d; error=%s; %s%d",d.name,e,r,"request will be retried with rId=",c),void d.scheduleRetry(e,c)}o.default.logThreshold>=o.default.DEBUG2&&Object(o.default)(o.default.DEBUG2,"%s: sync results\n  sb=%s%s",d.name,t.serverBookmark,(i="",Object.keys(t.mailboxes).forEach(function(e){var r=t.mailboxes[e];i+="\n  "+e+": p="+(r.nextPullPoint?r.nextPullPoint:"")+" g="+(r.gap?r.gap:"")+" ids="+(r.ids?r.ids:"")}),i));var l=t.serverBookmark;Object(n.default)(!l.isEmpty(),"Server bookmark must not be empty");var p,f=Object.keys(t.mailboxes),g=f.length,h=g;f.forEach(function(r){var i=t.mailboxes[r],c=d.requestMap.get(r);if(void 0!==c)if(!0===c.isSync&&c.requestId===e){var p;try{p=d.db.findBookmarkData(r)}catch(e){return void(e instanceof a.NotFoundError?d.syncAbort(o.default.NOTICE,"Ignoring pull response for unknown mailbox",c):d.syncAbort(o.default.ERROR,"Failed to load bookmark data",c,e))}if(i.error)return(i.error instanceof a.NotFound||i.error instanceof a.Forbidden)&&d.errorFunction(c.mailboxId,i.error),void d.syncAbort(o.default.ERROR,"Mailbox sync error",c,i.error);if(l.isLessThan(p.bookmark))d.regressBookmark(c,p,l);else{var f=i.nextPullPoint||new s.a;if(c.isInSyncCycle||f.isEmpty()||(Object(o.default)(o.default.NOTICE,"%s: Ignoring unexpected pullPoint=%s for m=%s in %s",d.name,f,r,c.requestType),f=new s.a),f.isEmpty()||!p.maxMessageId.isGreaterThan(f)){if(d.reconcileMessageIds(c,i,l,f,p),f.isEmpty())return d.syncComplete(c,p,l),void(p.isUpToDate()||(Object(n.default)(h>0,"mbxUptToDateCount must not be zero"),--h));Object(n.default)(h>0,"mbxUpToDateCount must not be zero"),--h;var g=new u(c.mailboxId,++d.requestId);g.pullPoint=f,g.startPoint=c.startPoint,g.stopPoint=c.stopPoint,g.isBookmarkedPull=p.isUpToDate()&&f.isLessThanOrEqual(l),Object(n.default)(g.pullPoint.isGreaterThan(p.bookmark),"Pulling content that has been reconciled"),d.requestMap.set(g.mailboxId,g),d.sendPull(g)}else d.syncAbort(o.default.ERROR,"Pull point="+f+"is at or before known max="+p.maxMessageId,c)}}else Object(o.default)(o.default.WARNING,"%s: Ignoring sync result for m=%s with rId=%d; %s rId=%d outstanding",d.name,r,e,c.requestType,c.requestId);else Object(o.default)(o.default.NOTICE,"%s: No outstanding sync request for m=%s; ignoring result",d.name,r)}),Object(n.default)((p=!1,d.requestMap.forEach(function(t){t.requestId===e&&(Object(o.default)(o.default.ERROR,"%s: Request rId=%d for mailboxId=%s not cleaned up",d.name,e,t.mailboxId),p=!0)}),!p),"Not all mailboxes synced in response"),Object(o.default)(o.default.INFO,"%s: Completed sync for rId=%d for %d mailbox(es); %d %s up-to-date; sb=%s",d.name,e,g,h,1===h?"is":"are",l)},y.prototype.sendPull=function(e){var t=this;Object(n.default)(!e.isSync,"Cannot send sync request as pull");var r=e.requestId,a=e.mailboxId;Object(o.default)(o.default.INFO,"%s: Sending %sbookmarked %s with rId=%d for m=%s from M=%s%s%s%s%s%s",t.name,e.isBookmarkedPull?"":"non-",e.requestType,r,a,e.pullPoint,...e.startPoint.isEmpty()&&e.stopPoint.isEmpty()?["","","","",""]:[" [",e.startPoint,", ",e.stopPoint,")"]),t.contentClient.pull(e.mailboxId,e.pullPoint,e instanceof g?e.stopPoint:new s.a,e.isForward).then(function(e){t.handlePullResults(r,a,e),t.retrySingleRequest()}).catch(function(e){o.default.logErrorForDebugging(e),t.handlePullResults(r,a,null,e)}).catch(function(e){o.default.logErrorForDebugging(e)})},y.prototype.handlePullResults=function(e,t,r,d){var c=this.requestMap.get(t);if(void 0!==c)if(Object(n.default)(t===c.mailboxId,"MailboxId mismatch; expected m={0}; got m={1}",t,c.mailboxId),!1===c.isSync&&c.requestId===e){if(void 0!==d){if(d instanceof a.TemporaryFailure){var l=++this.requestId;return Object(o.default)(o.default.ERROR,"%s: Failed to send %s rId=%d for m=%s; %s%d; error=%s",this.name,c.requestType,e,t,"request will be retried later with rId=",l,d),void this.scheduleRetry(e,l)}return(d instanceof a.NotFound||d instanceof a.Forbidden)&&this.errorFunction(c.mailboxId,d),void this.syncAbort(o.default.ERROR,"Reconciliation pull failed",c,d)}var u,p,f=r.nextPullPoint||new s.a;Object(o.default)(o.default.INFO,"%s: Received pull results rId=%d for m=%s with %d mesages(s)",this.name,e,t,r.messages.length),o.default.logThreshold>=o.default.DEBUG2&&Object(o.default)(o.default.DEBUG2,"%s: Pull results\n  sb=%s p=%s%s",this.name,r.serverBookmark,f,(u="",r.messages.forEach(function(e){u+="\n  "+e}),u));try{p=this.db.findBookmarkData(t)}catch(d){return void(d instanceof a.NotFoundError?this.syncAbort(o.default.NOTICE,"Ignoring pull response for unknown mailbox",c,d):this.syncAbort(o.default.ERROR,"Failed to load bookmark data",c,d))}Object(n.default)(0===r.messages.length||c.pullPoint.isEmpty()||r.messages[c.isForward?0:r.messages.length-1].messageId.isLessThanOrEqual(c.pullPoint),"Pull results inconsistent with expectations"),Object(n.default)(!(c instanceof g)||0===r.messages.length||c.stopPoint.isEmpty()||r.messages[r.messages.length-1].messageId.isLessThan(c.stopPoint),"Pull results inconsistent with expectaions"),Object(n.default)(!r.messages.some(function(e,t,r){return 0!==t&&!r[t-1].messageId.isLessThan(e.messageId)}),"Pull results inconsistent with expectations"),Object(n.default)(f.isEmpty()||c.pullPoint.isEmpty()||(c.isForward?f.isGreaterThan(c.pullPoint):f.isLessThan(c.pullPoint)),"Pull results inconsistent with expectations"),Object(n.default)(f.isEmpty()||0===r.messages.length||(c.isForward?r.messages[r.messages.length-1].messageId.isLessThan(f):r.messages[0].messageId.isGreaterThan(f)),"Pull results inconsistent with expectations");var h=r.serverBookmark;if(Object(n.default)(h&&!h.isEmpty(),"Pull results inconsistent with expectations"),h.isLessThan(p.bookmark))this.regressBookmark(c,p,h);else{c.isForward||(c.isBookmarkedPull=this.isReversePullBookmarked(t,p,r));var y=c.receiveFunction?c.receiveFunction:this.receiveFunction;if(r.messages.forEach(function(e){y({mailboxId:t,messageData:e}),p.recordMessageId(e.messageId),c.isBookmarkedPull&&e.messageId.isLessThanOrEqual(h)&&p.setBookmark(e.messageId)}),!(null!==c.completeFunction&&c.completeFunction(p,f.isEmpty()?void 0:f)||f.isEmpty()))return c.requestId=++this.requestId,c.pullPoint=f,c.retryBackoff=i.initialBackoff,c.isBookmarkedPull=c.isForward&&(c instanceof g||p.isUpToDate()&&c.pullPoint.isLessThanOrEqual(h)),void this.sendPull(c);c.isInSyncCycle||c.startPoint.isEmpty()||(p.bookmark.isLessThan(c.startPoint)&&(Object(o.default)(o.default.NOTICE,"%s: %s for messages[%s, %s) in m=%s failed to advance bookmark; %s",this.name,c.requestType,c.startPoint,c.stopPoint,t,"treating startPoint as reconciled"),p.setBookmark(c.startPoint)),c.startPoint=new s.a,c.stopPoint=new s.a),this.syncComplete(c,p,h)}}else Object(o.default)(o.default.NOTICE,"%s: Ignoring pull response for m=%s with rId=%d; %s rId=%s outstanding",this.name,t,e,c.requestType,c.requestId);else Object(o.default)(o.default.NOTICE,"%s: Ignoring pull response for m=%s with rId=%d with no request data",this.name,t,e)},y.prototype.isReversePullBookmarked=function(e,t,r){var a=r.serverBookmark;if(Object(n.default)(a&&!a.isEmpty(),"Pull results inconsistent with expectations"),!t.bookmark.isEmpty())return 0!==r.messages.length&&r.messages[r.messages.length-1].messageId.isGreaterThan(t.bookmark)&&r.messages[0].messageId.isLessThanOrEqual(t.bookmark);if(!t.canBeReconciled(a))return Object(o.default)(o.default.DEBUG2,"%s: Using sb=%s to begin reconciliation for m=%s",this.name,a,e),t.setBookmark(a,0===r.messages.length||r.messages[0].messageId.isGreaterThan(a)),!1;var i=r.messages.length>0&&r.messages[0].messageId.isLessThanOrEqual(a);if(i&&!t.canBeReconciled(r.messages[0].messageId))return Object(o.default)(o.default.DEBUG2,"%s: Using first M=%s to begin reconciliation for m=%s",this.name,r.messages[0].messageId,e),t.setBookmark(r.messages[0].messageId),!0;var d=r.nextPullPoint||new s.a;return d.isEmpty()||!d.isLessThanOrEqual(a)||t.canBeReconciled(d)?(Object(o.default)(o.default.DEBUG2,"%s: No bookmark position to begin reconciliation for m=%s",this.name,e),!1):(Object(o.default)(o.default.DEBUG2,"%s: Using nextPullPoint=%s to begin reconciliation for m=%s",this.name,d,e),t.setBookmark(d),i)},y.prototype.scheduleRetry=function(e,t){var r,s=this;for(let a of s.requestMap.values())a.requestId===e&&(void 0===r&&(Object(o.default)(o.default.DEBUG1,"%s: Scheduling retry for rId=%d to be after %d ms",s.name,t,a.retryBackoff),r=new c(function(){s.retryByRequestId(t,!0)},function(){Object(o.default)(o.default.DEBUG1,"%s: Cancelled retry for rId=%d",s.name,t),s.requestsAwaitingRetry.delete(t)},a.retryBackoff),s.requestsAwaitingRetry.add(t)),a.requestId=t,a.retryData=r);void 0===r?Object(o.default)(o.default.NOTICE,"%s: No outstanding request for rId=%d; retry not scheduled",s.name,e):Object(o.default)(o.default.DEBUG1,"%s: Scheduled retry for rId=%d for %d mailbox(es)",s.name,t,r.refCount)},y.prototype.retrySingleRequest=function(){this.requestsAwaitingRetry.size>0&&this.retryByRequestId(this.requestsAwaitingRetry[Symbol.iterator]().next().value)},y.prototype.retryByRequestId=function(e,t){var r,s,d,c;Object(o.default)(o.default.DEBUG1,"%s: Retrying rId=%d; fromTimer=%s",this.name,e,!0===t),this.requestsAwaitingRetry.delete(e);for(var l=[],u=0,p=this.requestMap.values(),f=p.next();!f.done;f=p.next()){var g=f.value;if(g.requestId===e){if(void 0===s&&(d=(s=g.retryData).refCount,c=g.requestType),Object(n.default)(g.requestType===c,"requestType mismatch"),g.clearTimers(),Object(n.default)(s.refCount<d,"bad ref count"),!0===t&&(r||(r=i.maxBackoff/2>=g.retryBackoff?2*g.retryBackoff:i.maxBackoff),g.retryBackoff=r),!g.isSync)return Object(o.default)(o.default.INFO,"%s: Retrying %s with rId=%d for m=%s",this.name,c,e,g.mailboxId),Object(n.default)(1===d&&0===l.length&&0===u,"Only one pull request should be retried at a time"),Object(n.default)(function(){for(f=p.next();!f.done;f=p.next())if(f.value.requestId===e)return!1;return!0}(),"Extra mailbox associated with pull requestId"),void this.sendPull(g);var h;try{h=this.db.findBookmarkData(g.mailboxId)}catch(e){++u,e instanceof a.NotFoundError?this.syncAbort(o.default.NOTICE,"Ignoring retry attempt for unknown mailbox",g,e):this.syncAbort(o.default.ERROR,"Failed to load bookmark data",g,e);continue}var y={mailboxId:g.mailboxId,bookmark:h.bookmark};g.isInSyncCycle&&(y.maxMessageId=h.maxMessageId),l.push(y)}}Object(n.default)(void 0!==d&&d>0,"Retry timer fired for non-existant request"),Object(n.default)(d===l.length+u,"Sync retry processed an unexpected number of mailboxes"),Object(n.default)(d>=u,"Sync retry fewer mailboxes than bookmark lookup failures"),0!==l.length?(Object(o.default)(o.default.INFO,"%s: Retrying %s with rId=%d for %d mailbox(es)",this.name,c,e,l.length),this.sendSync(e,l)):Object(o.default)(o.default.DEBUG1,"%s: Not retrying rId=%d; no mailboxes in %s",this.name,e,c)},y.prototype.advanceBookmark=function(e,t,r,s){if(Object(n.default)(t.bookmark.isLessThanOrEqual(r),"Bookmark is not advancing"),!t.bookmark.isGreaterThanOrEqual(r)){var a=t.isUpToDate()?r:t.maxMessageId.isLessThan(r)?t.maxMessageId:r,i=t.onlyFastForwarded&&!0===s&&!t.canBeReconciled(a);t.setBookmark(a,i),Object(o.default)(o.default.DEBUG1,"%s: Advanced bookmark for m=%s to b=%s%s; mailbox %s",this.name,e,t.bookmark,i?" ff-only":"",t.isUpToDate()?"is up-to-date":"needs reconciliation")}},y.prototype.reconcileMessageIds=function(e,t,r,s,a){var i=t.ids||[];if(Object(n.default)(!i.some(function(e,t,r){return 0!==t&&!r[t-1].isLessThan(e)}),"Sync results inconsistent with expectations"),0===i.length)return s.isEmpty()||s.isGreaterThan(r)?void this.advanceBookmark(e.mailboxId,a,r,!0):a.maxMessageId.isEmpty()?void Object(n.default)(a.onlyFastForwarded,"bookmark has not been only fast-forwarded"):void this.advanceBookmark(e.mailboxId,a,a.maxMessageId,!0);if(e.isInSyncCycle&&a.isUpToDate()&&!a.maxMessageId().isEmpty())Object(o.default)(o.default.NOTICE,"%s: Server sent ids for up-to-date m=%s b=%s max=%s; discarding: %s",this.name,e.mailboxId,a.bookmark,a.maxMessageId,i);else{if(Object(n.default)(i.length>0,"Server IDs must not be empty"),i[0].isLessThanOrEqual(a.bookmark)){var d=i.findIndex(function(e){return e.isGreaterThan(a.bookmark)});if(Object(o.default)(o.default.NOTICE,"%s: Discarding previously reconciled ids; b=%s for m=%s: %s",this.name,a.bookmark,e.mailboxId,i.splice(0,d<0?i.length:d)),0===i.length)return}var c=e.isInSyncCycle&&!a.maxMessageId.isEmpty()?r.isLessThan(a.maxMessageId)?r:a.maxMessageId:r;if(Object(n.default)(i.length>0,"Server IDs must not be empty"),i[i.length-1].isGreaterThan(c)){var l;for(l=i.length-1;l>0&&i[l-1].isGreaterThan(c);--l);if(Object(o.default)(o.default.NOTICE,"%s: Discarding ids after %s=%s for m=%s: %s",this.name,e.isInSyncCycle&&a.maxMessageId.isLessThanOrEqual(r)?"max":"sb",c,e.mailboxId,i.splice(l,i.length-l)),0===i.length)return}Object(n.default)(i.length>0,"Server IDs must not be empty");var u,p=i.findIndex(function(e){return!a.needsReconciliation(e)});if(-1===p){var f=i[i.length-1];return Object(o.default)(o.default.DEBUG1,"%s: Updating bookmark for m=%s to largest server M=%s",this.name,e.mailboxId,f),void this.advanceBookmark(e.mailboxId,a,f,!1)}for(e.startPoint=i[p],Object(o.default)(o.default.DEBUG2,"%s: Set recovery startPoint=%s",this.name,e.startPoint),u=i.length-1;u>=p&&a.needsReconciliation(i[u]);--u);if(Object(n.default)(-1!==u,"Missing message must be found"),Object(n.default)(u<=i.length-1),u<i.length-1)e.stopPoint=i[u+1],Object(o.default)(o.default.DEBUG2,"%s: Set recovery stop point to known messageId; stopPoint=%s",this.name,e.stopPoint);else{var g=i[u];s.isEmpty()||!g.isEqual(r)&&!s.isLessThanOrEqual(r)?g.isLessThan(r)?(e.stopPoint=r,Object(o.default)(o.default.DEBUG2,"%s: Set recovery stop point to server bookmark; stopPoint=%s",this.name,e.stopPoint)):Object(o.default)(o.default.DEBUG2,"%s: No recovery stop point has been set; stopPoint=%s",this.name,e.stopPoint):(e.stopPoint=s,Object(o.default)(o.default.DEBUG2,"%s: Set recovery stop point to pull point; stopPoint=%s",this.name,e.stopPoint))}if(Object(n.default)(!e.startPoint.isEmpty(),"startPoint must be set"),p>0){var h=i[p-1];return Object(o.default)(o.default.DEBUG1,"%s: Updating bookmark for m=%s to M=%s preceding first missing M=%s",this.name,e.mailboxId,h,e.stopPoint),void this.advanceBookmark(e.mailboxId,a,h,!1)}}},y.prototype.regressBookmark=function(e,t,r){t.setBookmark(r,!0);var s=e.isInSyncCycle,a=e.mailboxId;this.syncAbort(o.default.NOTICE,"Bookmark for mailbox has regressed; restarting cycle",e);var n={mailboxId:a,bookmark:t.bookmark};s?(e=new l(a,++this.requestId),n.maxMessageId=t.maxMessageId,a=void 0):e=new p(a,++this.requestId),this.requestMap.set(e.mailboxId,e),this.sendSync(e.requestId,[n],a)},y.prototype.recordMessageId=function(e,t,r){try{var s=this.db.findBookmarkData(e);if(this.trackedMailboxes.add(e),!s.recordMessageId(t)&&!r)return void Object(o.default)(o.default.WARNING,"%s: Received M=%s for m=%s that is a duplicate or before b=%s; %s",this.name,t,e,s.bookmark,"message will not be reconciled");var n,i=this.requestMap.get(e);return void 0!==i?void Object(o.default)(o.default.DEBUG1,"%s: Skipping reconciliation for m=%s; %s rId=%d outstanding",this.name,e,i.requestType,i.requestId):(s.bookmark.isEmpty()?(i=new f(e,++this.requestId),n=y.prototype.sendPull):(i=new p(e,++this.requestId),n=y.prototype.scheduleReconciliation),void(this.insert(i)&&n.call(this,i)))}catch(r){if(r instanceof a.NotFoundError)return void Object(o.default)(o.default.DEBUG1,"%s: Not recording M=%s for unknown m=%s; won't reconcile",this.name,t,e);Object(o.default)(o.default.WARNING,"%s: Not recording M=%s for m=%s; won't reconcile; error=%s",this.name,t,e,r),o.default.logErrorForDebugging(r)}},y.prototype.scheduleReconciliation=function(e){var t=this;Object(n.default)(void 0!==e,"RequestData must not be undefined"),Object(n.default)(null===e.reconciliationData,"RequestData must not have reconciliationTimer set");var r=e.mailboxId,s=e.requestId;Object(n.default)("string"==typeof r&&r.length>0,"mailboxId must be a non-empty string"),e.reconciliationData=new c(function(){t.reconcileBookmarkByMailboxId(r,s)},function(){Object(o.default)(o.default.DEBUG1,"%s: Cancelled reconcilation for m=%s for rId=%d",t.name,r,s)},t.syncDelay),Object(o.default)(o.default.DEBUG1,"%s: Scheduled reconciliation for m=%s for rId=%d",t.name,r,s)},y.prototype.reconcileBookmarkByMailboxId=function(e,t){Object(o.default)(o.default.DEBUG1,"%s: Reconciliation sync timer for m=%s with rId=%d has fired",this.name,e,t);var r=this.requestMap.get(e);if(void 0!==r&&r.requestId===t)if(Object(n.default)(null!==r.reconciliationData,"Reconciliation data was not set for m={0}",e),r.reconciliationData=null,!1===r.isInSyncCycle)try{this.sendReconcilationSync(e,this.db.findBookmarkData(e),r.requestId)}catch(e){this.syncAbort(o.default.ERROR,"Failed to load bookmark data",r,e)}else Object(o.default)(o.default.ERROR,"%s: Cannot send %s request for m=%s while a request is outstanding",this.name,r.requestType,e);else Object(o.default)(o.default.ERROR,"%s: Cannot send reconciliation request for m=%s with rId=%d; %s",this.name,e,t,r?"no request data":r.requestType+" with rId="+r.requestId+" outstanding")},y.prototype.sendReconcilationSync=function(e,t,r){Object(o.default)(o.default.DEBUG1,"%s: Starting reconciliation sync for m=%s rId=%d b=%s",this.name,e,r,t.bookmark);var s=[];s.push({mailboxId:e,bookmark:t.bookmark}),this.sendSync(r,s,e)},y.prototype.syncComplete=function(e,t,r){var s=!e.startPoint.isEmpty(),a=!t.isUpToDate();if(Object(o.default)(o.default.INFO,"%s: Completing %s for m=%s b=%s%s%s%s%s%s",this.name,e.requestType,e.mailboxId,t.bookmark,...s?[" and must recover [",e.startPoint,", ",e.stopPoint,")"]:a?[" and must reconcile","","","",""]:[" and is up-to-date","","","",""]),Object(n.default)(null===e.reconciliationData,"Reconciliation data still set"),Object(n.default)(null===e.retryData,"Retry data still set"),this.requestMap.delete(e.mailboxId),!e.resolve||(e.resolve(),!this.requestMap.has(e.mailboxId)))return s?(e=new g(e.mailboxId,++this.requestId,e.startPoint,e.stopPoint),this.requestMap.set(e.mailboxId,e),Object(o.default)(o.default.INFO,"%s: Starting pull for m=%s to recover messageIds [%s, %s)",this.name,e.mailboxId,e.startPoint,e.stopPoint),void this.sendPull(e)):a?(e=new p(e.mailboxId,++this.requestId),this.requestMap.set(e.mailboxId,e),void(t.canBeReconciled(r)?this.sendReconcilationSync(e.mailboxId,t,e.requestId):this.scheduleReconciliation(e))):void 0},y.prototype.syncAbort=function(e,t,r,s){Object(o.default)(e,"%s: Aborting %s request for m=%s: %s%s%s",this.name,r.requestType,r.mailboxId,t,...s?["; error=",s]:["",""]),o.default.logErrorForDebugging(s),r.clearTimers(),r.reject&&r.reject(s||new a.TemporaryFailure(t)),this.requestMap.delete(r.mailboxId)}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(11);const a=s.default.Method,n=s.default.Server.Kms;t.default=class{constructor(e,t,r,s){this.busClient=e,this.keysUrl=`/domains/${t}/user/keys`,this.userKeysUrl=`${this.keysUrl}/${r}`,this.setKeysUrl=`${this.userKeysUrl}?endpointId=${s}`,this.regId=r,this.domain=t}getAllKeys(){return this.busClient.request(this.userKeysUrl,this.busClient.requestOptions(a.GET,n))}getPublicKeys(e){return this.busClient.request(this.keysUrl+"/"+e,this.busClient.requestOptions(a.GET,n))}setProfileKeys(e,t,r,s,o){return this.busClient.request(this.setKeysUrl+"&replace=true",this.busClient.requestOptions(a.PUT,n),{public:{encrypt:e,sign:t},private:{encrypt:r,sign:s,manage:o}})}setMgmtKey(e){return this.busClient.request(this.setKeysUrl,this.busClient.requestOptions(a.PUT,n),{private:{manage:e}})}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(47),a=r(76);t.default={Immutable:s.a,SpliceWatcher:a.a}},function(e,t,r){"use strict";t.a=n;var s=r(13),a=r.n(s);function n(){a.a.apply(this);const e=e=>{const t=[];return t.splice=((r,s,...a)=>{const n=Array.prototype.splice.call(t,r,s,...a);this.emit(e,{storage:t,index:r,removed:n,added:a.length})}),t};this.allocate=function(t){return{storageArray:e(t),newMessage:e=>e,getMessage:e=>e,getMessages:e=>e}}}n.prototype=Object.create(a.a.prototype)}]);